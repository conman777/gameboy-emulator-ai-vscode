!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("jsgbc-core",[],e):"object"==typeof exports?exports["jsgbc-core"]=e():t["jsgbc-core"]=e()}("undefined"!=typeof self?self:this,(function(){return(()=>{"use strict";var t={m:{},n:e=>{var i=e&&e.__esModule?()=>e.default:()=>e;return t.d(i,{a:i}),i},d:(e,i)=>{for(var r in i)t.o(i,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:i[r]})},u:t=>t+".js",o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},p:"/"};t.b=document.baseURI||self.location.href;var e={};t.r(e),t.d(e,{GameBoy:()=>mt,LocalStorage:()=>st,MemoryStorage:()=>ht,Storage:()=>rt,default:()=>ct,util:()=>i});var i={};t.r(i),t.d(i,{concatArrayBuffers:()=>g,debounce:()=>d,fetchFileAsArrayBuffer:()=>c,fromTypedArray:()=>o,getTypedArray:()=>n,hasExtension:()=>b,readBlob:()=>l,readFirstMatchingExtension:()=>u,saveAs:()=>y,stringToArrayBuffer:()=>m,toTypedArray:()=>a});const r=require("jszip");var s=t.n(r);const h=require("file-saver");function a(t,e){try{if(!(t&&t.length<1))return[];var i=t.length;let s;switch(e){case"uint8":s=new Uint8Array(i);break;case"int8":s=new Int8Array(i);break;case"int32":s=new Int32Array(i);break;case"float32":s=new Float32Array(i)}for(var r=0;r<i;r++)s[r]=t[r];return s}catch(e){return console.log("Could not convert an array to a typed array: "+e.message,1),t}}function o(t){try{if(!t||!t.length)return[];for(var e=[],i=0;i<t.length;++i)e[i]=t[i];return e}catch(e){return console.log("Conversion from a typed array failed: "+e.message,1),t}}function n(t,e,i){let r;switch(i){case"int8":r=new Int8Array(t);break;case"uint8":r=new Uint8Array(t);break;case"int32":r=new Int32Array(t);break;case"float32":r=new Float32Array(t)}if(0!==e){let i=0;for(;i<t;)r[i++]=e}return r}function m(t){const e=new Uint8Array(t.length);for(let i=0,r=t.length;i<r;i++)e[i]=t.charCodeAt(i);return e}async function c(t){const e=await fetch(t);return await e.arrayBuffer()}function g(...t){let e=0;for(let i=0;i<t.length;i++)e+=t[i].byteLength;const i=new Uint8Array(e);for(let e=0;e<t.length;e++){const r=new Uint8Array(t[e]);0===e?i.set(r):i.set(r,t[e-1].byteLength)}return i.buffer}function y(t,e){t instanceof ArrayBuffer&&(t=new Uint8Array(t)),t instanceof Uint8Array&&(t=new Blob([t],{type:"application/octet-binary"})),h.saveAs(t,e)}async function l(t){return new Promise(((e,i)=>{if(t){const i=new FileReader;i.addEventListener("load",(function(){2===this.readyState&&e(this.result)})),i.readAsArrayBuffer(t)}else i()}))}async function u(t,e="",i){let r=await l(t);if(!i.includes("zip")&&b(e,"zip")){const t=await s().loadAsync(r),e=Object.keys(t.files).filter((t=>i.find((e=>b(t,e)))));r=e.length>0?await t.file(e[0]).async("arraybuffer"):void 0}return r}function b(t,e){return t=t.toLowerCase(),e="."+e.toLowerCase(),t.lastIndexOf(e)===t.length-e.length}function d(t,e){var i,r,s,h,a;function o(){var n=Date.now()-h;n<e&&n>=0?i=setTimeout(o,e-n):(i=null,a=t.apply(s,r),s=r=null)}var n=function(){return s=this,r=arguments,h=Date.now(),i||(i=setTimeout(o,e)),a};return n.clear=function(){i&&(clearTimeout(i),i=null)},n.flush=function(){i&&(a=t.apply(s,r),s=r=null,clearTimeout(i),i=null)},n}const f=[!0,!0,!0,!0];class C{constructor(){this.speed=1,this.ticks=0,this.cyclesTotal=0,this.cyclesTotalBase=0,this.cyclesTotalCurrent=0,this.cyclesTotalRoundoff=0,this.baseCyclesPerIteration=0,this.totalLinesPassed=0,this.stopped=!1,this.calculateTimings()}calculateTimings(){this.clocksPerSecond=4194304*this.speed,this.baseCyclesPerIteration=this.clocksPerSecond/1e3*8,this.cyclesTotalRoundoff=this.baseCyclesPerIteration%4,this.cyclesTotalBase=this.cyclesTotal=this.baseCyclesPerIteration-this.cyclesTotalRoundoff|0,this.cyclesTotalCurrent=0}setSpeed(t){this.speed=t,this.calculateTimings()}}class p{constructor(t){t instanceof Uint8Array?this.data=t:this.data=new Uint8Array(t)}getByte(t){return this.data[t]}getChar(t){return String.fromCharCode(this.getByte(t))}getString(t,e){let i="";for(let r=t;r<=e;r++)i+=this.getChar(r);return i}get length(){return this.data.byteLength}}class B{constructor(t,{canvas:e,context:i,offscreenCanvas:r,offscreenContext:s,width:h,height:a}){if(this.gameboy=t,this.canvas=e,this.context=i,this.offscreenCanvas=r,this.offscreenContext=s,this.gameboy=t,this.offscreenWidth=160,this.offscreenHeight=144,this.offscreenRgbCount=this.offscreenWidth*this.offscreenHeight*3,this.offscreenRgbaCount=this.offscreenWidth*this.offscreenHeight*4,this.width=h||this.offscreenWidth,this.height=a||this.offscreenHeight,"undefined"!=typeof document&&(this.canvas||(this.canvas=document.createElement("canvas")),this.offscreenCanvas||(this.offscreenCanvas=document.createElement("canvas"))),this.canvas&&(this.canvas.height=this.height,this.canvas.width=this.width,this.context||(this.context=this.canvas.getContext("2d"))),this.offscreenCanvas&&(this.offscreenCanvas.height=this.offscreenHeight,this.offscreenCanvas.width=this.offscreenWidth,this.offscreenContext||(this.offscreenContext=this.offscreenCanvas.getContext("2d"))),!this.context)throw new Error("please provide a canvas context in the lcd options");if(!this.offscreenContext)throw new Error("please provide a canvas offscreen context in the lcd options")}init(){this.offscreenContext.msImageSmoothingEnabled=!1,this.offscreenContext.mozImageSmoothingEnabled=!1,this.offscreenContext.webkitImageSmoothingEnabled=!1,this.offscreenContext.imageSmoothingEnabled=!1,this.context.msImageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.imageSmoothingEnabled=!1,this.canvasBuffer=this.offscreenContext.createImageData(this.offscreenWidth,this.offscreenHeight),this.swizzledFrame=n(this.offscreenRgbCount,255,"uint8");let t=this.offscreenRgbaCount;for(;t>0;)t-=4,this.canvasBuffer.data[t]=248,this.canvasBuffer.data[t+1]=248,this.canvasBuffer.data[t+2]=248,this.canvasBuffer.data[t+3]=255;this.newFrameAvailable=!0,this.draw()}drawToCanvas(){this.offscreenWidth===this.width&&this.offscreenHeight===this.height?this.context.putImageData(this.canvasBuffer,0,0):(this.offscreenContext.putImageData(this.canvasBuffer,0,0),this.context.drawImage(this.offscreenCanvas,0,0,this.width,this.height))}draw(){if(!this.newFrameAvailable||92160!==this.offscreenRgbaCount)return;const t=this.canvasBuffer.data;let e=0,i=0;for(;i<this.offscreenRgbaCount;)t[i++]=this.swizzledFrame[e++],t[i++]=this.swizzledFrame[e++],t[i++]=this.swizzledFrame[e++],++i;this.drawToCanvas(),this.newFrameAvailable=!1}outputFrameBuffer(){const t=this.gameboy.frameBuffer,e=this.swizzledFrame;let i=0,r=0;for(;r<this.offscreenRgbCount;)e[r++]=t[i]>>16&255,e[r++]=t[i]>>8&255,e[r++]=255&t[i],++i;this.newFrameAvailable=!0}turnOff(){0===this.drewBlank&&(this.clearFrameBuffer(),this.newFrameAvailable=!0),this.drewBlank=2}clearFrameBuffer(){const t=this.swizzledFrame;let e=0;if(this.gameboy.cartridge.useGbcMode||this.colorizedGbPalettes)for(;e<this.offscreenRgbCount;)t[e++]=248;else for(;e<this.offscreenRgbCount;)t[e++]=239,t[e++]=255,t[e++]=222}}const F=40960,S=49151,k=65280,R=65281,M=65282,H=65284,L=65287,w=65360;class T{constructor(t){this.gameboy=t,this.value=255,this.writeMemory=(t,e)=>{const i=48&e,r=0==(16&e),s=15&this.value,h=0==(32&e),a=this.value>>4&15;this.gameboy.memory[t]=i+((h?a:15)&(r?s:15))},this.readMemory=()=>192|this.gameboy.memoryNew.readDirectly(k)}init(){this.gameboy.memory[65280]=15}down(t){this.value&=255^1<<t,!this.gameboy.cartridge||this.gameboy.cartridge.useGbcMode||this.gameboy.usedBootRom&&this.gameboy.usedGbcBootRom||(this.gameboy.interruptRequestedFlags|=16,this.gameboy.remainingClocks=0,this.gameboy.checkIrqMatching()),this.writeMemory(k,this.gameboy.memory[65280]),this.gameboy.cpu.stopped=!1}up(t){this.value|=1<<t,this.writeMemory(k,this.gameboy.memory[65280]),this.gameboy.cpu.stopped=!1}}const A=require("events");class P extends A.EventEmitter{constructor(){super(...arguments),this.map={}}register(t){return this.map[t]=!0,this}getAll(){return Object.keys(this.map)}is(t){return!!this.map[t]}down(t,e){this.emit("Down"+t,e)}change(t,e){this.emit("Change"+t,e)}up(t,e){this.emit("Up"+t,e)}}const v=[4,12,8,8,4,4,8,4,20,8,8,8,4,4,8,4,4,12,8,8,4,4,8,4,12,8,8,8,4,4,8,4,8,12,8,8,4,4,8,4,8,8,8,8,4,4,8,4,8,12,8,8,12,12,12,4,8,8,8,8,4,4,8,4,4,4,4,4,4,4,8,4,4,4,4,4,4,4,8,4,4,4,4,4,4,4,8,4,4,4,4,4,4,4,8,4,4,4,4,4,4,4,8,4,4,4,4,4,4,4,8,4,8,8,8,8,8,8,4,8,4,4,4,4,4,4,8,4,4,4,4,4,4,4,8,4,4,4,4,4,4,4,8,4,4,4,4,4,4,4,8,4,4,4,4,4,4,4,8,4,4,4,4,4,4,4,8,4,4,4,4,4,4,4,8,4,4,4,4,4,4,4,8,4,4,4,4,4,4,4,8,4,8,12,12,16,12,16,8,16,8,16,12,0,12,24,8,16,8,12,12,4,12,16,8,16,8,16,12,4,12,4,8,16,12,12,8,4,4,16,8,16,16,4,16,4,4,4,8,16,12,12,8,4,4,16,8,16,12,8,16,4,0,4,8,16];class W{constructor(t,e=new Uint8Array(65536)){this.gameboy=t,this.data=e,this.readers=[],this.highReaders=[],this.writers=[],this.highWriters=[],this.writeIllegal=(t,e)=>{},this.readBad=t=>255,this.readDirectly=t=>this.data[t]}read(t){const e=this.readers[t];if(!e)throw new Error("no_reader");return e(t)}readHigh(t){t&=255;const e=this.highReaders[t];if(!e)throw new Error("no_high_reader");return e(65280|t)}hasReader(t){return!!this.readers[t]}hasHighReader(t){return t&=255,!!this.highReaders[t]}setReaders(t,e,i){for(let r=t;r<=e;r++)this.setReader(r,i)}setReader(t,e){this.readers[t]=e}setHighReaders(t,e,i){for(let r=t;r<=e;r++)this.setHighReader(r,i)}setHighReader(t,e){t&=255,this.highReaders[t]=e}write(t,e){const i=this.writers[t];if(!i)throw new Error("no_writer");return i(t,e)}writeHigh(t,e){t&=255;const i=this.highWriters[t];if(!i)throw new Error("no_high_writer");return i(65280|t,e)}hasWriter(t){return!!this.writers[t]}hasHighWriter(t){return t&=255,!!this.highWriters[t]}setWriters(t,e,i){for(let r=t;r<=e;r++)this.setWriter(r,i)}setWriter(t,e){this.writers[t]=e}setHighWriter(t,e){t&=255,this.highWriters[t]=e}init(){this.setReaders(0,16383,(t=>this.data[t])),this.setReaders(16384,32767,(t=>this.gameboy.cartridge.rom.getByte((this.gameboy.cartridge?.mbc?.currentRomBank||0)+t))),this.setReaders(32768,38911,this.gameboy.cartridge.useGbcMode?this.gameboy.readGbcVideoRam:this.gameboy.readVideoRam),this.setReaders(F,S,this.gameboy.cartridge.useGbcMode?this.gameboy.readGbcCharacterVideoRam:this.gameboy.readCharacterVideoRam),0===this.gameboy.cartridge?.mbc?.ramSize?this.setReaders(F,S,this.readBad):(this.gameboy.cartridge.hasMbc7||this.gameboy.cartridge.hasMbc3,this.setReaders(F,S,this.gameboy.cartridge.mbc?.readRam||this.readBad)),this.setReaders(49152,53247,this.readDirectly),this.gameboy.cartridge?.useGbcMode?this.setReaders(53248,57343,this.gameboy.memoryReadGBCMemory):this.setReaders(53248,57343,this.readDirectly),this.setReaders(57344,61439,this.gameboy.readEchoRam),this.gameboy.cartridge?.useGbcMode?this.setReaders(61440,65023,this.gameboy.readGbcEchoRam):this.setReaders(61440,65023,this.gameboy.readEchoRam),this.setReaders(65024,65183,this.gameboy.memoryReadOAM),this.gameboy.cartridge?.useGbcMode&&this.setReaders(65184,65279,this.readDirectly),this.setWriter(k,this.gameboy.joypad.writeMemory),this.setHighWriter(k,this.gameboy.joypad.writeMemory),this.setReader(k,this.gameboy.joypad.readMemory),this.setHighReader(k,this.gameboy.joypad.readMemory);const t=()=>this.readDirectly(M)<128?this.readDirectly(R):255;this.setReader(R,t),this.setHighReader(R,t);const e=this.gameboy.cartridge.useGbcMode?()=>(this.gameboy.serialTimer<=0?124:252)|this.readDirectly(M):()=>(this.gameboy.serialTimer<=0?126:254)|this.readDirectly(M);this.setReader(M,e),this.setHighReader(M,e),this.setReader(65283,this.readBad),this.setHighReader(65283,this.readBad);const i=()=>(this.gameboy.memory[65284]=this.readDirectly(H)+(this.gameboy.DIVTicks>>8)&255,this.gameboy.DIVTicks&=255,this.readDirectly(H));this.setReader(H,i),this.setHighReader(H,i),this.setReader(65285,this.readDirectly),this.setHighReader(65285,this.gameboy.memoryHighReadNormal),this.setReader(65286,this.readDirectly),this.setHighReader(65286,this.gameboy.memoryHighReadNormal);const r=()=>248|this.readDirectly(L);this.setReader(L,r),this.setHighReader(L,r),this.setReaders(65288,65294,this.readBad),this.setHighReaders(65288,65294,this.readBad);const s=()=>224|this.gameboy.interruptRequestedFlags;this.setReader(65295,s),this.setHighReader(65295,s),this.memoryReadJumpCompile(),this.memoryWriteJumpCompile()}updateIoRegisters(){if(this.gameboy.isBootingRom){if(this.enableBootRomControl(),this.gameboy.cartridge.useGbcMode){const t=(t,e)=>{e&=1,this.gameboy.isBootingRom&&this.gameboy.cartridge.setGbcMode(e),this.data[65388]=e};this.setWriter(65388,t),this.setHighWriter(65388,t)}}else this.disableBootRomControl()}enableBootRomControl(){const t=(t,e)=>{console.log("Bootstrap process has ended"),this.gameboy.isBootingRom=!1,this.gameboy.disableBootRom(),this.data[65360]=e};this.setWriter(w,t),this.setHighWriter(w,t)}disableBootRomControl(){this.setWriter(w,this.writeIllegal),this.setHighWriter(w,this.writeIllegal)}memoryReadJumpCompile(){for(let t=0;t<=65535;t++)if(t>=65280)switch(t){case 65296:this.gameboy.highMemoryReader[16]=this.gameboy.memoryReader[65296]=t=>128|this.gameboy.memory[65296];break;case 65297:this.gameboy.highMemoryReader[17]=this.gameboy.memoryReader[65297]=t=>63|this.gameboy.memory[65297];break;case 65298:this.gameboy.highMemoryReader[18]=this.gameboy.memoryHighReadNormal,this.gameboy.memoryReader[65298]=this.readDirectly;break;case 65299:this.gameboy.highMemoryReader[19]=this.gameboy.memoryReader[65299]=this.readBad;break;case 65300:this.gameboy.highMemoryReader[20]=this.gameboy.memoryReader[65300]=t=>191|this.gameboy.memory[65300];break;case 65301:this.gameboy.highMemoryReader[21]=this.readBad,this.gameboy.memoryReader[65301]=this.readBad;break;case 65302:this.gameboy.highMemoryReader[22]=this.gameboy.memoryReader[65302]=t=>63|this.gameboy.memory[65302];break;case 65303:this.gameboy.highMemoryReader[23]=this.gameboy.memoryHighReadNormal,this.gameboy.memoryReader[65303]=this.readDirectly;break;case 65304:this.gameboy.highMemoryReader[24]=this.gameboy.memoryReader[65304]=this.readBad;break;case 65305:this.gameboy.highMemoryReader[25]=this.gameboy.memoryReader[65305]=t=>191|this.gameboy.memory[65305];break;case 65306:this.gameboy.highMemoryReader[26]=this.gameboy.memoryReader[65306]=t=>127|this.gameboy.memory[65306];break;case 65307:this.gameboy.highMemoryReader[27]=this.gameboy.memoryReader[65307]=this.readBad;break;case 65308:this.gameboy.highMemoryReader[28]=this.gameboy.memoryReader[65308]=t=>159|this.gameboy.memory[65308];break;case 65309:this.gameboy.highMemoryReader[29]=this.gameboy.memoryReader[65309]=this.readBad;break;case 65310:this.gameboy.highMemoryReader[30]=this.gameboy.memoryReader[65310]=t=>191|this.gameboy.memory[65310];break;case 65311:case 65312:this.gameboy.highMemoryReader[255&t]=this.gameboy.memoryReader[t]=this.readBad;break;case 65313:case 65314:this.gameboy.highMemoryReader[255&t]=this.gameboy.memoryHighReadNormal,this.gameboy.memoryReader[t]=this.readDirectly;break;case 65315:this.gameboy.highMemoryReader[35]=this.gameboy.memoryReader[65315]=t=>191|this.gameboy.memory[65315];break;case 65316:case 65317:this.gameboy.highMemoryReader[255&t]=this.gameboy.memoryHighReadNormal,this.gameboy.memoryReader[t]=this.readDirectly;break;case 65318:this.gameboy.highMemoryReader[38]=this.gameboy.memoryReader[65318]=t=>(this.gameboy.audioController.run(),112|this.gameboy.memory[65318]);break;case 65319:case 65320:case 65321:case 65322:case 65323:case 65324:case 65325:case 65326:case 65327:this.gameboy.highMemoryReader[255&t]=this.gameboy.memoryReader[t]=this.readBad;break;case 65328:case 65329:case 65330:case 65331:case 65332:case 65333:case 65334:case 65335:case 65336:case 65337:case 65338:case 65339:case 65340:case 65341:case 65342:case 65343:this.gameboy.memoryReader[t]=t=>this.gameboy.audioController.channel3CanPlay?this.gameboy.memory[65280|this.gameboy.audioController.channel3LastSampleLookup>>1]:this.gameboy.memory[t],this.gameboy.highMemoryReader[255&t]=t=>this.gameboy.audioController.channel3CanPlay?this.gameboy.memory[65280|this.gameboy.audioController.channel3LastSampleLookup>>1]:this.gameboy.memory[65280|t];break;case 65344:this.gameboy.highMemoryReader[64]=this.gameboy.memoryHighReadNormal,this.gameboy.memoryReader[65344]=this.readDirectly;break;case 65345:this.gameboy.highMemoryReader[65]=this.gameboy.memoryReader[65345]=t=>128|this.gameboy.memory[65345]|this.gameboy.modeSTAT;break;case 65346:this.gameboy.highMemoryReader[66]=this.gameboy.memoryReader[65346]=t=>this.gameboy.backgroundY;break;case 65347:this.gameboy.highMemoryReader[67]=this.gameboy.memoryReader[65347]=t=>this.gameboy.backgroundX;break;case 65348:this.gameboy.highMemoryReader[68]=this.gameboy.memoryReader[65348]=t=>this.gameboy.gpu.lcdEnabled?this.gameboy.memory[65348]:0;break;case 65349:case 65350:case 65351:case 65352:case 65353:this.gameboy.highMemoryReader[255&t]=this.gameboy.memoryHighReadNormal,this.gameboy.memoryReader[t]=this.readDirectly;break;case 65354:this.gameboy.highMemoryReader[74]=this.gameboy.memoryReader[65354]=t=>this.gameboy.windowY;break;case 65355:this.gameboy.highMemoryReader[75]=this.gameboy.memoryHighReadNormal,this.gameboy.memoryReader[65355]=this.readDirectly;break;case 65356:this.gameboy.highMemoryReader[76]=this.gameboy.memoryReader[65356]=this.readBad;break;case 65357:this.gameboy.highMemoryReader[77]=this.gameboy.memoryHighReadNormal,this.gameboy.memoryReader[65357]=this.readDirectly;break;case 65358:this.gameboy.highMemoryReader[78]=this.gameboy.memoryReader[65358]=this.readBad;break;case 65359:this.gameboy.highMemoryReader[79]=this.gameboy.memoryReader[65359]=t=>this.gameboy.currentVideoRamBank;break;case w:case 65361:case 65362:case 65363:case 65364:this.gameboy.highMemoryReader[255&t]=this.gameboy.memoryHighReadNormal,this.gameboy.memoryReader[t]=this.readDirectly;break;case 65365:this.gameboy.cartridge.useGbcMode?this.gameboy.highMemoryReader[85]=this.gameboy.memoryReader[65365]=t=>(!this.gameboy.gpu.lcdEnabled&&this.gameboy.hdmaRunning&&(this.gameboy.writeDirectlyToMemory(1+(127&this.gameboy.memory[65365])),this.gameboy.memory[65365]=255,this.gameboy.hdmaRunning=!1),this.gameboy.memory[65365]):(this.gameboy.memoryReader[65365]=this.readDirectly,this.gameboy.highMemoryReader[85]=this.gameboy.memoryHighReadNormal);break;case 65366:this.gameboy.cartridge.useGbcMode?this.gameboy.highMemoryReader[86]=this.gameboy.memoryReader[65366]=t=>60|(this.gameboy.memory[65366]>=192?2|193&this.gameboy.memory[65366]:195&this.gameboy.memory[65366]):(this.gameboy.memoryReader[65366]=this.readDirectly,this.gameboy.highMemoryReader[86]=this.gameboy.memoryHighReadNormal);break;case 65367:case 65368:case 65369:case 65370:case 65371:case 65372:case 65373:case 65374:case 65375:case 65376:case 65377:case 65378:case 65379:case 65380:case 65381:case 65382:case 65383:this.gameboy.highMemoryReader[255&t]=this.gameboy.memoryReader[t]=this.readBad;break;case 65384:case 65385:case 65386:case 65387:this.gameboy.highMemoryReader[255&t]=this.gameboy.memoryHighReadNormal,this.gameboy.memoryReader[t]=this.readDirectly;break;case 65388:this.gameboy.cartridge.useGbcMode?this.gameboy.highMemoryReader[108]=this.gameboy.memoryReader[65388]=t=>254|this.gameboy.memory[65388]:this.gameboy.highMemoryReader[108]=this.gameboy.memoryReader[65388]=this.readBad;break;case 65389:case 65390:case 65391:this.gameboy.highMemoryReader[255&t]=this.gameboy.memoryReader[t]=this.readBad;break;case 65392:this.gameboy.cartridge.useGbcMode?this.gameboy.highMemoryReader[112]=this.gameboy.memoryReader[65392]=t=>64|this.gameboy.memory[65392]:this.gameboy.highMemoryReader[112]=this.gameboy.memoryReader[65392]=this.readBad;break;case 65393:this.gameboy.highMemoryReader[113]=this.gameboy.memoryReader[65393]=this.readBad;break;case 65394:case 65395:this.gameboy.highMemoryReader[255&t]=this.gameboy.memoryReader[t]=this.readDirectly;break;case 65396:this.gameboy.cartridge.useGbcMode?this.gameboy.highMemoryReader[116]=this.gameboy.memoryReader[65396]=this.readDirectly:this.gameboy.highMemoryReader[116]=this.gameboy.memoryReader[65396]=this.readBad;break;case 65397:this.gameboy.highMemoryReader[117]=this.gameboy.memoryReader[65397]=t=>143|this.gameboy.memory[65397];break;case 65398:this.gameboy.highMemoryReader[118]=this.gameboy.memoryReader[65398]=t=>(this.gameboy.audioController.run(),this.gameboy.audioController.channel2.envelopeVolume<<4|this.gameboy.audioController.channel1.envelopeVolume);break;case 65399:this.gameboy.highMemoryReader[119]=this.gameboy.memoryReader[65399]=t=>(this.gameboy.audioController.run(),this.gameboy.audioController.channel4EnvelopeVolume<<4|this.gameboy.audioController.channel3envelopeVolume);break;case 65400:case 65401:case 65402:case 65403:case 65404:case 65405:case 65406:case 65407:this.gameboy.highMemoryReader[255&t]=this.gameboy.memoryReader[t]=this.readBad;break;case 65535:this.gameboy.highMemoryReader[255]=this.gameboy.memoryReader[65535]=t=>this.gameboy.interruptEnabledFlags;break;default:this.gameboy.memoryReader[t]=this.readDirectly,this.gameboy.highMemoryReader[255&t]=this.gameboy.memoryHighReadNormal}else this.gameboy.memoryReader[t]=this.readBad}memoryWriteJumpCompile(){for(let t=0;t<=65535;t++)t<=32767?this.gameboy.cartridge.hasMbc1?this.gameboy.memoryWriter[t]=t<8192?this.gameboy.cartridge.mbc.toggle:t<16384?this.gameboy.cartridge.mbc1.writeRomBank:t<24576?this.gameboy.cartridge.mbc1.writeRamBank:this.gameboy.cartridge.mbc1.writeType:this.gameboy.cartridge.hasMbc2?this.gameboy.memoryWriter[t]=t<4096?this.gameboy.cartridge.mbc.toggle:t>=8448&&t<8704?this.gameboy.cartridge.mbc2.writeRomBank:this.writeIllegal:this.gameboy.cartridge.hasMbc3?this.gameboy.memoryWriter[t]=t<8192?this.gameboy.cartridge.mbc.toggle:t<16384?this.gameboy.cartridge.mbc3.writeRomBank:t<24576?this.gameboy.cartridge.mbc3.writeRamBank:this.gameboy.cartridge.mbc3.rtc.writeLatch:this.gameboy.cartridge.hasMbc5||this.gameboy.cartridge.hasMbc7||this.gameboy.cartridge.hasRumble?this.gameboy.memoryWriter[t]=t<8192?this.gameboy.cartridge.mbc.toggle:t<12288?this.gameboy.cartridge.mbc5.writRomBank:t<16384?this.gameboy.cartridge.mbc5.writeHighRomBank:t<24576?this.gameboy.cartridge.hasRumble?this.gameboy.cartridge.rumble.writeRamBank:this.gameboy.cartridge.mbc5.writeRamBank:this.writeIllegal:this.gameboy.cartridge.hasHuc3?this.gameboy.memoryWriter[t]=t<8192?this.gameboy.cartridge.mbc.toggle:t<16384?this.gameboy.cartridge.mbc3.writeRomBank:t<24576?this.gameboy.cartridge.mbc3.writeHuc3RamBank:this.writeIllegal:this.gameboy.memoryWriter[t]=this.writeIllegal:t<=36863?this.gameboy.memoryWriter[t]=this.gameboy.cartridge.useGbcMode?this.gameboy.VRAMGBCDATAWrite:this.gameboy.VRAMGBDATAWrite:t<38912?this.gameboy.memoryWriter[t]=this.gameboy.cartridge.useGbcMode?this.gameboy.VRAMGBCDATAWrite:this.gameboy.VRAMGBDATAUpperWrite:t<40960?this.gameboy.memoryWriter[t]=this.gameboy.cartridge.useGbcMode?this.gameboy.VRAMGBCCHRMAPWrite:this.gameboy.VRAMGBCHRMAPWrite:t<49152?this.gameboy.cartridge?.mbc?.ramSize>0?this.gameboy.memoryWriter[t]=this.gameboy.cartridge.mbc.writeRam:this.gameboy.memoryWriter[t]=this.writeIllegal:t<57344?this.gameboy.cartridge.useGbcMode&&t>=53248?this.gameboy.memoryWriter[t]=this.gameboy.memoryWriteGBCRAM:this.gameboy.memoryWriter[t]=this.gameboy.memoryWriteNormal:t<65024?this.gameboy.cartridge.useGbcMode&&t>=61440?this.gameboy.memoryWriter[t]=this.gameboy.memoryWriteECHOGBCRAM:this.gameboy.memoryWriter[t]=this.gameboy.memoryWriteECHONormal:t<=65184?this.gameboy.memoryWriter[t]=this.gameboy.memoryWriteOAMRAM:t<65280?this.gameboy.cartridge.useGbcMode?this.gameboy.memoryWriter[t]=this.gameboy.memoryWriteNormal:this.gameboy.memoryWriter[t]=this.writeIllegal:(this.gameboy.memoryWriter[t]=this.gameboy.memoryWriteNormal,this.gameboy.highMemoryWriter[255&t]=this.gameboy.memoryHighWriteNormal);this.registerIOMemoryWriters()}registerIOMemoryWriters(){this.gameboy.highMemoryWriter[1]=this.gameboy.memoryWriter[65281]=(t,e)=>{this.gameboy.memory[65282]<128&&(this.gameboy.memory[65281]=e)},this.gameboy.highMemoryWriter[2]=this.gameboy.memoryHighWriteNormal,this.gameboy.memoryWriter[65282]=this.gameboy.memoryWriteNormal,this.gameboy.highMemoryWriter[3]=this.gameboy.memoryWriter[65283]=this.writeIllegal,this.gameboy.highMemoryWriter[4]=this.gameboy.memoryWriter[65284]=(t,e)=>{this.gameboy.DIVTicks&=255,this.gameboy.memory[65284]=0},this.gameboy.highMemoryWriter[5]=this.gameboy.memoryWriter[65285]=(t,e)=>{this.gameboy.memory[65285]=e},this.gameboy.highMemoryWriter[6]=this.gameboy.memoryWriter[65286]=(t,e)=>{this.gameboy.memory[65286]=e},this.gameboy.highMemoryWriter[7]=this.gameboy.memoryWriter[65287]=(t,e)=>{this.gameboy.memory[65287]=7&e,this.gameboy.TIMAEnabled=4==(4&e),this.gameboy.TACClocker=Math.pow(4,0!=(3&e)?3&e:4)<<2},this.gameboy.highMemoryWriter[8]=this.gameboy.memoryWriter[65288]=this.writeIllegal,this.gameboy.highMemoryWriter[9]=this.gameboy.memoryWriter[65289]=this.writeIllegal,this.gameboy.highMemoryWriter[10]=this.gameboy.memoryWriter[65290]=this.writeIllegal,this.gameboy.highMemoryWriter[11]=this.gameboy.memoryWriter[65291]=this.writeIllegal,this.gameboy.highMemoryWriter[12]=this.gameboy.memoryWriter[65292]=this.writeIllegal,this.gameboy.highMemoryWriter[13]=this.gameboy.memoryWriter[65293]=this.writeIllegal,this.gameboy.highMemoryWriter[14]=this.gameboy.memoryWriter[65294]=this.writeIllegal,this.gameboy.highMemoryWriter[15]=this.gameboy.memoryWriter[65295]=(t,e)=>{this.gameboy.interruptRequestedFlags=e,this.gameboy.checkIrqMatching()},this.gameboy.audioController.registerMemoryWriters(),this.gameboy.highMemoryWriter[39]=this.gameboy.memoryWriter[65319]=this.writeIllegal,this.gameboy.highMemoryWriter[40]=this.gameboy.memoryWriter[65320]=this.writeIllegal,this.gameboy.highMemoryWriter[41]=this.gameboy.memoryWriter[65321]=this.writeIllegal,this.gameboy.highMemoryWriter[42]=this.gameboy.memoryWriter[65322]=this.writeIllegal,this.gameboy.highMemoryWriter[43]=this.gameboy.memoryWriter[65323]=this.writeIllegal,this.gameboy.highMemoryWriter[44]=this.gameboy.memoryWriter[65324]=this.writeIllegal,this.gameboy.highMemoryWriter[45]=this.gameboy.memoryWriter[65325]=this.writeIllegal,this.gameboy.highMemoryWriter[46]=this.gameboy.memoryWriter[65326]=this.writeIllegal,this.gameboy.highMemoryWriter[47]=this.gameboy.memoryWriter[65327]=this.writeIllegal,this.gameboy.audioController.registerWaveformMemoryWriters(),this.gameboy.highMemoryWriter[66]=this.gameboy.memoryWriter[65346]=(t,e)=>{this.gameboy.backgroundY!==e&&(this.gameboy.midScanlineJIT(),this.gameboy.backgroundY=e)},this.gameboy.highMemoryWriter[67]=this.gameboy.memoryWriter[65347]=(t,e)=>{this.gameboy.backgroundX!==e&&(this.gameboy.midScanlineJIT(),this.gameboy.backgroundX=e)},this.gameboy.highMemoryWriter[68]=this.gameboy.memoryWriter[65348]=(t,e)=>{this.gameboy.gpu.lcdEnabled&&(this.gameboy.modeSTAT=2,this.gameboy.midScanlineOffset=-1,this.gameboy.cpu.totalLinesPassed=this.gameboy.currentX=this.gameboy.queuedScanlines=this.gameboy.lastUnrenderedLine=this.gameboy.LCDTicks=this.gameboy.STATTracker=this.gameboy.actualScanline=this.gameboy.memory[65348]=0)},this.gameboy.highMemoryWriter[69]=this.gameboy.memoryWriter[65349]=(t,e)=>{this.gameboy.memory[65349]!==e&&(this.gameboy.memory[65349]=e,this.gameboy.gpu.lcdEnabled&&this.gameboy.matchLYC())},this.gameboy.highMemoryWriter[74]=this.gameboy.memoryWriter[65354]=(t,e)=>{this.gameboy.windowY!==e&&(this.gameboy.midScanlineJIT(),this.gameboy.windowY=e)},this.gameboy.highMemoryWriter[75]=this.gameboy.memoryWriter[65355]=(t,e)=>{this.gameboy.memory[65355]!==e&&(this.gameboy.midScanlineJIT(),this.gameboy.memory[65355]=e,this.gameboy.windowX=e-7)},this.gameboy.highMemoryWriter[114]=this.gameboy.memoryWriter[65394]=(t,e)=>{this.gameboy.memory[65394]=e},this.gameboy.highMemoryWriter[115]=this.gameboy.memoryWriter[65395]=(t,e)=>{this.gameboy.memory[65395]=e},this.gameboy.highMemoryWriter[117]=this.gameboy.memoryWriter[65397]=(t,e)=>{this.gameboy.memory[65397]=e},this.gameboy.highMemoryWriter[118]=this.gameboy.memoryWriter[65398]=this.writeIllegal,this.gameboy.highMemoryWriter[119]=this.gameboy.memoryWriter[65399]=this.writeIllegal,this.gameboy.highMemoryWriter[255]=this.gameboy.memoryWriter[65535]=(t,e)=>{this.gameboy.interruptEnabledFlags=e,this.gameboy.checkIrqMatching()},this.recompileModelSpecificIOWriteHandling(),this.updateIoRegisters()}recompileModelSpecificIOWriteHandling(){this.gameboy.cartridge.useGbcMode?(this.gameboy.highMemoryWriter[2]=this.gameboy.memoryWriter[65282]=(t,e)=>{1==(1&e)?(this.gameboy.memory[65282]=127&e,this.gameboy.serialTimer=0==(2&e)?4096:128,this.gameboy.serialShiftTimer=this.gameboy.serialShiftTimerAllocated=0==(2&e)?512:16):(this.gameboy.memory[65282]=e,this.gameboy.serialShiftTimer=this.gameboy.serialShiftTimerAllocated=this.gameboy.serialTimer=0)},this.gameboy.highMemoryWriter[64]=this.gameboy.memoryWriter[65344]=(t,e)=>{if(this.gameboy.memory[65344]!==e){this.gameboy.midScanlineJIT();const t=e>127;t!==this.gameboy.gpu.lcdEnabled&&(this.gameboy.gpu.lcdEnabled=t,this.gameboy.memory[65345]&=120,this.gameboy.midScanlineOffset=-1,this.gameboy.cpu.totalLinesPassed=this.gameboy.currentX=this.gameboy.queuedScanlines=this.gameboy.lastUnrenderedLine=this.gameboy.STATTracker=this.gameboy.LCDTicks=this.gameboy.actualScanline=this.gameboy.memory[65348]=0,this.gameboy.gpu.lcdEnabled?(this.gameboy.modeSTAT=2,this.gameboy.matchLYC(),this.gameboy.gpu.enableLCD()):(this.gameboy.modeSTAT=0,this.gameboy.gpu.disableLCD(),this.gameboy.lcdDevice.turnOff()),this.gameboy.interruptRequestedFlags&=253),this.gameboy.gfxWindowCHRBankPosition=64==(64&e)?1024:0,this.gameboy.gfxWindowDisplay=32==(32&e),this.gameboy.gfxBackgroundBankOffset=16==(16&e)?0:128,this.gameboy.gfxBackgroundCHRBankPosition=8==(8&e)?1024:0,this.gameboy.gfxSpriteNormalHeight=0==(4&e),this.gameboy.gfxSpriteShow=2==(2&e),this.gameboy.hasBackgroundPriority=1==(1&e),this.gameboy.gpu.initRenderer(),this.gameboy.memory[65344]=e}},this.gameboy.highMemoryWriter[65]=this.gameboy.memoryWriter[65345]=(t,e)=>{this.gameboy.LYCMatchTriggerSTAT=64==(64&e),this.gameboy.mode2TriggerSTAT=32==(32&e),this.gameboy.mode1TriggerSTAT=16==(16&e),this.gameboy.mode0TriggerSTAT=8==(8&e),this.gameboy.memory[65345]=120&e},this.gameboy.highMemoryWriter[70]=this.gameboy.memoryWriter[65350]=(t,e)=>{if(this.gameboy.memory[65350]=e,e<224){e<<=8,t=65024;const i=this.gameboy.modeSTAT;this.gameboy.modeSTAT=0;do{const r=this.readDirectly(e++);if(r!==this.gameboy.memory[t]){this.gameboy.modeSTAT=i,this.gameboy.graphicsJIT(),this.gameboy.modeSTAT=0,this.gameboy.memory[t++]=r;break}}while(++t<65184);if(t<65184)do{this.gameboy.memory[t++]=this.readDirectly(e++),this.gameboy.memory[t++]=this.readDirectly(e++),this.gameboy.memory[t++]=this.readDirectly(e++),this.gameboy.memory[t++]=this.readDirectly(e++)}while(t<65184);this.gameboy.modeSTAT=i}},this.gameboy.highMemoryWriter[77]=this.gameboy.memoryWriter[65357]=(t,e)=>{this.gameboy.memory[65357]=127&e|128&this.gameboy.memory[65357]},this.gameboy.highMemoryWriter[79]=this.gameboy.memoryWriter[65359]=(t,e)=>{this.gameboy.currentVideoRamBank=1&e,this.gameboy.currentVideoRamBank>0?this.gameboy.BGCHRCurrentBank=this.gameboy.BGCHRBank2:this.gameboy.BGCHRCurrentBank=this.gameboy.BGCHRBank1},this.gameboy.highMemoryWriter[81]=this.gameboy.memoryWriter[65361]=(t,e)=>{this.gameboy.hdmaRunning||(this.gameboy.memory[65361]=e)},this.gameboy.highMemoryWriter[82]=this.gameboy.memoryWriter[65362]=(t,e)=>{this.gameboy.hdmaRunning||(this.gameboy.memory[65362]=240&e)},this.gameboy.highMemoryWriter[83]=this.gameboy.memoryWriter[65363]=(t,e)=>{this.gameboy.hdmaRunning||(this.gameboy.memory[65363]=31&e)},this.gameboy.highMemoryWriter[84]=this.gameboy.memoryWriter[65364]=(t,e)=>{this.gameboy.hdmaRunning||(this.gameboy.memory[65364]=240&e)},this.gameboy.highMemoryWriter[85]=this.gameboy.memoryWriter[65365]=(t,e)=>{this.gameboy.hdmaRunning?0==(128&e)?(this.gameboy.hdmaRunning=!1,this.gameboy.memory[65365]|=128):this.gameboy.memory[65365]=127&e:0==(128&e)?(this.gameboy.writeDirectlyToMemory(1+(127&e)),this.gameboy.memory[65365]=255):(this.gameboy.hdmaRunning=!0,this.gameboy.memory[65365]=127&e)},this.gameboy.highMemoryWriter[104]=this.gameboy.memoryWriter[65384]=(t,e)=>{this.gameboy.memory[65385]=this.gameboy.gbcBGRawPalette[63&e],this.gameboy.memory[65384]=e},this.gameboy.highMemoryWriter[105]=this.gameboy.memoryWriter[65385]=(t,e)=>{if(this.gameboy.updateGBCBGPalette(63&this.gameboy.memory[65384],e),this.gameboy.memory[65384]>127){var i=this.gameboy.memory[65384]+1&63;this.gameboy.memory[65384]=128|i,this.gameboy.memory[65385]=this.gameboy.gbcBGRawPalette[i]}else this.gameboy.memory[65385]=e},this.gameboy.highMemoryWriter[106]=this.gameboy.memoryWriter[65386]=(t,e)=>{this.gameboy.memory[65387]=this.gameboy.gbcOBJRawPalette[63&e],this.gameboy.memory[65386]=e},this.gameboy.highMemoryWriter[107]=this.gameboy.memoryWriter[65387]=(t,e)=>{if(this.gameboy.updateGBCOBJPalette(63&this.gameboy.memory[65386],e),this.gameboy.memory[65386]>127){var i=this.gameboy.memory[65386]+1&63;this.gameboy.memory[65386]=128|i,this.gameboy.memory[65387]=this.gameboy.gbcOBJRawPalette[i]}else this.gameboy.memory[65387]=e},this.gameboy.highMemoryWriter[112]=this.gameboy.memoryWriter[65392]=(t,e)=>{var i=this.gameboy.memory[65361]<<8|this.gameboy.memory[65362];(!this.gameboy.hdmaRunning||i<53248||i>=57344)&&(this.gameboy.gbcRamBank=Math.max(7&e,1),this.gameboy.gbcRamBankPosition=(this.gameboy.gbcRamBank-1<<12)-53248,this.gameboy.gbcEchoRamBankPosition=this.gameboy.gbcRamBankPosition-8192),this.gameboy.memory[65392]=e},this.gameboy.highMemoryWriter[116]=this.gameboy.memoryWriter[65396]=(t,e)=>{this.gameboy.memory[65396]=e}):(this.gameboy.highMemoryWriter[2]=this.gameboy.memoryWriter[65282]=(t,e)=>{1==(1&e)?(this.gameboy.memory[65282]=127&e,this.gameboy.serialTimer=4096,this.gameboy.serialShiftTimer=this.gameboy.serialShiftTimerAllocated=512):(this.gameboy.memory[65282]=e,this.gameboy.serialShiftTimer=this.gameboy.serialShiftTimerAllocated=this.gameboy.serialTimer=0)},this.gameboy.highMemoryWriter[64]=this.gameboy.memoryWriter[65344]=(t,e)=>{if(this.gameboy.memory[65344]!==e){this.gameboy.midScanlineJIT();const t=e>127;t!==this.gameboy.gpu.lcdEnabled&&(this.gameboy.gpu.lcdEnabled=t,this.gameboy.memory[65345]&=120,this.gameboy.midScanlineOffset=-1,this.gameboy.cpu.totalLinesPassed=this.gameboy.currentX=this.gameboy.queuedScanlines=this.gameboy.lastUnrenderedLine=this.gameboy.STATTracker=this.gameboy.LCDTicks=this.gameboy.actualScanline=this.gameboy.memory[65348]=0,this.gameboy.gpu.lcdEnabled?(this.gameboy.modeSTAT=2,this.gameboy.matchLYC(),this.gameboy.gpu.enableLCD()):(this.gameboy.modeSTAT=0,this.gameboy.gpu.disableLCD(),this.gameboy.lcdDevice.turnOff()),this.gameboy.interruptRequestedFlags&=253),this.gameboy.gfxWindowCHRBankPosition=64==(64&e)?1024:0,this.gameboy.gfxWindowDisplay=32==(32&e),this.gameboy.gfxBackgroundBankOffset=16==(16&e)?0:128,this.gameboy.gfxBackgroundCHRBankPosition=8==(8&e)?1024:0,this.gameboy.gfxSpriteNormalHeight=0==(4&e),this.gameboy.gfxSpriteShow=2==(2&e),this.gameboy.backgroundEnabled=1==(1&e),this.gameboy.memory[65344]=e}},this.gameboy.highMemoryWriter[65]=this.gameboy.memoryWriter[65345]=(t,e)=>{this.gameboy.LYCMatchTriggerSTAT=64==(64&e),this.gameboy.mode2TriggerSTAT=32==(32&e),this.gameboy.mode1TriggerSTAT=16==(16&e),this.gameboy.mode0TriggerSTAT=8==(8&e),this.gameboy.memory[65345]=120&e,(!this.gameboy.usedBootRom||!this.gameboy.usedGbcBootRom)&&this.gameboy.gpu.lcdEnabled&&this.gameboy.modeSTAT<2&&(this.gameboy.interruptRequestedFlags|=2,this.gameboy.checkIrqMatching())},this.gameboy.highMemoryWriter[70]=this.gameboy.memoryWriter[65350]=(t,e)=>{if(this.gameboy.memory[65350]=e,e>127&&e<224){e<<=8,t=65024;var i=this.gameboy.modeSTAT;this.gameboy.modeSTAT=0;var r=0;do{if((r=this.readDirectly(e++))!==this.gameboy.memory[t]){this.gameboy.modeSTAT=i,this.gameboy.graphicsJIT(),this.gameboy.modeSTAT=0,this.gameboy.memory[t++]=r;break}}while(++t<65184);if(t<65184)do{this.gameboy.memory[t++]=this.readDirectly(e++),this.gameboy.memory[t++]=this.readDirectly(e++),this.gameboy.memory[t++]=this.readDirectly(e++),this.gameboy.memory[t++]=this.readDirectly(e++)}while(t<65184);this.gameboy.modeSTAT=i}},this.gameboy.highMemoryWriter[71]=this.gameboy.memoryWriter[65351]=(t,e)=>{this.gameboy.memory[65351]!==e&&(this.gameboy.midScanlineJIT(),this.gameboy.updateGBBGPalette(e),this.gameboy.memory[65351]=e)},this.gameboy.highMemoryWriter[72]=this.gameboy.memoryWriter[65352]=(t,e)=>{this.gameboy.memory[65352]!==e&&(this.gameboy.midScanlineJIT(),this.gameboy.updateGBOBJPalette(0,e),this.gameboy.memory[65352]=e)},this.gameboy.highMemoryWriter[73]=this.gameboy.memoryWriter[65353]=(t,e)=>{this.gameboy.memory[65353]!==e&&(this.gameboy.midScanlineJIT(),this.gameboy.updateGBOBJPalette(4,e),this.gameboy.memory[65353]=e)},this.gameboy.highMemoryWriter[77]=this.gameboy.memoryWriter[65357]=(t,e)=>{this.gameboy.memory[65357]=e},this.gameboy.highMemoryWriter[79]=this.gameboy.memoryWriter[65359]=this.writeIllegal,this.gameboy.highMemoryWriter[85]=this.gameboy.memoryWriter[65365]=this.writeIllegal,this.gameboy.highMemoryWriter[104]=this.gameboy.memoryWriter[65384]=this.writeIllegal,this.gameboy.highMemoryWriter[105]=this.gameboy.memoryWriter[65385]=this.writeIllegal,this.gameboy.highMemoryWriter[106]=this.gameboy.memoryWriter[65386]=this.writeIllegal,this.gameboy.highMemoryWriter[107]=this.gameboy.memoryWriter[65387]=this.writeIllegal,this.gameboy.highMemoryWriter[108]=this.gameboy.memoryWriter[65388]=this.writeIllegal,this.gameboy.highMemoryWriter[112]=this.gameboy.memoryWriter[65392]=this.writeIllegal,this.gameboy.highMemoryWriter[116]=this.gameboy.memoryWriter[65396]=this.writeIllegal)}}const G=[[!1,!1,!1,!1,!1,!1,!1,!0],[!0,!1,!1,!1,!1,!1,!1,!0],[!0,!1,!1,!1,!1,!0,!0,!0],[!1,!0,!0,!0,!0,!0,!0,!1]],E=[!0,1,!0,!1,!0,!0,0,19,0,216,333,65534,256,!1,!0,!1,0,0,[],[],0,[],1,-53248,0,0,0,!1,!1,!1,!1,!1,0,!1,!1,!0,0,128,!1,56,60,0,1024,0,0,0,0,(new Date).getTime(),0,[],!0,8192,512,0,0,!1,0,0,!0,0,!1,0,1,0,!1,0,!1,8192,512,0,0,!1,0,0,!0,0,!1,0,4,0,!0,null,8,0,0,0,0,!1,0,0,!0,32767,!1,8,8,!1,!1,!1,!1,!1,!1,!1,!1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,G[2],0,G[2],!1,!1,!1,!1,8192,0,2048,8,0,0,2048,0,144,0,0,!1,0,0,0,0,0,0,0,0,0,!1,!1,!1,!1,0,-61440,0,0,null,null,null,null,null,null,null,null,null,null,null,null,0,0,0,0,!1,0,0,!1,1,1];class D{constructor(t){this.gameboy=t}init(){this.loadOld(E.slice(0))}get(){const t=this.gameboy;return t.cartridge?g(t.memory.buffer.slice(0),t.videoRam.buffer.slice(0)):null}load(t){this.gameboy}loadOld(t){let e=0;const i=this.gameboy;i.isBootingRom=t[e++],i.registerA=t[e++],i.FZero=t[e++],i.FSubtract=t[e++],i.FHalfCarry=t[e++],i.FCarry=t[e++],i.registerB=t[e++],i.registerC=t[e++],i.registerD=t[e++],i.registerE=t[e++],i.registersHL=t[e++],i.stackPointer=t[e++],i.programCounter=t[e++],i.halt=t[e++],i.IME=t[e++],i.hdmaRunning=t[e++],i.currentInstructionCycleCount=t[e++],i.doubleSpeedShifter=t[e++],i.memory=a(t[e++],"uint8"),i.videoRam=a(t[e++],"uint8"),i.currentVideoRamBank=t[e++],i.gbcMemory=a(t[e++],"uint8"),i.gbcRamBank=t[e++],i.gbcRamBankPosition=t[e++],i.ROMBank1Offset=t[e++],i.cartridge?.mbc?i.cartridge.mbc.currentRomBank=t[e++]:e++,i.modeSTAT=t[e++],i.LYCMatchTriggerSTAT=t[e++],i.mode2TriggerSTAT=t[e++],i.mode1TriggerSTAT=t[e++],i.mode0TriggerSTAT=t[e++],i.gpu.lcdEnabled=t[e++],i.gfxWindowCHRBankPosition=t[e++],i.gfxWindowDisplay=t[e++],i.gfxSpriteShow=t[e++],i.gfxSpriteNormalHeight=t[e++],i.gfxBackgroundCHRBankPosition=t[e++],i.gfxBackgroundBankOffset=t[e++],i.TIMAEnabled=t[e++],i.DIVTicks=t[e++],i.LCDTicks=t[e++],i.timerTicks=t[e++],i.TACClocker=t[e++],i.serialTimer=t[e++],i.serialShiftTimer=t[e++],i.serialShiftTimerAllocated=t[e++],i.IRQEnableDelay=t[e++],i.cartridge?.hasRtc?i.cartridge.mbc3.rtc.lastTime=t[e++]:e++,i.drewBlank=t[e++],i.frameBuffer=a(t[e++],"int32"),i.backgroundEnabled=t[e++],i.audioController.channel1.frequencyTracker=t[e++],i.audioController.channel1.frequencyCounter=t[e++],i.audioController.channel1.totalLength=t[e++],i.audioController.channel1.envelopeVolume=t[e++],i.audioController.channel1.envelopeType=t[e++],i.audioController.channel1.envelopeSweeps=t[e++],i.audioController.channel1.envelopeSweepsLast=t[e++],i.audioController.channel1.consecutive=t[e++],i.audioController.channel1.frequency=t[e++],i.audioController.channel1.sweepFault=t[e++],i.audioController.channel1.shadowFrequency=t[e++],i.audioController.channel1.timeSweep=t[e++],i.audioController.channel1.lastTimeSweep=t[e++],i.audioController.channel1.swept=t[e++],i.audioController.channel1.frequencySweepDivider=t[e++],i.audioController.channel1.decreaseSweep=t[e++],i.audioController.channel2.frequencyTracker=t[e++],i.audioController.channel2.frequencyCounter=t[e++],i.audioController.channel2.totalLength=t[e++],i.audioController.channel2.envelopeVolume=t[e++],i.audioController.channel2.envelopeType=t[e++],i.audioController.channel2.envelopeSweeps=t[e++],i.audioController.channel2.envelopeSweepsLast=t[e++],i.audioController.channel2.consecutive=t[e++],i.audioController.channel2.frequency=t[e++],i.audioController.channel3CanPlay=t[e++],i.audioController.channel3TotalLength=t[e++],i.audioController.channel3PatternType=t[e++],i.audioController.channel3frequency=t[e++],i.audioController.channel3Consecutive=t[e++],i.audioController.channel3PcmData=a(t[e++],"int8"),i.audioController.channel4FrequencyPeriod=t[e++],i.audioController.channel4LastSampleLookup=t[e++],i.audioController.channel4TotalLength=t[e++],i.audioController.channel4EnvelopeVolume=t[e++],i.audioController.channel4CurrentVolume=t[e++],i.audioController.channel4EnvelopeType=t[e++],i.audioController.channel4EnvelopeSweeps=t[e++],i.audioController.channel4EnvelopeSweepsLast=t[e++],i.audioController.channel4Consecutive=t[e++],i.audioController.channel4BitRange=t[e++],i.audioController.enabled=t[e++],i.audioController.cartridgeLeftChannelInputVolume=t[e++],i.audioController.cartridgeRightChannelInputVolume=t[e++],i.audioController.channel1.leftChannelEnabled=t[e++],i.audioController.channel2.leftChannelEnabled=t[e++],i.audioController.leftChannel3=t[e++],i.audioController.leftChannel4=t[e++],i.audioController.channel1.rightChannelEnabled=t[e++],i.audioController.channel2.rightChannelEnabled=t[e++],i.audioController.rightChannel3=t[e++],i.audioController.rightChannel4=t[e++],i.audioController.channel1.currentSampleLeft=t[e++],i.audioController.channel1.currentSampleRight=t[e++],i.audioController.channel2.currentSampleLeft=t[e++],i.audioController.channel2.currentSampleRight=t[e++],i.audioController.channel3CurrentSampleLeft=t[e++],i.audioController.channel3CurrentSampleRight=t[e++],i.audioController.channel4CurrentSampleLeft=t[e++],i.audioController.channel4CurrentSampleRight=t[e++],i.audioController.channel1.currentSampleLeftSecondary=t[e++],i.audioController.channel1.currentSampleRightSecondary=t[e++],i.audioController.channel2.currentSampleLeftSecondary=t[e++],i.audioController.channel2.currentSampleRightSecondary=t[e++],i.audioController.channel3CurrentSampleLeftSecondary=t[e++],i.audioController.channel3CurrentSampleRightSecondary=t[e++],i.audioController.channel4CurrentSampleLeftSecondary=t[e++],i.audioController.channel4CurrentSampleRightSecondary=t[e++],i.audioController.channel1.currentSampleLeftTrimary=t[e++],i.audioController.channel1.currentSampleRightTrimary=t[e++],i.audioController.channel2.currentSampleLeftTrimary=t[e++],i.audioController.channel2.currentSampleRightTrimary=t[e++],i.audioController.mixerOutputCache=t[e++],i.audioController.channel1.dutyTracker=t[e++],i.audioController.channel1.cachedDuty=t[e++],i.audioController.channel2.dutyTracker=t[e++],i.audioController.channel2.cachedDuty=t[e++],i.audioController.channel1.enabled=t[e++],i.audioController.channel2.enabled=t[e++],i.audioController.channel3Enabled=t[e++],i.audioController.channel4Enabled=t[e++],i.audioController.sequencerClocks=t[e++],i.audioController.sequencePosition=t[e++],i.audioController.channel3Counter=t[e++],i.audioController.channel4Counter=t[e++],i.audioController.cachedChannel3Sample=t[e++],i.audioController.cachedChannel4Sample=t[e++],i.audioController.channel3FrequencyPeriod=t[e++],i.audioController.channel3LastSampleLookup=t[e++],i.actualScanline=t[e++],i.lastUnrenderedLine=t[e++],i.queuedScanlines=t[e++],i.cartridge?.hasRtc?(i.cartridge.mbc3.rtc.RTCisLatched=t[e++],i.cartridge.mbc3.rtc.latchedSeconds=t[e++],i.cartridge.mbc3.rtc.latchedMinutes=t[e++],i.cartridge.mbc3.rtc.latchedHours=t[e++],i.cartridge.mbc3.rtc.latchedLDays=t[e++],i.cartridge.mbc3.rtc.latchedHDays=t[e++],i.cartridge.mbc3.rtc.RTCSeconds=t[e++],i.cartridge.mbc3.rtc.RTCMinutes=t[e++],i.cartridge.mbc3.rtc.RTCHours=t[e++],i.cartridge.mbc3.rtc.RTCDays=t[e++],i.cartridge.mbc3.rtc.RTCDayOverFlow=t[e++],i.cartridge.mbc3.rtc.RTCHalt=t[e++]):e+=12,i.usedBootRom=t[e++],i.skipPCIncrement=t[e++],i.STATTracker=t[e++],i.gbcEchoRamBankPosition=t[e++],i.windowY=t[e++],i.windowX=t[e++],i.gbcOBJRawPalette=a(t[e++],"uint8"),i.gbcBGRawPalette=a(t[e++],"uint8"),i.gbOBJPalette=a(t[e++],"int32"),i.gbBGPalette=a(t[e++],"int32"),i.gbcOBJPalette=a(t[e++],"int32"),i.gbcBGPalette=a(t[e++],"int32"),i.gbBGColorizedPalette=a(t[e++],"int32"),i.gbOBJColorizedPalette=a(t[e++],"int32"),i.cachedBGPaletteConversion=a(t[e++],"int32"),i.cachedOBJPaletteConversion=a(t[e++],"int32"),i.BGCHRBank1=a(t[e++],"uint8"),i.BGCHRBank2=a(t[e++],"uint8"),i.haltPostClocks=t[e++],i.interruptRequestedFlags=t[e++],i.interruptEnabledFlags=t[e++],i.checkIrqMatching(),i.remainingClocks=t[e++],i.colorizedGBPalettes=t[e++],i.backgroundY=t[e++],i.backgroundX=t[e++],i.cpu.stopped=t[e++],i.audioController.audioClocksUntilNextEvent=t[e++],i.audioController.audioClocksUntilNextEventCounter=t[e]}}class I{constructor(t,e,i,r){if(this.fromSampleRate=t,this.toSampleRate=e,this.channels=i,this.outputBufferSize=r,this.fromSampleRate<=0||this.toSampleRate<=0||this.channels<=0)throw new Error("Invalid settings specified for the resampler.");this.ratioWeight=this.fromSampleRate/this.toSampleRate,this.fromSampleRate<this.toSampleRate&&(this.lastWeight=1),this.outputBuffer=new Float32Array(this.outputBufferSize),this.lastOutput=new Float32Array(this.channels)}resample(t){let e=t.length;if(e%this.channels!=0)throw new Error("Buffer was of incorrect sample length.");if(0===e)return;let i=this.lastWeight,r=0,s=0,h=0,a=0;for(;i<1;i+=this.ratioWeight){s=i%1,r=1-s;for(let e=0;e<this.channels;e++)this.outputBuffer[a++]=this.lastOutput[e]*r+t[e]*s}for(i-=1,e-=this.channels,h=Math.floor(i)*this.channels;a<this.outputBufferSize&&h<e;){s=i%1,r=1-s;for(let e=0;e<this.channels;e++)this.outputBuffer[a++]=t[h+e]*r+t[h+this.channels+e]*s;i+=this.ratioWeight,h=Math.floor(i)*this.channels}for(let e=0;e<this.channels;++e)this.lastOutput[e]=t[h++];return this.lastWeight=i%1,a}}const x=require("worker-url"),O="undefined"!=typeof window?"undefined"!=typeof AudioContext?AudioContext:window.webkitAudioContext:null;class Z{constructor({context:t,channels:e,minBufferSize:i}){this.volume=1,this.samplesPerCallback=2048,this.context=t,this.channelsAllocated=Math.max(e,1),this.bufferSize=this.samplesPerCallback*this.channelsAllocated,this.minBufferSize=i||this.bufferSize}setSampleRate(t){this.sampleRate=t}setMaxBufferSize(t){this.maxBufferSize=Math.floor(t)>this.minBufferSize+this.channelsAllocated?t&-this.channelsAllocated:this.minBufferSize*this.channelsAllocated}writeAudio(t){let e=0;for(;e<t.length&&this.inputBufferSize<this.maxBufferSize;)this.inputBuffer[this.inputBufferSize++]=t[e++]}remainingBuffer(){return Math.floor(this.resampledSamplesLeft()*this.resampler?.ratioWeight/this.channelsAllocated)*this.channelsAllocated+this.inputBufferSize}async init(){if(this.context||(this.context=new O),!this.audioNode){if(this.gainNode=this.context.createGain(),this.context?.audioWorklet)(this.audioNode=this.context.createScriptProcessor(this.samplesPerCallback,0,this.channelsAllocated)).onaudioprocess=t=>this.processAudio(t);else{const e=new x.WorkerUrl(new URL(t.p+t.u(259),t.b),{name:"worklet"});await this.context.audioWorklet.addModule(e),this.audioNode=new AudioWorkletNode(this.context,"noise-generator")}this.audioNode.connect(this.gainNode),this.gainNode.connect(this.context.destination),this.resetAudioBuffer(this.context.sampleRate)}}processAudio(t){const e=[];let i=0;for(;i<this.channelsAllocated;)e[i]=t.outputBuffer.getChannelData(i),++i;this.refillResampledBuffer();let r=0;for(;r<this.samplesPerCallback&&this.outputBufferStart!==this.outputBufferEnd;){for(i=0;i<this.channelsAllocated;)e[i][r]=this.outputBuffer[this.outputBufferStart++],++i;this.outputBufferStart===this.outputBufferSize&&(this.outputBufferStart=0),++r}for(;r<this.samplesPerCallback;){for(i=0;i<this.channelsAllocated;++i)e[i][r]=0;++r}}setVolume(t){this.volume=Math.max(0,Math.min(1,t)),this.gainNode.gain.setTargetAtTime(this.volume,this.context.currentTime,0)}resetAudioBuffer(t){this.inputBufferSize=this.outputBufferEnd=this.outputBufferStart=0,this.initializeResampler(t),this.outputBuffer=new Float32Array(this.outputBufferSize)}refillResampledBuffer(){if(this.inputBufferSize>0){const t=this.resampler.resample(this.getBufferSamples()),e=this.resampler.outputBuffer;for(let i=0;i<t;)this.outputBuffer[this.outputBufferEnd++]=e[i++],this.outputBufferEnd===this.outputBufferSize&&(this.outputBufferEnd=0),this.outputBufferStart===this.outputBufferEnd&&(this.outputBufferStart+=this.channelsAllocated,this.outputBufferStart===this.outputBufferSize&&(this.outputBufferStart=0));this.inputBufferSize=0}}initializeResampler(t){this.inputBuffer=new Float32Array(this.maxBufferSize),this.outputBufferSize=Math.max(this.maxBufferSize*Math.ceil(t/this.sampleRate)+this.channelsAllocated,this.bufferSize),this.resampler=new I(this.sampleRate,t,this.channelsAllocated,this.outputBufferSize)}resampledSamplesLeft(){return(this.outputBufferStart<=this.outputBufferEnd?0:this.outputBufferSize)+this.outputBufferEnd-this.outputBufferStart}getBufferSamples(){return this.inputBuffer.subarray(0,this.inputBufferSize)}}class q extends A.EventEmitter{constructor(t){super(),this.romSizes=[32768,65536,131072,262144,524288,1048576,2097152,4194304,8388608],this.ramSizes=[0,8192,8192,32768,131072,65536],this.readRam=t=>this.ramBanksEnabled?this.ram[t+this.currentRamBankPosition]:255,this.writeRam=(t,e)=>{this.ramBanksEnabled&&(this.emit("ramWrite"),this.ram[t+this.currentRamBankPosition]=e)},this.toggle=(t,e)=>{this.ramBanksEnabled=10==(15&e)},this.cartridge=t,this.ramBanksEnabled=!1,this.currentRamBankPosition=-40960,this.currentMbcRamBank=0,this.romBankEdge=Math.floor(t.rom.length/16384)}setupRom(){this.romSize=this.romSizes[this.cartridge.romSizeType],console.log("ROM size 0x"+this.romSize.toString(16))}setupRAM(){this.ramSize=this.ramSizes[this.cartridge.ramSizeType],console.log("RAM size 0x"+this.ramSize.toString(16)),this.ram=new Uint8Array(this.ramSize)}loadRam(t){t.byteLength===this.ramSize&&(this.ram=t.slice(0))}getRam(){return new Uint8Array(this.ram.buffer.slice(0,this.ramSize))}cutSRAMFromBatteryFileArray(t){return new Uint8Array(t.slice(0,this.ramSize))}saveState(){if(this.cartridge.hasBattery&&0!==this.ram.length)return o(this.ram)}setCurrentROMBank(){this.currentRomBank=Math.max(this.romBank1Offset%this.romBankEdge-1,0)<<14}}class V extends q{constructor(){super(...arguments),this.MBC1Mode=!1,this.writeType=(t,e)=>{this.MBC1Mode=1==(1&e),this.MBC1Mode?(this.romBank1Offset&=31,this.setCurrentROMBank()):(this.currentMbcRamBank=0,this.currentRamBankPosition=-40960)},this.writeRomBank=(t,e)=>{this.romBank1Offset=96&this.romBank1Offset|31&e,this.setCurrentROMBank()},this.writeRamBank=(t,e)=>{this.MBC1Mode?(this.currentMbcRamBank=3&e,this.currentRamBankPosition=(this.currentMbcRamBank<<13)-40960):(this.romBank1Offset=(3&e)<<5|31&this.romBank1Offset,this.setCurrentROMBank())}}setCurrentROMBank(){switch(this.romBank1Offset){case 0:case 32:case 64:case 96:this.currentRomBank=this.romBank1Offset%this.romBankEdge<<14;break;default:this.currentRomBank=this.romBank1Offset%this.romBankEdge-1<<14}}}class N extends q{constructor(){super(...arguments),this.writeRomBank=(t,e)=>{this.romBank1Offset=15&e,this.setCurrentROMBank()}}}class z{constructor(t){this.mbc=t,this.writeLatch=(t,e)=>{0===e?this.RTCisLatched=!1:this.RTCisLatched||(this.RTCisLatched=!0,this.latchedSeconds=0|this.RTCSeconds,this.latchedMinutes=this.RTCMinutes,this.latchedHours=this.RTCHours,this.latchedLDays=255&this.RTCDays,this.latchedHDays=this.RTCDays>>8)}}writeSeconds(t){t<60?this.RTCSeconds=t:console.log("(Bank #"+this.mbc.currentMbcRamBank+") RTC write out of range: "+t)}writeMinutes(t){t<60?this.RTCMinutes=t:console.log("(Bank #"+this.mbc.currentMbcRamBank+") RTC write out of range: "+t)}writeDaysLow(t){this.RTCDays=255&t|256&this.RTCDays}writeDaysHigh(t){this.RTCDayOverFlow=t>127,this.RTCHalt=64==(64&t),this.RTCDays=(1&t)<<8|255&this.RTCDays}writeHours(t){t<24?this.RTCHours=t:console.log("(Bank #"+this.mbc.currentMbcRamBank+") RTC write out of range: "+t)}readSeconds(){return this.latchedSeconds}readMinutes(){return this.latchedMinutes}readHours(){return this.latchedHours}readDaysLow(){return this.latchedLDays}readDaysHigh(){return(this.RTCDayOverFlow?128:0)+(this.RTCHalt?64:0)+this.latchedHDays}get(){const t=Math.round(this.lastTime/1e3),e=t>>0&65535,i=t>>16&65535;return new Uint32Array([this.RTCSeconds,this.RTCMinutes,this.RTCHours,this.RTCDays,this.RTCDayOverFlow?1:0,this.latchedSeconds,this.latchedMinutes,this.latchedHours,this.latchedLDays,this.latchedHDays,e,i])}load(t){const e=this.extract(t);this.RTCSeconds=e.seconds,this.RTCMinutes=e.minutes,this.RTCHours=e.hours,this.RTCDays=e.daysLow,this.RTCDayOverFlow=e.daysHigh,this.latchedSeconds=e.latchedSeconds,this.latchedMinutes=e.latchedMinutes,this.latchedHours=e.latchedHours,this.latchedLDays=e.latchedDaysLow,this.latchedHDays=e.latchedDaysHigh,this.lastTime=e.lastTime}cutBatteryFileArray(t){return new Uint32Array(t.slice(this.mbc.ramSize,this.mbc.ramSize+48))}extract(t){const e=t[0],i=t[1],r=t[2],s=t[3],h=t[4],a=t[5],o=t[6],n=t[7],m=t[8],c=t[9],g=t[10],y=t[11];let l=g;return g&&y&&(l=y<<16|g),{seconds:e,minutes:i,hours:r,daysLow:s,daysHigh:h,latchedSeconds:a,latchedMinutes:o,latchedHours:n,latchedDaysLow:m,latchedDaysHigh:c,lastTime:1e3*l}}saveState(){return[this.lastTime,this.RTCisLatched,this.latchedSeconds,this.latchedMinutes,this.latchedHours,this.latchedLDays,this.latchedHDays,this.RTCSeconds,this.RTCMinutes,this.RTCHours,this.RTCDays,this.RTCDayOverFlow,this.RTCHalt]}loadState(t){let e=0;this.lastTime=t[e++],this.RTCisLatched=t[e++],this.latchedSeconds=t[e++],this.latchedMinutes=t[e++],this.latchedHours=t[e++],this.latchedLDays=t[e++],this.latchedHDays=t[e++],this.RTCSeconds=t[e++],this.RTCMinutes=t[e++],this.RTCHours=t[e++],this.RTCDays=t[e++],this.RTCDayOverFlow=t[e++],this.RTCHalt=t[12]}updateClock(){const t=(new Date).getTime(),e=t-this.lastTime;if(this.lastTime=t,!this.RTCHalt)for(this.RTCSeconds+=e/1e3;this.RTCSeconds>=60;)this.RTCSeconds-=60,++this.RTCMinutes,this.RTCMinutes>=60&&(this.RTCMinutes-=60,++this.RTCHours,this.RTCHours>=24&&(this.RTCHours-=24,++this.RTCDays,this.RTCDays>=512&&(this.RTCDays-=512,this.RTCDayOverFlow=!0)))}}class J extends q{constructor(t){super(t),this.writeRomBank=(t,e)=>{this.romBank1Offset=127&e,this.setCurrentROMBank()},this.writeRamBank=(t,e)=>{this.currentMbcRamBank=e,e<4&&(this.currentRamBankPosition=(this.currentMbcRamBank<<13)-40960)},this.writeHuc3RamBank=(t,e)=>{this.cartridge.mbc.currentMbcRamBank=3&e,this.cartridge.mbc.currentRamBankPosition=(this.cartridge.mbc.currentMbcRamBank<<13)-40960},this.writeRam=(t,e)=>{if(this.ramBanksEnabled)switch(this.currentMbcRamBank){case 0:case 1:case 2:case 3:this.emit("ramWrite"),this.ram[t+this.currentRamBankPosition]=e;break;case 8:this.rtc?.writeSeconds(e);break;case 9:this.rtc?.writeMinutes(e);break;case 10:this.rtc?.writeHours(e);break;case 11:this.rtc?.writeDaysLow(e);break;case 12:this.rtc?.writeDaysHigh(e);break;default:console.log("Invalid MBC3 bank address selected: "+this.currentMbcRamBank)}},this.readRam=t=>{if(!this.ramBanksEnabled)return 255;switch(this.currentMbcRamBank){case 0:case 1:case 2:case 3:return this.ram[t+this.currentRamBankPosition];case 8:if(this.rtc)return this.rtc.readSeconds();break;case 9:if(this.rtc)return this.rtc.readMinutes();break;case 10:if(this.rtc)return this.rtc.readHours();break;case 11:if(this.rtc)return this.rtc.readDaysLow();break;case 12:if(this.rtc)return this.rtc.readDaysHigh()}},this.rtc=new z(this)}}class U extends q{constructor(){super(...arguments),this.writRomBank=(t,e)=>{this.romBank1Offset=256&this.romBank1Offset|e,this.setCurrentROMBank()},this.writeHighRomBank=(t,e)=>{this.romBank1Offset=(1&e)<<8|255&this.romBank1Offset,this.setCurrentROMBank()},this.writeRamBank=(t,e)=>{this.currentMbcRamBank=15&e,this.currentRamBankPosition=(this.currentMbcRamBank<<13)-40960}}setCurrentROMBank(){this.currentRomBank=this.romBank1Offset%this.romBankEdge-1<<14}}class X extends q{constructor(){super(...arguments),this.highX=127,this.lowX=127,this.highY=127,this.lowY=127}applyGyroEvent(t,e){t*=-100,t+=2047,this.highX=t>>8,this.lowX=255&t,e*=-100,e+=2047,this.highY=e>>8,this.lowY=255&e}read(t){if(!this.ramBanksEnabled)return 255;switch(t){case 40960:case 41056:case 41072:case 41088:return 0;case 41040:return this.highY;case 41024:return this.lowY;case 41008:return this.highX;case 40992:return this.lowX;default:return this.ram[t+this.currentRamBankPosition]}}}class Y extends U{constructor(){super(...arguments),this.writeRamBank=(t,e)=>{8&e&&this.emit("rumble"),e&=7,super.writeRamBank(t,e)}}}const j="Game and Watch 50";class Q{constructor(t){this.hasMbc1=!1,this.hasMbc2=!1,this.hasMbc3=!1,this.hasMbc5=!1,this.hasMbc7=!1,this.hasRam=!1,this.hasRumble=!1,this.hasCamera=!1,this.hasTama5=!1,this.hasHuc3=!1,this.hasHuc1=!1,this.hasMmmO1=!1,this.hasRtc=!1,this.hasBattery=!1,this.rom=t instanceof p?t:new p(t)}connect(t){this.gameboy=t}disconnect(){this.gameboy=void 0}interpret(){if(this.name=this.rom.getString(308,318),this.gameCode=this.rom.getString(319,322),this.colorCompatibilityByte=this.rom.getByte(323),this.type=this.rom.getByte(327),this.setTypeName(),this.name&&console.log("Game Title: "+this.name),this.gameCode&&console.log("Game Code: "+this.gameCode),this.colorCompatibilityByte&&console.log("Color Compatibility Byte: "+this.colorCompatibilityByte),this.type&&console.log("Cartridge Type: "+this.type),this.typeName&&console.log("Cartridge Type Name: "+this.typeName),this.romSizeType=this.rom.getByte(328),this.ramSizeType=this.rom.getByte(329),this.gameboy.usedBootRom)console.log("used boot rom"),this.useGbcMode=this.gameboy.usedGbcBootRom;else switch(this.colorCompatibilityByte){case 0:this.useGbcMode=!1;break;case 50:this.name+this.gameCode+this.colorCompatibilityByte!==j?this.useGbcMode=!1:(this.useGbcMode=!0,console.log("Created a boot exception for Game and Watch Gallery 2 (GBC ID byte is wrong on the cartridge)."));break;case 128:case 192:this.useGbcMode=!0;break;default:this.useGbcMode=!1,console.warn("Unknown GameBoy game type code #"+this.colorCompatibilityByte+", defaulting to GB mode (Old games don't have a type code).")}const t=this.rom.getByte(331),e=65280&this.rom.getByte(324)|255&this.rom.getByte(325);51!==t?(this.hasNewLicenseCode=!1,this.licenseCode=t):(this.hasNewLicenseCode=!0,this.licenseCode=e)}setGbcMode(t){this.useGbcMode=0==(1&t),this.name+this.gameCode+this.colorCompatibilityByte===j&&(this.useGbcMode=!0,console.log("Created a boot exception for Game and Watch Gallery 2 (GBC ID byte is wrong on the cartridge).")),console.log("Booted to GBC Mode: "+this.useGbcMode)}setTypeName(){switch(this.type){case 0:this.typeName="ROM";break;case 1:this.hasMbc1=!0,this.typeName="MBC1";break;case 2:this.hasMbc1=!0,this.hasRam=!0,this.typeName="MBC1 + SRAM";break;case 3:this.hasMbc1=!0,this.hasRam=!0,this.hasBattery=!0,this.typeName="MBC1 + SRAM + Battery";break;case 5:this.hasMbc2=!0,this.typeName="MBC2";break;case 6:this.hasMbc2=!0,this.hasBattery=!0,this.typeName="MBC2 + Battery";break;case 8:this.hasRam=!0,this.typeName="ROM + SRAM";break;case 9:this.hasRam=!0,this.hasBattery=!0,this.typeName="ROM + SRAM + Battery";break;case 11:this.hasMmmO1=!0,this.typeName="MMMO1";break;case 12:this.hasMmmO1=!0,this.hasRam=!0,this.typeName="MMMO1 + SRAM";break;case 13:this.hasMmmO1=!0,this.hasRam=!0,this.hasBattery=!0,this.typeName="MMMO1 + SRAM + Battery";break;case 15:this.hasMbc3=!0,this.hasRtc=!0,this.hasBattery=!0,this.typeName="MBC3 + RTC + Battery";break;case 16:this.hasMbc3=!0,this.hasRtc=!0,this.hasBattery=!0,this.hasRam=!0,this.typeName="MBC3 + RTC + Battery + SRAM";break;case 17:this.hasMbc3=!0,this.typeName="MBC3";break;case 18:this.hasMbc3=!0,this.hasRam=!0,this.typeName="MBC3 + SRAM";break;case 19:this.hasMbc3=!0,this.hasRam=!0,this.hasBattery=!0,this.typeName="MBC3 + SRAM + Battery";break;case 25:this.hasMbc5=!0,this.typeName="MBC5";break;case 26:this.hasMbc5=!0,this.hasRam=!0,this.typeName="MBC5 + SRAM";break;case 27:this.hasMbc5=!0,this.hasRam=!0,this.hasBattery=!0,this.typeName="MBC5 + SRAM + Battery";break;case 28:this.hasRumble=!0,this.typeName="RUMBLE";break;case 29:this.hasRumble=!0,this.hasRam=!0,this.typeName="RUMBLE + SRAM";break;case 30:this.hasRumble=!0,this.hasRam=!0,this.hasBattery=!0,this.typeName="RUMBLE + SRAM + Battery";break;case 31:this.hasCamera=!0,this.typeName="GameBoy Camera";break;case 34:this.hasMbc7=!0,this.hasRam=!0,this.hasBattery=!0,this.typeName="MBC7 + SRAM + Battery";break;case 253:this.hasTama5=!0,this.typeName="TAMA5";break;case 254:this.hasHuc3=!0,this.typeName="HuC3";break;case 255:this.hasHuc1=!0,this.typeName="HuC1";break;default:throw new Error("Unknown Cartridge Type")}this.hasMbc1&&(this.mbc1=new V(this)),this.hasMbc2&&(this.mbc2=new N(this)),this.hasMbc3&&(this.mbc3=new J(this)),this.hasMbc5&&(this.mbc5=new U(this)),this.hasMbc7&&(this.mbc7=new X(this)),this.hasRumble&&(this.mbc5=this.rumble=new Y(this)),this.mbc=this.mbc1||this.mbc2||this.mbc3||this.mbc5||this.mbc7||this.rumble||void 0}setupRAM(){this.mbc&&this.mbc.setupRAM(),this.gameboy.loadRam(),this.gameboy.loadRtc()}}const _=154;class K{constructor(t){this.gameboy=t,this.lcdEnabled=!1,this.scanlineProcessors=[],this.renderGbcSpriteLayer=t=>{if(this.gameboy.gfxSpriteShow){var e=65024,i=t+16,r=0,s=0,h=0,a=0,o=0,n=0,m=null,c=0,g=0,y=0;if(this.gameboy.gfxSpriteNormalHeight){for(;e<65184&&y<10;e+=4)if((7&(r=i-this.gameboy.memory[e]))===r){for(s=this.gameboy.memory[1|e]-8,h=Math.min(160,s+8),n=(7&(o=this.gameboy.memory[3|e]))<<2,m=this.gameboy.tileCache[(8&o)<<8|(96&o)<<4|this.gameboy.memory[2|e]],a=s>0?s:0,s-=r<<3,g=this.gameboy.pixelStart+a;a<h;++a,++g)this.gameboy.frameBuffer[g]>=33554432?(c=m[a-s])>0&&(this.gameboy.frameBuffer[g]=this.gameboy.gbcOBJPalette[n|c]):this.gameboy.frameBuffer[g]<16777216&&(c=m[a-s])>0&&o<128&&(this.gameboy.frameBuffer[g]=this.gameboy.gbcOBJPalette[n|c]);++y}}else for(;e<65184&&y<10;e+=4)if((15&(r=i-this.gameboy.memory[e]))===r){for(s=this.gameboy.memory[1|e]-8,h=Math.min(160,s+8),n=(7&(o=this.gameboy.memory[3|e]))<<2,m=(64&o)==(64&r<<3)?this.gameboy.tileCache[(8&o)<<8|(96&o)<<4|254&this.gameboy.memory[2|e]]:this.gameboy.tileCache[(8&o)<<8|(96&o)<<4|this.gameboy.memory[2|e]|1],a=s>0?s:0,s-=(7&r)<<3,g=this.gameboy.pixelStart+a;a<h;++a,++g)this.gameboy.frameBuffer[g]>=33554432?(c=m[a-s])>0&&(this.gameboy.frameBuffer[g]=this.gameboy.gbcOBJPalette[n|c]):this.gameboy.frameBuffer[g]<16777216&&(c=m[a-s])>0&&o<128&&(this.gameboy.frameBuffer[g]=this.gameboy.gbcOBJPalette[n|c]);++y}}},this.renderGbBackgroundLayer=t=>{var e=this.gameboy.backgroundY+t&255,i=(7&e)<<3,r=this.gameboy.gfxBackgroundCHRBankPosition|(248&e)<<2,s=this.gameboy.backgroundX+this.gameboy.currentX&255,h=this.gameboy.pixelStart+this.gameboy.currentX,a=this.gameboy.pixelStart+(this.gameboy.gfxWindowDisplay&&t-this.gameboy.windowY>=0?Math.min(Math.max(this.gameboy.windowX,0)+this.gameboy.currentX,this.gameboy.pixelEnd):this.gameboy.pixelEnd),o=r+(s>>3),n=this.gameboy.BGCHRBank1[o];n<this.gameboy.gfxBackgroundBankOffset&&(n|=256);for(var m=this.gameboy.tileCache[n],c=7&s;c<8&&h<a&&s<256;++s)this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[i|c++]];var g=Math.min(a-h,256-s)>>3;for(s+=g<<3,g+=o;o<g;)(n=this.gameboy.BGCHRBank1[++o])<this.gameboy.gfxBackgroundBankOffset&&(n|=256),m=this.gameboy.tileCache[n],c=i,this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[c++]],this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[c++]],this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[c++]],this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[c++]],this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[c++]],this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[c++]],this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[c++]],this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[c]];if(h<a){if(s<256)for((n=this.gameboy.BGCHRBank1[++o])<this.gameboy.gfxBackgroundBankOffset&&(n|=256),m=this.gameboy.tileCache[n],c=i-1;h<a&&s<256;++s)this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[++c]];for(g=(a-h>>3)+r;r<g;)(n=this.gameboy.BGCHRBank1[r++])<this.gameboy.gfxBackgroundBankOffset&&(n|=256),m=this.gameboy.tileCache[n],c=i,this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[c++]],this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[c++]],this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[c++]],this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[c++]],this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[c++]],this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[c++]],this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[c++]],this.gameboy.frameBuffer[h++]=this.gameboy.backgroundPalette[m[c]];if(h<a)switch((n=this.gameboy.BGCHRBank1[r])<this.gameboy.gfxBackgroundBankOffset&&(n|=256),m=this.gameboy.tileCache[n],a-h){case 7:this.gameboy.frameBuffer[h+6]=this.gameboy.backgroundPalette[m[6|i]];case 6:this.gameboy.frameBuffer[h+5]=this.gameboy.backgroundPalette[m[5|i]];case 5:this.gameboy.frameBuffer[h+4]=this.gameboy.backgroundPalette[m[4|i]];case 4:this.gameboy.frameBuffer[h+3]=this.gameboy.backgroundPalette[m[3|i]];case 3:this.gameboy.frameBuffer[h+2]=this.gameboy.backgroundPalette[m[2|i]];case 2:this.gameboy.frameBuffer[h+1]=this.gameboy.backgroundPalette[m[1|i]];case 1:this.gameboy.frameBuffer[h]=this.gameboy.backgroundPalette[m[i]]}}},this.renderGbWindowLayer=t=>{if(this.gameboy.gfxWindowDisplay){var e=t-this.gameboy.windowY;if(e>=0){var i=this.gameboy.windowX>0?this.gameboy.windowX+this.gameboy.currentX:this.gameboy.currentX,r=this.gameboy.pixelStart+i,s=this.gameboy.pixelStart+this.gameboy.pixelEnd;if(r<s){var h=(7&e)<<3,a=(this.gameboy.gfxWindowCHRBankPosition|(248&e)<<2)+(this.gameboy.currentX>>3),o=this.gameboy.BGCHRBank1[a];o<this.gameboy.gfxBackgroundBankOffset&&(o|=256);var n=this.gameboy.tileCache[o],m=i-this.gameboy.windowX&7;for(i=Math.min(8,m+s-r);m<i;)this.gameboy.frameBuffer[r++]=this.gameboy.backgroundPalette[n[h|m++]];for(i=a+(s-r>>3);a<i;)(o=this.gameboy.BGCHRBank1[++a])<this.gameboy.gfxBackgroundBankOffset&&(o|=256),n=this.gameboy.tileCache[o],m=h,this.gameboy.frameBuffer[r++]=this.gameboy.backgroundPalette[n[m++]],this.gameboy.frameBuffer[r++]=this.gameboy.backgroundPalette[n[m++]],this.gameboy.frameBuffer[r++]=this.gameboy.backgroundPalette[n[m++]],this.gameboy.frameBuffer[r++]=this.gameboy.backgroundPalette[n[m++]],this.gameboy.frameBuffer[r++]=this.gameboy.backgroundPalette[n[m++]],this.gameboy.frameBuffer[r++]=this.gameboy.backgroundPalette[n[m++]],this.gameboy.frameBuffer[r++]=this.gameboy.backgroundPalette[n[m++]],this.gameboy.frameBuffer[r++]=this.gameboy.backgroundPalette[n[m]];if(r<s)switch((o=this.gameboy.BGCHRBank1[++a])<this.gameboy.gfxBackgroundBankOffset&&(o|=256),n=this.gameboy.tileCache[o],s-r){case 7:this.gameboy.frameBuffer[r+6]=this.gameboy.backgroundPalette[n[6|h]];case 6:this.gameboy.frameBuffer[r+5]=this.gameboy.backgroundPalette[n[5|h]];case 5:this.gameboy.frameBuffer[r+4]=this.gameboy.backgroundPalette[n[4|h]];case 4:this.gameboy.frameBuffer[r+3]=this.gameboy.backgroundPalette[n[3|h]];case 3:this.gameboy.frameBuffer[r+2]=this.gameboy.backgroundPalette[n[2|h]];case 2:this.gameboy.frameBuffer[r+1]=this.gameboy.backgroundPalette[n[1|h]];case 1:this.gameboy.frameBuffer[r]=this.gameboy.backgroundPalette[n[h]]}}}}},this.renderGbSpriteLayer=t=>{if(!this.gameboy.gfxSpriteShow)return;const e=t+16;let i=65024,r=0,s=1,h=0,a=0,o=0,n=0,m=null,c=0,g=0,y=0,l=0;for(;s<168;)this.gameboy.sortBuffer[s++]=255;if(this.gameboy.gfxSpriteNormalHeight)for(let t=this.gameboy.findLowestSpriteDrawable(e,7);g<t;++g)for(i=this.gameboy.OAMAddressCache[g],r=e-this.gameboy.memory[i]<<3,o=this.gameboy.memory[3|i],n=(16&o)>>2,m=this.gameboy.tileCache[(96&o)<<4|this.gameboy.memory[2|i]],l=h=this.gameboy.memory[1|i],a=Math.min(168-l,8),s=l>7?0:8-l,y=this.gameboy.pixelStart+(l>8?l-8:0);s<a;++s,++y,++l)this.gameboy.sortBuffer[l]>h&&(this.gameboy.frameBuffer[y]>=33554432?(c=m[r|s],c>0&&(this.gameboy.frameBuffer[y]=this.gameboy.OBJPalette[n|c],this.gameboy.sortBuffer[l]=h)):this.gameboy.frameBuffer[y]<16777216&&(c=m[r|s],c>0&&o<128&&(this.gameboy.frameBuffer[y]=this.gameboy.OBJPalette[n|c],this.gameboy.sortBuffer[l]=h)));else for(let t=this.gameboy.findLowestSpriteDrawable(e,15);g<t;++g)for(i=this.gameboy.OAMAddressCache[g],r=e-this.gameboy.memory[i]<<3,o=this.gameboy.memory[3|i],n=(16&o)>>2,m=(64&o)==(64&r)?this.gameboy.tileCache[(96&o)<<4|254&this.gameboy.memory[2|i]]:this.gameboy.tileCache[(96&o)<<4|this.gameboy.memory[2|i]|1],r&=63,l=h=this.gameboy.memory[1|i],a=Math.min(168-l,8),s=l>7?0:8-l,y=this.gameboy.pixelStart+(l>8?l-8:0);s<a;++s,++y,++l)this.gameboy.sortBuffer[l]>h&&(this.gameboy.frameBuffer[y]>=33554432?(c=m[r|s],c>0&&(this.gameboy.frameBuffer[y]=this.gameboy.OBJPalette[n|c],this.gameboy.sortBuffer[l]=h)):this.gameboy.frameBuffer[y]<16777216&&(c=m[r|s],c>0&&o<128&&(this.gameboy.frameBuffer[y]=this.gameboy.OBJPalette[n|c],this.gameboy.sortBuffer[l]=h)))},this.runVisibleScanline=()=>{this.gameboy.LCDTicks<80?this.gameboy.scanLineMode2():this.gameboy.LCDTicks<252?this.gameboy.scanLineMode3():this.gameboy.LCDTicks<456?this.gameboy.scanLineMode0():(this.gameboy.LCDTicks-=456,3!==this.gameboy.STATTracker&&(2!==this.gameboy.STATTracker&&(0===this.gameboy.STATTracker&&this.gameboy.mode2TriggerSTAT&&(this.gameboy.interruptRequestedFlags|=2),this.gameboy.incrementScanlineQueue()),this.gameboy.hdmaRunning&&this.gameboy.executeHDMA(),this.gameboy.mode0TriggerSTAT&&(this.gameboy.interruptRequestedFlags|=2)),this.gameboy.actualScanline=++this.gameboy.memory[65348],this.gameboy.actualScanline===this.gameboy.memory[65349]?(this.gameboy.memory[65345]|=4,this.gameboy.LYCMatchTriggerSTAT&&(this.gameboy.interruptRequestedFlags|=2)):this.gameboy.memory[65345]&=123,this.gameboy.checkIrqMatching(),this.gameboy.STATTracker=0,this.gameboy.modeSTAT=2,this.scanlineProcessors[this.gameboy.actualScanline]())},this.runLastVisibleScanline=()=>{this.gameboy.LCDTicks<80?this.gameboy.scanLineMode2():this.gameboy.LCDTicks<252?this.gameboy.scanLineMode3():this.gameboy.LCDTicks<456?this.gameboy.scanLineMode0():(this.gameboy.LCDTicks-=456,3!==this.gameboy.STATTracker&&(2!==this.gameboy.STATTracker&&(0===this.gameboy.STATTracker&&this.gameboy.mode2TriggerSTAT&&(this.gameboy.interruptRequestedFlags|=2),this.gameboy.incrementScanlineQueue()),this.gameboy.hdmaRunning&&this.gameboy.executeHDMA(),this.gameboy.mode0TriggerSTAT&&(this.gameboy.interruptRequestedFlags|=2)),this.gameboy.actualScanline=this.gameboy.memory[65348]=144,144===this.gameboy.memory[65349]?(this.gameboy.memory[65345]|=4,this.gameboy.LYCMatchTriggerSTAT&&(this.gameboy.interruptRequestedFlags|=2)):this.gameboy.memory[65345]&=123,this.gameboy.STATTracker=0,this.gameboy.modeSTAT=1,this.gameboy.interruptRequestedFlags|=this.gameboy.mode1TriggerSTAT?3:1,this.gameboy.checkIrqMatching(),0===this.gameboy.drewBlank?(this.gameboy.cpu.totalLinesPassed<144||144===this.gameboy.cpu.totalLinesPassed&&this.gameboy.midScanlineOffset>-1)&&(this.gameboy.graphicsJITVBlank(),this.gameboy.lcdDevice.outputFrameBuffer()):--this.gameboy.drewBlank,this.scanlineProcessors[144]())},this.runVBlankScanline=()=>{this.gameboy.LCDTicks>=456&&(this.gameboy.LCDTicks-=456,this.gameboy.actualScanline=++this.gameboy.memory[65348],this.gameboy.actualScanline===this.gameboy.memory[65349]?(this.gameboy.memory[65345]|=4,this.gameboy.LYCMatchTriggerSTAT&&(this.gameboy.interruptRequestedFlags|=2,this.gameboy.checkIrqMatching())):this.gameboy.memory[65345]&=123,this.scanlineProcessors[this.gameboy.actualScanline]())},this.runLastVBlankScanline=()=>{this.gameboy.LCDTicks>=8&&(4!==this.gameboy.STATTracker&&153===this.gameboy.memory[65348]&&(this.gameboy.memory[65348]=0,0===this.gameboy.memory[65349]?(this.gameboy.memory[65345]|=4,this.gameboy.LYCMatchTriggerSTAT&&(this.gameboy.interruptRequestedFlags|=2,this.gameboy.checkIrqMatching())):this.gameboy.memory[65345]&=123,this.gameboy.STATTracker=4),this.gameboy.LCDTicks>=456&&(this.gameboy.LCDTicks-=456,this.gameboy.STATTracker=this.gameboy.actualScanline=0,this.scanlineProcessors[0]()))},this.disableLCD()}initRenderer(){this.gameboy.cartridge.useGbcMode?(this.gameboy.hasBackgroundPriority?(this.renderBackgroundLayer=this.renderGbcBackgroundLayer,this.renderWindowLayer=this.renderGbcWindowLayer):(this.renderBackgroundLayer=this.renderGbcBackgroundLayerWithoutPriorityFlagging,this.renderWindowLayer=this.renderGbcWindowLayerWithoutPriorityFlagging),this.renderSpriteLayer=this.renderGbcSpriteLayer):(this.renderBackgroundLayer=this.renderGbBackgroundLayer,this.renderWindowLayer=this.renderGbWindowLayer,this.renderSpriteLayer=this.renderGbSpriteLayer)}renderGbcBackgroundLayerWithoutPriorityFlagging(t){var e=this.gameboy.backgroundY+t&255,i=(7&e)<<3,r=this.gameboy.gfxBackgroundCHRBankPosition|(248&e)<<2,s=this.gameboy.backgroundX+this.gameboy.currentX&255,h=this.gameboy.pixelStart+this.gameboy.currentX,a=this.gameboy.pixelStart+(this.gameboy.gfxWindowDisplay&&t-this.gameboy.windowY>=0?Math.min(Math.max(this.gameboy.windowX,0)+this.gameboy.currentX,this.gameboy.pixelEnd):this.gameboy.pixelEnd),o=r+(s>>3),n=this.gameboy.BGCHRBank1[o];n<this.gameboy.gfxBackgroundBankOffset&&(n|=256);for(var m=this.gameboy.BGCHRBank2[o],c=this.gameboy.tileCache[(8&m)<<8|(96&m)<<4|n],g=(7&m)<<2,y=7&s;y<8&&h<a&&s<256;++s)this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[i|y++]];var l=Math.min(a-h,256-s)>>3;for(s+=l<<3,l+=o;o<l;)(n=this.gameboy.BGCHRBank1[++o])<this.gameboy.gfxBackgroundBankOffset&&(n|=256),m=this.gameboy.BGCHRBank2[o],c=this.gameboy.tileCache[(8&m)<<8|(96&m)<<4|n],g=(7&m)<<2,y=i,this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y]];if(h<a){if(s<256)for((n=this.gameboy.BGCHRBank1[++o])<this.gameboy.gfxBackgroundBankOffset&&(n|=256),m=this.gameboy.BGCHRBank2[o],c=this.gameboy.tileCache[(8&m)<<8|(96&m)<<4|n],g=(7&m)<<2,y=i-1;h<a&&s<256;++s)this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[++y]];for(l=(a-h>>3)+r;r<l;)(n=this.gameboy.BGCHRBank1[r])<this.gameboy.gfxBackgroundBankOffset&&(n|=256),m=this.gameboy.BGCHRBank2[r++],c=this.gameboy.tileCache[(8&m)<<8|(96&m)<<4|n],g=(7&m)<<2,y=i,this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y]];if(h<a)switch((n=this.gameboy.BGCHRBank1[r])<this.gameboy.gfxBackgroundBankOffset&&(n|=256),m=this.gameboy.BGCHRBank2[r],c=this.gameboy.tileCache[(8&m)<<8|(96&m)<<4|n],g=(7&m)<<2,a-h){case 7:this.gameboy.frameBuffer[h+6]=this.gameboy.gbcBGPalette[g|c[6|i]];case 6:this.gameboy.frameBuffer[h+5]=this.gameboy.gbcBGPalette[g|c[5|i]];case 5:this.gameboy.frameBuffer[h+4]=this.gameboy.gbcBGPalette[g|c[4|i]];case 4:this.gameboy.frameBuffer[h+3]=this.gameboy.gbcBGPalette[g|c[3|i]];case 3:this.gameboy.frameBuffer[h+2]=this.gameboy.gbcBGPalette[g|c[2|i]];case 2:this.gameboy.frameBuffer[h+1]=this.gameboy.gbcBGPalette[g|c[1|i]];case 1:this.gameboy.frameBuffer[h]=this.gameboy.gbcBGPalette[g|c[i]]}}}renderGbcWindowLayer(t){if(this.gameboy.gfxWindowDisplay){var e=t-this.gameboy.windowY;if(e>=0){var i=this.gameboy.windowX>0?this.gameboy.windowX+this.gameboy.currentX:this.gameboy.currentX,r=this.gameboy.pixelStart+i,s=this.gameboy.pixelStart+this.gameboy.pixelEnd;if(r<s){var h=(7&e)<<3,a=(this.gameboy.gfxWindowCHRBankPosition|(248&e)<<2)+(this.gameboy.currentX>>3),o=this.gameboy.BGCHRBank1[a];o<this.gameboy.gfxBackgroundBankOffset&&(o|=256);var n=this.gameboy.BGCHRBank2[a],m=this.gameboy.tileCache[(8&n)<<8|(96&n)<<4|o],c=(7&n)<<2|(128&n)>>2,g=i-this.gameboy.windowX&7;for(i=Math.min(8,g+s-r);g<i;)this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[h|g++]];for(i=a+(s-r>>3);a<i;)(o=this.gameboy.BGCHRBank1[++a])<this.gameboy.gfxBackgroundBankOffset&&(o|=256),n=this.gameboy.BGCHRBank2[a],m=this.gameboy.tileCache[(8&n)<<8|(96&n)<<4|o],c=(7&n)<<2|(128&n)>>2,g=h,this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[g++]],this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[g++]],this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[g++]],this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[g++]],this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[g++]],this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[g++]],this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[g++]],this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[g]];if(r<s)switch((o=this.gameboy.BGCHRBank1[++a])<this.gameboy.gfxBackgroundBankOffset&&(o|=256),n=this.gameboy.BGCHRBank2[a],m=this.gameboy.tileCache[(8&n)<<8|(96&n)<<4|o],c=(7&n)<<2|(128&n)>>2,s-r){case 7:this.gameboy.frameBuffer[r+6]=this.gameboy.gbcBGPalette[c|m[6|h]];case 6:this.gameboy.frameBuffer[r+5]=this.gameboy.gbcBGPalette[c|m[5|h]];case 5:this.gameboy.frameBuffer[r+4]=this.gameboy.gbcBGPalette[c|m[4|h]];case 4:this.gameboy.frameBuffer[r+3]=this.gameboy.gbcBGPalette[c|m[3|h]];case 3:this.gameboy.frameBuffer[r+2]=this.gameboy.gbcBGPalette[c|m[2|h]];case 2:this.gameboy.frameBuffer[r+1]=this.gameboy.gbcBGPalette[c|m[1|h]];case 1:this.gameboy.frameBuffer[r]=this.gameboy.gbcBGPalette[c|m[h]]}}}}}renderGbcWindowLayerWithoutPriorityFlagging(t){if(this.gameboy.gfxWindowDisplay){var e=t-this.gameboy.windowY;if(e>=0){var i=this.gameboy.windowX>0?this.gameboy.windowX+this.gameboy.currentX:this.gameboy.currentX,r=this.gameboy.pixelStart+i,s=this.gameboy.pixelStart+this.gameboy.pixelEnd;if(r<s){var h=(7&e)<<3,a=(this.gameboy.gfxWindowCHRBankPosition|(248&e)<<2)+(this.gameboy.currentX>>3),o=this.gameboy.BGCHRBank1[a];o<this.gameboy.gfxBackgroundBankOffset&&(o|=256);var n=this.gameboy.BGCHRBank2[a],m=this.gameboy.tileCache[(8&n)<<8|(96&n)<<4|o],c=(7&n)<<2,g=i-this.gameboy.windowX&7;for(i=Math.min(8,g+s-r);g<i;)this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[h|g++]];for(i=a+(s-r>>3);a<i;)(o=this.gameboy.BGCHRBank1[++a])<this.gameboy.gfxBackgroundBankOffset&&(o|=256),n=this.gameboy.BGCHRBank2[a],m=this.gameboy.tileCache[(8&n)<<8|(96&n)<<4|o],c=(7&n)<<2,g=h,this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[g++]],this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[g++]],this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[g++]],this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[g++]],this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[g++]],this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[g++]],this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[g++]],this.gameboy.frameBuffer[r++]=this.gameboy.gbcBGPalette[c|m[g]];if(r<s)switch((o=this.gameboy.BGCHRBank1[++a])<this.gameboy.gfxBackgroundBankOffset&&(o|=256),n=this.gameboy.BGCHRBank2[a],m=this.gameboy.tileCache[(8&n)<<8|(96&n)<<4|o],c=(7&n)<<2,s-r){case 7:this.gameboy.frameBuffer[r+6]=this.gameboy.gbcBGPalette[c|m[6|h]];case 6:this.gameboy.frameBuffer[r+5]=this.gameboy.gbcBGPalette[c|m[5|h]];case 5:this.gameboy.frameBuffer[r+4]=this.gameboy.gbcBGPalette[c|m[4|h]];case 4:this.gameboy.frameBuffer[r+3]=this.gameboy.gbcBGPalette[c|m[3|h]];case 3:this.gameboy.frameBuffer[r+2]=this.gameboy.gbcBGPalette[c|m[2|h]];case 2:this.gameboy.frameBuffer[r+1]=this.gameboy.gbcBGPalette[c|m[1|h]];case 1:this.gameboy.frameBuffer[r]=this.gameboy.gbcBGPalette[c|m[h]]}}}}}renderGbcBackgroundLayer(t){var e=this.gameboy.backgroundY+t&255,i=(7&e)<<3,r=this.gameboy.gfxBackgroundCHRBankPosition|(248&e)<<2,s=this.gameboy.backgroundX+this.gameboy.currentX&255,h=this.gameboy.pixelStart+this.gameboy.currentX,a=this.gameboy.pixelStart+(this.gameboy.gfxWindowDisplay&&t-this.gameboy.windowY>=0?Math.min(Math.max(this.gameboy.windowX,0)+this.gameboy.currentX,this.gameboy.pixelEnd):this.gameboy.pixelEnd),o=r+(s>>3),n=this.gameboy.BGCHRBank1[o];n<this.gameboy.gfxBackgroundBankOffset&&(n|=256);for(var m=this.gameboy.BGCHRBank2[o],c=this.gameboy.tileCache[(8&m)<<8|(96&m)<<4|n],g=(7&m)<<2|(128&m)>>2,y=7&s;y<8&&h<a&&s<256;++s)this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[i|y++]];var l=Math.min(a-h,256-s)>>3;for(s+=l<<3,l+=o;o<l;)(n=this.gameboy.BGCHRBank1[++o])<this.gameboy.gfxBackgroundBankOffset&&(n|=256),m=this.gameboy.BGCHRBank2[o],c=this.gameboy.tileCache[(8&m)<<8|(96&m)<<4|n],g=(7&m)<<2|(128&m)>>2,y=i,this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y]];if(h<a){if(s<256)for((n=this.gameboy.BGCHRBank1[++o])<this.gameboy.gfxBackgroundBankOffset&&(n|=256),m=this.gameboy.BGCHRBank2[o],c=this.gameboy.tileCache[(8&m)<<8|(96&m)<<4|n],g=(7&m)<<2|(128&m)>>2,y=i-1;h<a&&s<256;++s)this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[++y]];for(l=(a-h>>3)+r;r<l;)(n=this.gameboy.BGCHRBank1[r])<this.gameboy.gfxBackgroundBankOffset&&(n|=256),m=this.gameboy.BGCHRBank2[r++],c=this.gameboy.tileCache[(8&m)<<8|(96&m)<<4|n],g=(7&m)<<2|(128&m)>>2,y=i,this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y++]],this.gameboy.frameBuffer[h++]=this.gameboy.gbcBGPalette[g|c[y]];if(h<a)switch((n=this.gameboy.BGCHRBank1[r])<this.gameboy.gfxBackgroundBankOffset&&(n|=256),m=this.gameboy.BGCHRBank2[r],c=this.gameboy.tileCache[(8&m)<<8|(96&m)<<4|n],g=(7&m)<<2|(128&m)>>2,a-h){case 7:this.gameboy.frameBuffer[h+6]=this.gameboy.gbcBGPalette[g|c[6|i]];case 6:this.gameboy.frameBuffer[h+5]=this.gameboy.gbcBGPalette[g|c[5|i]];case 5:this.gameboy.frameBuffer[h+4]=this.gameboy.gbcBGPalette[g|c[4|i]];case 4:this.gameboy.frameBuffer[h+3]=this.gameboy.gbcBGPalette[g|c[3|i]];case 3:this.gameboy.frameBuffer[h+2]=this.gameboy.gbcBGPalette[g|c[2|i]];case 2:this.gameboy.frameBuffer[h+1]=this.gameboy.gbcBGPalette[g|c[1|i]];case 1:this.gameboy.frameBuffer[h]=this.gameboy.gbcBGPalette[g|c[i]]}}}runScanline(t){this.scanlineProcessors[t]()}disableLCD(){for(let t=0;t<_;++t)this.scanlineProcessors[t]=()=>{};this.lcdEnabled=!1}enableLCD(){for(let t=0;t<_;++t)t<143?this.scanlineProcessors[t]=this.runVisibleScanline:143===t?this.scanlineProcessors[143]=this.runLastVisibleScanline:t<153?this.scanlineProcessors[t]=this.runVBlankScanline:this.scanlineProcessors[153]=this.runLastVBlankScanline;this.lcdEnabled=!0}}const $=[15,0,124,255,0,0,0,248,255,255,255,255,255,255,255,1,128,191,243,255,191,255,63,0,255,191,127,255,159,255,191,255,255,0,0,191,119,243,241,255,255,255,255,255,255,255,255,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,0,255,145,128,0,0,0,0,0,252,0,0,0,0,255,126,255,254,255,255,255,255,255,255,62,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,192,255,193,0,254,255,255,255,248,255,0,0,0,143,0,0,255,255,255,255,255,255,255,255,206,237,102,102,204,13,0,11,3,115,0,131,0,12,0,13,0,8,17,31,136,137,0,14,220,204,110,230,221,221,217,153,187,187,103,99,110,14,236,204,221,220,153,159,187,185,51,62,69,236,82,250,8,183,7,93,1,253,192,255,8,252,0,229,11,248,194,206,244,249,15,127,69,109,61,254,70,151,51,94,8,239,241,255,134,131,36,116,18,252,0,159,180,183,6,213,208,122,0,158,4,95,65,47,29,119,54,117,129,170,112,58,152,209,113,2,77,1,193,255,13,0,211,5,249,0,11,0],tt=[function(){this.FCarry=this.registerB>127,this.registerB=this.registerB<<1&255|(this.FCarry?1:0),this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerB},function(){this.FCarry=this.registerC>127,this.registerC=this.registerC<<1&255|(this.FCarry?1:0),this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerC},function(){this.FCarry=this.registerD>127,this.registerD=this.registerD<<1&255|(this.FCarry?1:0),this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerD},function(){this.FCarry=this.registerE>127,this.registerE=this.registerE<<1&255|(this.FCarry?1:0),this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerE},function(){this.FCarry=this.registersHL>32767,this.registersHL=this.registersHL<<1&65024|(this.FCarry?256:0)|255&this.registersHL,this.FHalfCarry=this.FSubtract=!1,this.FZero=this.registersHL<256},function(){this.FCarry=128==(128&this.registersHL),this.registersHL=65280&this.registersHL|this.registersHL<<1&255|(this.FCarry?1:0),this.FHalfCarry=this.FSubtract=!1,this.FZero=0==(255&this.registersHL)},function(){var t=this.readMemory(this.registersHL);this.FCarry=t>127,t=t<<1&255|(this.FCarry?1:0),this.memoryWriter[this.registersHL](this.registersHL,t),this.FHalfCarry=this.FSubtract=!1,this.FZero=0===t},function(){this.FCarry=this.registerA>127,this.registerA=this.registerA<<1&255|(this.FCarry?1:0),this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerA},function(){this.FCarry=1==(1&this.registerB),this.registerB=(this.FCarry?128:0)|this.registerB>>1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerB},function(){this.FCarry=1==(1&this.registerC),this.registerC=(this.FCarry?128:0)|this.registerC>>1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerC},function(){this.FCarry=1==(1&this.registerD),this.registerD=(this.FCarry?128:0)|this.registerD>>1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerD},function(){this.FCarry=1==(1&this.registerE),this.registerE=(this.FCarry?128:0)|this.registerE>>1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerE},function(){this.FCarry=256==(256&this.registersHL),this.registersHL=(this.FCarry?32768:0)|this.registersHL>>1&65280|255&this.registersHL,this.FHalfCarry=this.FSubtract=!1,this.FZero=this.registersHL<256},function(){this.FCarry=1==(1&this.registersHL),this.registersHL=65280&this.registersHL|(this.FCarry?128:0)|(255&this.registersHL)>>1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0==(255&this.registersHL)},function(){var t=this.readMemory(this.registersHL);this.FCarry=1==(1&t),t=(this.FCarry?128:0)|t>>1,this.memoryWriter[this.registersHL](this.registersHL,t),this.FHalfCarry=this.FSubtract=!1,this.FZero=0===t},function(){this.FCarry=1==(1&this.registerA),this.registerA=(this.FCarry?128:0)|this.registerA>>1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerA},function(){var t=this.registerB>127;this.registerB=this.registerB<<1&255|(this.FCarry?1:0),this.FCarry=t,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerB},function(){var t=this.registerC>127;this.registerC=this.registerC<<1&255|(this.FCarry?1:0),this.FCarry=t,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerC},function(){var t=this.registerD>127;this.registerD=this.registerD<<1&255|(this.FCarry?1:0),this.FCarry=t,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerD},function(){var t=this.registerE>127;this.registerE=this.registerE<<1&255|(this.FCarry?1:0),this.FCarry=t,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerE},function(){var t=this.registersHL>32767;this.registersHL=this.registersHL<<1&65024|(this.FCarry?256:0)|255&this.registersHL,this.FCarry=t,this.FHalfCarry=this.FSubtract=!1,this.FZero=this.registersHL<256},function(){var t=128==(128&this.registersHL);this.registersHL=65280&this.registersHL|this.registersHL<<1&255|(this.FCarry?1:0),this.FCarry=t,this.FHalfCarry=this.FSubtract=!1,this.FZero=0==(255&this.registersHL)},function(){var t=this.readMemory(this.registersHL),e=t>127;t=t<<1&255|(this.FCarry?1:0),this.FCarry=e,this.memoryWriter[this.registersHL](this.registersHL,t),this.FHalfCarry=this.FSubtract=!1,this.FZero=0===t},function(){var t=this.registerA>127;this.registerA=this.registerA<<1&255|(this.FCarry?1:0),this.FCarry=t,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerA},function(){var t=1==(1&this.registerB);this.registerB=(this.FCarry?128:0)|this.registerB>>1,this.FCarry=t,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerB},function(){var t=1==(1&this.registerC);this.registerC=(this.FCarry?128:0)|this.registerC>>1,this.FCarry=t,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerC},function(){var t=1==(1&this.registerD);this.registerD=(this.FCarry?128:0)|this.registerD>>1,this.FCarry=t,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerD},function(){var t=1==(1&this.registerE);this.registerE=(this.FCarry?128:0)|this.registerE>>1,this.FCarry=t,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerE},function(){var t=256==(256&this.registersHL);this.registersHL=(this.FCarry?32768:0)|this.registersHL>>1&65280|255&this.registersHL,this.FCarry=t,this.FHalfCarry=this.FSubtract=!1,this.FZero=this.registersHL<256},function(){var t=1==(1&this.registersHL);this.registersHL=65280&this.registersHL|(this.FCarry?128:0)|(255&this.registersHL)>>1,this.FCarry=t,this.FHalfCarry=this.FSubtract=!1,this.FZero=0==(255&this.registersHL)},function(){var t=this.readMemory(this.registersHL),e=1==(1&t);t=(this.FCarry?128:0)|t>>1,this.FCarry=e,this.memoryWriter[this.registersHL](this.registersHL,t),this.FHalfCarry=this.FSubtract=!1,this.FZero=0===t},function(){var t=1==(1&this.registerA);this.registerA=(this.FCarry?128:0)|this.registerA>>1,this.FCarry=t,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerA},function(){this.FCarry=this.registerB>127,this.registerB=this.registerB<<1&255,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerB},function(){this.FCarry=this.registerC>127,this.registerC=this.registerC<<1&255,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerC},function(){this.FCarry=this.registerD>127,this.registerD=this.registerD<<1&255,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerD},function(){this.FCarry=this.registerE>127,this.registerE=this.registerE<<1&255,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerE},function(){this.FCarry=this.registersHL>32767,this.registersHL=this.registersHL<<1&65024|255&this.registersHL,this.FHalfCarry=this.FSubtract=!1,this.FZero=this.registersHL<256},function(){this.FCarry=128==(128&this.registersHL),this.registersHL=65280&this.registersHL|this.registersHL<<1&255,this.FHalfCarry=this.FSubtract=!1,this.FZero=0==(255&this.registersHL)},function(){var t=this.readMemory(this.registersHL);this.FCarry=t>127,t=t<<1&255,this.memoryWriter[this.registersHL](this.registersHL,t),this.FHalfCarry=this.FSubtract=!1,this.FZero=0===t},function(){this.FCarry=this.registerA>127,this.registerA=this.registerA<<1&255,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerA},function(){this.FCarry=1==(1&this.registerB),this.registerB=128&this.registerB|this.registerB>>1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerB},function(){this.FCarry=1==(1&this.registerC),this.registerC=128&this.registerC|this.registerC>>1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerC},function(){this.FCarry=1==(1&this.registerD),this.registerD=128&this.registerD|this.registerD>>1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerD},function(){this.FCarry=1==(1&this.registerE),this.registerE=128&this.registerE|this.registerE>>1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerE},function(){this.FCarry=256==(256&this.registersHL),this.registersHL=this.registersHL>>1&65280|33023&this.registersHL,this.FHalfCarry=this.FSubtract=!1,this.FZero=this.registersHL<256},function(){this.FCarry=1==(1&this.registersHL),this.registersHL=65408&this.registersHL|(255&this.registersHL)>>1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0==(255&this.registersHL)},function(){var t=this.readMemory(this.registersHL);this.FCarry=1==(1&t),t=128&t|t>>1,this.memoryWriter[this.registersHL](this.registersHL,t),this.FHalfCarry=this.FSubtract=!1,this.FZero=0===t},function(){this.FCarry=1==(1&this.registerA),this.registerA=128&this.registerA|this.registerA>>1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerA},function(){this.registerB=(15&this.registerB)<<4|this.registerB>>4,this.FZero=0===this.registerB,this.FCarry=this.FHalfCarry=this.FSubtract=!1},function(){this.registerC=(15&this.registerC)<<4|this.registerC>>4,this.FZero=0===this.registerC,this.FCarry=this.FHalfCarry=this.FSubtract=!1},function(){this.registerD=(15&this.registerD)<<4|this.registerD>>4,this.FZero=0===this.registerD,this.FCarry=this.FHalfCarry=this.FSubtract=!1},function(){this.registerE=(15&this.registerE)<<4|this.registerE>>4,this.FZero=0===this.registerE,this.FCarry=this.FHalfCarry=this.FSubtract=!1},function(){this.registersHL=(3840&this.registersHL)<<4|(61440&this.registersHL)>>4|255&this.registersHL,this.FZero=this.registersHL<256,this.FCarry=this.FHalfCarry=this.FSubtract=!1},function(){this.registersHL=65280&this.registersHL|(15&this.registersHL)<<4|(240&this.registersHL)>>4,this.FZero=0==(255&this.registersHL),this.FCarry=this.FHalfCarry=this.FSubtract=!1},function(){var t=this.readMemory(this.registersHL);t=(15&t)<<4|t>>4,this.memoryWriter[this.registersHL](this.registersHL,t),this.FZero=0===t,this.FCarry=this.FHalfCarry=this.FSubtract=!1},function(){this.registerA=(15&this.registerA)<<4|this.registerA>>4,this.FZero=0===this.registerA,this.FCarry=this.FHalfCarry=this.FSubtract=!1},function(){this.FCarry=1==(1&this.registerB),this.registerB>>=1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerB},function(){this.FCarry=1==(1&this.registerC),this.registerC>>=1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerC},function(){this.FCarry=1==(1&this.registerD),this.registerD>>=1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerD},function(){this.FCarry=1==(1&this.registerE),this.registerE>>=1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerE},function(){this.FCarry=256==(256&this.registersHL),this.registersHL=this.registersHL>>1&65280|255&this.registersHL,this.FHalfCarry=this.FSubtract=!1,this.FZero=this.registersHL<256},function(){this.FCarry=1==(1&this.registersHL),this.registersHL=65280&this.registersHL|(255&this.registersHL)>>1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0==(255&this.registersHL)},function(){var t=this.readMemory(this.registersHL);this.FCarry=1==(1&t),this.memoryWriter[this.registersHL](this.registersHL,t>>1),this.FHalfCarry=this.FSubtract=!1,this.FZero=t<2},function(){this.FCarry=1==(1&this.registerA),this.registerA>>=1,this.FHalfCarry=this.FSubtract=!1,this.FZero=0===this.registerA},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(1&this.registerB)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(1&this.registerC)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(1&this.registerD)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(1&this.registerE)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(256&this.registersHL)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(1&this.registersHL)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(1&this.readMemory(this.registersHL))},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(1&this.registerA)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(2&this.registerB)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(2&this.registerC)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(2&this.registerD)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(2&this.registerE)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(512&this.registersHL)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(2&this.registersHL)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(2&this.readMemory(this.registersHL))},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(2&this.registerA)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(4&this.registerB)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(4&this.registerC)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(4&this.registerD)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(4&this.registerE)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(1024&this.registersHL)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(4&this.registersHL)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(4&this.readMemory(this.registersHL))},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(4&this.registerA)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(8&this.registerB)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(8&this.registerC)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(8&this.registerD)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(8&this.registerE)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(2048&this.registersHL)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(8&this.registersHL)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(8&this.readMemory(this.registersHL))},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(8&this.registerA)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(16&this.registerB)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(16&this.registerC)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(16&this.registerD)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(16&this.registerE)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(4096&this.registersHL)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(16&this.registersHL)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(16&this.readMemory(this.registersHL))},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(16&this.registerA)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(32&this.registerB)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(32&this.registerC)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(32&this.registerD)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(32&this.registerE)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(8192&this.registersHL)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(32&this.registersHL)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(32&this.readMemory(this.registersHL))},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(32&this.registerA)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(64&this.registerB)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(64&this.registerC)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(64&this.registerD)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(64&this.registerE)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(16384&this.registersHL)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(64&this.registersHL)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(64&this.readMemory(this.registersHL))},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(64&this.registerA)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(128&this.registerB)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(128&this.registerC)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(128&this.registerD)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(128&this.registerE)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(32768&this.registersHL)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(128&this.registersHL)},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(128&this.readMemory(this.registersHL))},function(){this.FHalfCarry=!0,this.FSubtract=!1,this.FZero=0==(128&this.registerA)},function(){this.registerB&=254},function(){this.registerC&=254},function(){this.registerD&=254},function(){this.registerE&=254},function(){this.registersHL&=65279},function(){this.registersHL&=65534},function(){this.memoryWriter[this.registersHL](this.registersHL,254&this.readMemory(this.registersHL))},function(){this.registerA&=254},function(){this.registerB&=253},function(){this.registerC&=253},function(){this.registerD&=253},function(){this.registerE&=253},function(){this.registersHL&=65023},function(){this.registersHL&=65533},function(){this.memoryWriter[this.registersHL](this.registersHL,253&this.readMemory(this.registersHL))},function(){this.registerA&=253},function(){this.registerB&=251},function(){this.registerC&=251},function(){this.registerD&=251},function(){this.registerE&=251},function(){this.registersHL&=64511},function(){this.registersHL&=65531},function(){this.memoryWriter[this.registersHL](this.registersHL,251&this.readMemory(this.registersHL))},function(){this.registerA&=251},function(){this.registerB&=247},function(){this.registerC&=247},function(){this.registerD&=247},function(){this.registerE&=247},function(){this.registersHL&=63487},function(){this.registersHL&=65527},function(){this.memoryWriter[this.registersHL](this.registersHL,247&this.readMemory(this.registersHL))},function(){this.registerA&=247},function(){this.registerB&=239},function(){this.registerC&=239},function(){this.registerD&=239},function(){this.registerE&=239},function(){this.registersHL&=61439},function(){this.registersHL&=65519},function(){this.memoryWriter[this.registersHL](this.registersHL,239&this.readMemory(this.registersHL))},function(){this.registerA&=239},function(){this.registerB&=223},function(){this.registerC&=223},function(){this.registerD&=223},function(){this.registerE&=223},function(){this.registersHL&=57343},function(){this.registersHL&=65503},function(){this.memoryWriter[this.registersHL](this.registersHL,223&this.readMemory(this.registersHL))},function(){this.registerA&=223},function(){this.registerB&=191},function(){this.registerC&=191},function(){this.registerD&=191},function(){this.registerE&=191},function(){this.registersHL&=49151},function(){this.registersHL&=65471},function(){this.memoryWriter[this.registersHL](this.registersHL,191&this.readMemory(this.registersHL))},function(){this.registerA&=191},function(){this.registerB&=127},function(){this.registerC&=127},function(){this.registerD&=127},function(){this.registerE&=127},function(){this.registersHL&=32767},function(){this.registersHL&=65407},function(){this.memoryWriter[this.registersHL](this.registersHL,127&this.readMemory(this.registersHL))},function(){this.registerA&=127},function(){this.registerB|=1},function(){this.registerC|=1},function(){this.registerD|=1},function(){this.registerE|=1},function(){this.registersHL|=256},function(){this.registersHL|=1},function(){this.memoryWriter[this.registersHL](this.registersHL,1|this.readMemory(this.registersHL))},function(){this.registerA|=1},function(){this.registerB|=2},function(){this.registerC|=2},function(){this.registerD|=2},function(){this.registerE|=2},function(){this.registersHL|=512},function(){this.registersHL|=2},function(){this.memoryWriter[this.registersHL](this.registersHL,2|this.readMemory(this.registersHL))},function(){this.registerA|=2},function(){this.registerB|=4},function(){this.registerC|=4},function(){this.registerD|=4},function(){this.registerE|=4},function(){this.registersHL|=1024},function(){this.registersHL|=4},function(){this.memoryWriter[this.registersHL](this.registersHL,4|this.readMemory(this.registersHL))},function(){this.registerA|=4},function(){this.registerB|=8},function(){this.registerC|=8},function(){this.registerD|=8},function(){this.registerE|=8},function(){this.registersHL|=2048},function(){this.registersHL|=8},function(){this.memoryWriter[this.registersHL](this.registersHL,8|this.readMemory(this.registersHL))},function(){this.registerA|=8},function(){this.registerB|=16},function(){this.registerC|=16},function(){this.registerD|=16},function(){this.registerE|=16},function(){this.registersHL|=4096},function(){this.registersHL|=16},function(){this.memoryWriter[this.registersHL](this.registersHL,16|this.readMemory(this.registersHL))},function(){this.registerA|=16},function(){this.registerB|=32},function(){this.registerC|=32},function(){this.registerD|=32},function(){this.registerE|=32},function(){this.registersHL|=8192},function(){this.registersHL|=32},function(){this.memoryWriter[this.registersHL](this.registersHL,32|this.readMemory(this.registersHL))},function(){this.registerA|=32},function(){this.registerB|=64},function(){this.registerC|=64},function(){this.registerD|=64},function(){this.registerE|=64},function(){this.registersHL|=16384},function(){this.registersHL|=64},function(){this.memoryWriter[this.registersHL](this.registersHL,64|this.readMemory(this.registersHL))},function(){this.registerA|=64},function(){this.registerB|=128},function(){this.registerC|=128},function(){this.registerD|=128},function(){this.registerE|=128},function(){this.registersHL|=32768},function(){this.registersHL|=128},function(){this.memoryWriter[this.registersHL](this.registersHL,128|this.readMemory(this.registersHL))},function(){this.registerA|=128}],et=[8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,12,8,8,8,8,8,8,8,12,8,8,8,8,8,8,8,12,8,8,8,8,8,8,8,12,8,8,8,8,8,8,8,12,8,8,8,8,8,8,8,12,8,8,8,8,8,8,8,12,8,8,8,8,8,8,8,12,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8,8,8,8,8,8,8,16,8],it=[()=>{},function(){this.registerC=this.readMemory(this.programCounter),this.registerB=this.readMemory(this.programCounter+1&65535),this.programCounter=this.programCounter+2&65535},function(){this.writeMemory(this.registerB<<8|this.registerC,this.registerA)},function(){var t=1+(this.registerB<<8|this.registerC);this.registerB=t>>8&255,this.registerC=255&t},function(){this.registerB=this.registerB+1&255,this.FZero=0===this.registerB,this.FHalfCarry=0==(15&this.registerB),this.FSubtract=!1},function(){this.registerB=this.registerB-1&255,this.FZero=0===this.registerB,this.FHalfCarry=15==(15&this.registerB),this.FSubtract=!0},function(){this.registerB=this.readMemory(this.programCounter),this.programCounter=this.programCounter+1&65535},function(){this.FCarry=this.registerA>127,this.registerA=this.registerA<<1&255|this.registerA>>7,this.FZero=this.FSubtract=this.FHalfCarry=!1},function(){var t=this.readMemory(this.programCounter+1&65535)<<8|this.readMemory(this.programCounter);this.programCounter=this.programCounter+2&65535,this.writeMemory(t,255&this.stackPointer),this.writeMemory(t+1&65535,this.stackPointer>>8)},function(){var t=this.registersHL+(this.registerB<<8|this.registerC);this.FHalfCarry=(4095&this.registersHL)>(4095&t),this.FCarry=t>65535,this.registersHL=65535&t,this.FSubtract=!1},function(){this.registerA=this.readMemory(this.registerB<<8|this.registerC)},function(){var t=(this.registerB<<8|this.registerC)-1&65535;this.registerB=t>>8,this.registerC=255&t},function(){this.registerC=this.registerC+1&255,this.FZero=0===this.registerC,this.FHalfCarry=0==(15&this.registerC),this.FSubtract=!1},function(){this.registerC=this.registerC-1&255,this.FZero=0===this.registerC,this.FHalfCarry=15==(15&this.registerC),this.FSubtract=!0},function(){this.registerC=this.readMemory(this.programCounter),this.programCounter=this.programCounter+1&65535},function(){this.registerA=this.registerA>>1|(1&this.registerA)<<7,this.FCarry=this.registerA>127,this.FZero=this.FSubtract=this.FHalfCarry=!1},function(){this.cartridge.useGbcMode&&1==(1&this.memory[65357])?(this.memory[65357]>127?(console.log("Going into single clock speed mode."),this.doubleSpeedShifter=0,this.memory[65357]&=127):(console.log("Going into double clock speed mode."),this.doubleSpeedShifter=1,this.memory[65357]|=128),this.memory[65357]&=254):this.stop()},function(){this.registerE=this.readMemory(this.programCounter),this.registerD=this.readMemory(this.programCounter+1&65535),this.programCounter=this.programCounter+2&65535},function(){this.writeMemory(this.registerD<<8|this.registerE,this.registerA)},function(){var t=1+(this.registerD<<8|this.registerE);this.registerD=t>>8&255,this.registerE=255&t},function(){this.registerD=this.registerD+1&255,this.FZero=0===this.registerD,this.FHalfCarry=0==(15&this.registerD),this.FSubtract=!1},function(){this.registerD=this.registerD-1&255,this.FZero=0===this.registerD,this.FHalfCarry=15==(15&this.registerD),this.FSubtract=!0},function(){this.registerD=this.readMemory(this.programCounter),this.programCounter=this.programCounter+1&65535},function(){var t=this.FCarry?1:0;this.FCarry=this.registerA>127,this.registerA=this.registerA<<1&255|t,this.FZero=this.FSubtract=this.FHalfCarry=!1},function(){this.programCounter=this.programCounter+(this.readMemory(this.programCounter)<<24>>24)+1&65535},function(){var t=this.registersHL+(this.registerD<<8|this.registerE);this.FHalfCarry=(4095&this.registersHL)>(4095&t),this.FCarry=t>65535,this.registersHL=65535&t,this.FSubtract=!1},function(){this.registerA=this.readMemory(this.registerD<<8|this.registerE)},function(){var t=(this.registerD<<8|this.registerE)-1&65535;this.registerD=t>>8,this.registerE=255&t},function(){this.registerE=this.registerE+1&255,this.FZero=0===this.registerE,this.FHalfCarry=0==(15&this.registerE),this.FSubtract=!1},function(){this.registerE=this.registerE-1&255,this.FZero=0===this.registerE,this.FHalfCarry=15==(15&this.registerE),this.FSubtract=!0},function(){this.registerE=this.readMemory(this.programCounter),this.programCounter=this.programCounter+1&65535},function(){var t=this.FCarry?128:0;this.FCarry=1==(1&this.registerA),this.registerA=this.registerA>>1|t,this.FZero=this.FSubtract=this.FHalfCarry=!1},function(){this.FZero?this.programCounter=this.programCounter+1&65535:(this.programCounter=this.programCounter+(this.readMemory(this.programCounter)<<24>>24)+1&65535,this.currentInstructionCycleCount+=4)},function(){this.registersHL=this.readMemory(this.programCounter+1&65535)<<8|this.readMemory(this.programCounter),this.programCounter=this.programCounter+2&65535},function(){this.writeMemory(this.registersHL,this.registerA),this.registersHL=this.registersHL+1&65535},function(){this.registersHL=this.registersHL+1&65535},function(){var t=1+(this.registersHL>>8)&255;this.FZero=0===t,this.FHalfCarry=0==(15&t),this.FSubtract=!1,this.registersHL=t<<8|255&this.registersHL},function(){var t=(this.registersHL>>8)-1&255;this.FZero=0===t,this.FHalfCarry=15==(15&t),this.FSubtract=!0,this.registersHL=t<<8|255&this.registersHL},function(){this.registersHL=this.readMemory(this.programCounter)<<8|255&this.registersHL,this.programCounter=this.programCounter+1&65535},function(){this.FSubtract?this.FCarry&&this.FHalfCarry?(this.registerA=this.registerA+154&255,this.FHalfCarry=!1):this.FCarry?this.registerA=this.registerA+160&255:this.FHalfCarry&&(this.registerA=this.registerA+250&255,this.FHalfCarry=!1):((this.FCarry||this.registerA>153)&&(this.registerA=this.registerA+96&255,this.FCarry=!0),(this.FHalfCarry||(15&this.registerA)>9)&&(this.registerA=this.registerA+6&255,this.FHalfCarry=!1)),this.FZero=0===this.registerA},function(){this.FZero?(this.programCounter=this.programCounter+(this.readMemory(this.programCounter)<<24>>24)+1&65535,this.currentInstructionCycleCount+=4):this.programCounter=this.programCounter+1&65535},function(){this.FHalfCarry=(4095&this.registersHL)>2047,this.FCarry=this.registersHL>32767,this.registersHL=this.registersHL<<1&65535,this.FSubtract=!1},function(){this.registerA=this.readMemory(this.registersHL),this.registersHL=this.registersHL+1&65535},function(){this.registersHL=this.registersHL-1&65535},function(){var t=this.registersHL+1&255;this.FZero=0===t,this.FHalfCarry=0==(15&t),this.FSubtract=!1,this.registersHL=65280&this.registersHL|t},function(){var t=this.registersHL-1&255;this.FZero=0===t,this.FHalfCarry=15==(15&t),this.FSubtract=!0,this.registersHL=65280&this.registersHL|t},function(){this.registersHL=65280&this.registersHL|this.readMemory(this.programCounter),this.programCounter=this.programCounter+1&65535},function(){this.registerA^=255,this.FSubtract=this.FHalfCarry=!0},function(){this.FCarry?this.programCounter=this.programCounter+1&65535:(this.programCounter=this.programCounter+(this.readMemory(this.programCounter)<<24>>24)+1&65535,this.currentInstructionCycleCount+=4)},function(){this.stackPointer=this.readMemory(this.programCounter+1&65535)<<8|this.readMemory(this.programCounter),this.programCounter=this.programCounter+2&65535},function(){this.writeMemory(this.registersHL,this.registerA),this.registersHL=this.registersHL-1&65535},function(){this.stackPointer=this.stackPointer+1&65535},function(){var t=this.readMemory(this.registersHL)+1&255;this.FZero=0===t,this.FHalfCarry=0==(15&t),this.FSubtract=!1,this.writeMemory(this.registersHL,t)},function(){var t=this.readMemory(this.registersHL)-1&255;this.FZero=0===t,this.FHalfCarry=15==(15&t),this.FSubtract=!0,this.writeMemory(this.registersHL,t)},function(){this.writeMemory(this.registersHL,this.readMemory(this.programCounter)),this.programCounter=this.programCounter+1&65535},function(){this.FCarry=!0,this.FSubtract=this.FHalfCarry=!1},function(){this.FCarry?(this.programCounter=this.programCounter+(this.readMemory(this.programCounter)<<24>>24)+1&65535,this.currentInstructionCycleCount+=4):this.programCounter=this.programCounter+1&65535},function(){var t=this.registersHL+this.stackPointer;this.FHalfCarry=(4095&this.registersHL)>(4095&t),this.FCarry=t>65535,this.registersHL=65535&t,this.FSubtract=!1},function(){this.registerA=this.readMemory(this.registersHL),this.registersHL=this.registersHL-1&65535},function(){this.stackPointer=this.stackPointer-1&65535},function(){this.registerA=this.registerA+1&255,this.FZero=0===this.registerA,this.FHalfCarry=0==(15&this.registerA),this.FSubtract=!1},function(){this.registerA=this.registerA-1&255,this.FZero=0===this.registerA,this.FHalfCarry=15==(15&this.registerA),this.FSubtract=!0},function(){this.registerA=this.readMemory(this.programCounter),this.programCounter=this.programCounter+1&65535},function(){this.FCarry=!this.FCarry,this.FSubtract=this.FHalfCarry=!1},function(){},function(){this.registerB=this.registerC},function(){this.registerB=this.registerD},function(){this.registerB=this.registerE},function(){this.registerB=this.registersHL>>8},function(){this.registerB=255&this.registersHL},function(){this.registerB=this.readMemory(this.registersHL)},function(){this.registerB=this.registerA},function(){this.registerC=this.registerB},function(){},function(){this.registerC=this.registerD},function(){this.registerC=this.registerE},function(){this.registerC=this.registersHL>>8},function(){this.registerC=255&this.registersHL},function(){this.registerC=this.readMemory(this.registersHL)},function(){this.registerC=this.registerA},function(){this.registerD=this.registerB},function(){this.registerD=this.registerC},function(){},function(){this.registerD=this.registerE},function(){this.registerD=this.registersHL>>8},function(){this.registerD=255&this.registersHL},function(){this.registerD=this.readMemory(this.registersHL)},function(){this.registerD=this.registerA},function(){this.registerE=this.registerB},function(){this.registerE=this.registerC},function(){this.registerE=this.registerD},function(){},function(){this.registerE=this.registersHL>>8},function(){this.registerE=255&this.registersHL},function(){this.registerE=this.readMemory(this.registersHL)},function(){this.registerE=this.registerA},function(){this.registersHL=this.registerB<<8|255&this.registersHL},function(){this.registersHL=this.registerC<<8|255&this.registersHL},function(){this.registersHL=this.registerD<<8|255&this.registersHL},function(){this.registersHL=this.registerE<<8|255&this.registersHL},function(){},function(){this.registersHL=257*(255&this.registersHL)},function(){this.registersHL=this.readMemory(this.registersHL)<<8|255&this.registersHL},function(){this.registersHL=this.registerA<<8|255&this.registersHL},function(){this.registersHL=65280&this.registersHL|this.registerB},function(){this.registersHL=65280&this.registersHL|this.registerC},function(){this.registersHL=65280&this.registersHL|this.registerD},function(){this.registersHL=65280&this.registersHL|this.registerE},function(){this.registersHL=65280&this.registersHL|this.registersHL>>8},function(){},function(){this.registersHL=65280&this.registersHL|this.readMemory(this.registersHL)},function(){this.registersHL=65280&this.registersHL|this.registerA},function(){this.writeMemory(this.registersHL,this.registerB)},function(){this.writeMemory(this.registersHL,this.registerC)},function(){this.writeMemory(this.registersHL,this.registerD)},function(){this.writeMemory(this.registersHL,this.registerE)},function(){this.writeMemory(this.registersHL,this.registersHL>>8)},function(){this.writeMemory(this.registersHL,255&this.registersHL)},function(){(this.interruptEnabledFlags&this.interruptRequestedFlags&31)>0?this.cartridge.useGbcMode||this.usedBootROM?this.currentInstructionCycleCount+=4:this.skipPCIncrement=!0:this.calculateHALTPeriod()},function(){this.writeMemory(this.registersHL,this.registerA)},function(){this.registerA=this.registerB},function(){this.registerA=this.registerC},function(){this.registerA=this.registerD},function(){this.registerA=this.registerE},function(){this.registerA=this.registersHL>>8},function(){this.registerA=255&this.registersHL},function(){this.registerA=this.readMemory(this.registersHL)},function(){},function(){var t=this.registerA+this.registerB;this.FHalfCarry=(15&t)<(15&this.registerA),this.FCarry=t>255,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!1},function(){var t=this.registerA+this.registerC;this.FHalfCarry=(15&t)<(15&this.registerA),this.FCarry=t>255,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!1},function(){var t=this.registerA+this.registerD;this.FHalfCarry=(15&t)<(15&this.registerA),this.FCarry=t>255,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!1},function(){var t=this.registerA+this.registerE;this.FHalfCarry=(15&t)<(15&this.registerA),this.FCarry=t>255,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!1},function(){var t=this.registerA+(this.registersHL>>8);this.FHalfCarry=(15&t)<(15&this.registerA),this.FCarry=t>255,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!1},function(){var t=this.registerA+(255&this.registersHL);this.FHalfCarry=(15&t)<(15&this.registerA),this.FCarry=t>255,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!1},function(){var t=this.registerA+this.readMemory(this.registersHL);this.FHalfCarry=(15&t)<(15&this.registerA),this.FCarry=t>255,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!1},function(){this.FHalfCarry=8==(8&this.registerA),this.FCarry=this.registerA>127,this.registerA=this.registerA<<1&255,this.FZero=0===this.registerA,this.FSubtract=!1},function(){var t=this.registerA+this.registerB+(this.FCarry?1:0);this.FHalfCarry=(15&this.registerA)+(15&this.registerB)+(this.FCarry?1:0)>15,this.FCarry=t>255,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!1},function(){var t=this.registerA+this.registerC+(this.FCarry?1:0);this.FHalfCarry=(15&this.registerA)+(15&this.registerC)+(this.FCarry?1:0)>15,this.FCarry=t>255,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!1},function(){var t=this.registerA+this.registerD+(this.FCarry?1:0);this.FHalfCarry=(15&this.registerA)+(15&this.registerD)+(this.FCarry?1:0)>15,this.FCarry=t>255,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!1},function(){var t=this.registerA+this.registerE+(this.FCarry?1:0);this.FHalfCarry=(15&this.registerA)+(15&this.registerE)+(this.FCarry?1:0)>15,this.FCarry=t>255,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!1},function(){var t=this.registersHL>>8,e=this.registerA+t+(this.FCarry?1:0);this.FHalfCarry=(15&this.registerA)+(15&t)+(this.FCarry?1:0)>15,this.FCarry=e>255,this.registerA=255&e,this.FZero=0===this.registerA,this.FSubtract=!1},function(){var t=255&this.registersHL,e=this.registerA+t+(this.FCarry?1:0);this.FHalfCarry=(15&this.registerA)+(15&t)+(this.FCarry?1:0)>15,this.FCarry=e>255,this.registerA=255&e,this.FZero=0===this.registerA,this.FSubtract=!1},function(){var t=this.readMemory(this.registersHL),e=this.registerA+t+(this.FCarry?1:0);this.FHalfCarry=(15&this.registerA)+(15&t)+(this.FCarry?1:0)>15,this.FCarry=e>255,this.registerA=255&e,this.FZero=0===this.registerA,this.FSubtract=!1},function(){var t=this.registerA<<1|(this.FCarry?1:0);this.FHalfCarry=(this.registerA<<1&30|(this.FCarry?1:0))>15,this.FCarry=t>255,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!1},function(){var t=this.registerA-this.registerB;this.FHalfCarry=(15&this.registerA)<(15&t),this.FCarry=t<0,this.registerA=255&t,this.FZero=0===t,this.FSubtract=!0},function(){var t=this.registerA-this.registerC;this.FHalfCarry=(15&this.registerA)<(15&t),this.FCarry=t<0,this.registerA=255&t,this.FZero=0===t,this.FSubtract=!0},function(){var t=this.registerA-this.registerD;this.FHalfCarry=(15&this.registerA)<(15&t),this.FCarry=t<0,this.registerA=255&t,this.FZero=0===t,this.FSubtract=!0},function(){var t=this.registerA-this.registerE;this.FHalfCarry=(15&this.registerA)<(15&t),this.FCarry=t<0,this.registerA=255&t,this.FZero=0===t,this.FSubtract=!0},function(){var t=this.registerA-(this.registersHL>>8);this.FHalfCarry=(15&this.registerA)<(15&t),this.FCarry=t<0,this.registerA=255&t,this.FZero=0===t,this.FSubtract=!0},function(){var t=this.registerA-(255&this.registersHL);this.FHalfCarry=(15&this.registerA)<(15&t),this.FCarry=t<0,this.registerA=255&t,this.FZero=0===t,this.FSubtract=!0},function(){var t=this.registerA-this.readMemory(this.registersHL);this.FHalfCarry=(15&this.registerA)<(15&t),this.FCarry=t<0,this.registerA=255&t,this.FZero=0===t,this.FSubtract=!0},function(){this.registerA=0,this.FHalfCarry=this.FCarry=!1,this.FZero=this.FSubtract=!0},function(){var t=this.registerA-this.registerB-(this.FCarry?1:0);this.FHalfCarry=(15&this.registerA)-(15&this.registerB)-(this.FCarry?1:0)<0,this.FCarry=t<0,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!0},function(){var t=this.registerA-this.registerC-(this.FCarry?1:0);this.FHalfCarry=(15&this.registerA)-(15&this.registerC)-(this.FCarry?1:0)<0,this.FCarry=t<0,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!0},function(){var t=this.registerA-this.registerD-(this.FCarry?1:0);this.FHalfCarry=(15&this.registerA)-(15&this.registerD)-(this.FCarry?1:0)<0,this.FCarry=t<0,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!0},function(){var t=this.registerA-this.registerE-(this.FCarry?1:0);this.FHalfCarry=(15&this.registerA)-(15&this.registerE)-(this.FCarry?1:0)<0,this.FCarry=t<0,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!0},function(){var t=this.registersHL>>8,e=this.registerA-t-(this.FCarry?1:0);this.FHalfCarry=(15&this.registerA)-(15&t)-(this.FCarry?1:0)<0,this.FCarry=e<0,this.registerA=255&e,this.FZero=0===this.registerA,this.FSubtract=!0},function(){var t=this.registerA-(255&this.registersHL)-(this.FCarry?1:0);this.FHalfCarry=(15&this.registerA)-(15&this.registersHL)-(this.FCarry?1:0)<0,this.FCarry=t<0,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!0},function(){var t=this.readMemory(this.registersHL),e=this.registerA-t-(this.FCarry?1:0);this.FHalfCarry=(15&this.registerA)-(15&t)-(this.FCarry?1:0)<0,this.FCarry=e<0,this.registerA=255&e,this.FZero=0===this.registerA,this.FSubtract=!0},function(){this.FCarry?(this.FZero=!1,this.FSubtract=this.FHalfCarry=this.FCarry=!0,this.registerA=255):(this.FHalfCarry=this.FCarry=!1,this.FSubtract=this.FZero=!0,this.registerA=0)},function(){this.registerA&=this.registerB,this.FZero=0===this.registerA,this.FHalfCarry=!0,this.FSubtract=this.FCarry=!1},function(){this.registerA&=this.registerC,this.FZero=0===this.registerA,this.FHalfCarry=!0,this.FSubtract=this.FCarry=!1},function(){this.registerA&=this.registerD,this.FZero=0===this.registerA,this.FHalfCarry=!0,this.FSubtract=this.FCarry=!1},function(){this.registerA&=this.registerE,this.FZero=0===this.registerA,this.FHalfCarry=!0,this.FSubtract=this.FCarry=!1},function(){this.registerA&=this.registersHL>>8,this.FZero=0===this.registerA,this.FHalfCarry=!0,this.FSubtract=this.FCarry=!1},function(){this.registerA&=this.registersHL,this.FZero=0===this.registerA,this.FHalfCarry=!0,this.FSubtract=this.FCarry=!1},function(){this.registerA&=this.readMemory(this.registersHL),this.FZero=0===this.registerA,this.FHalfCarry=!0,this.FSubtract=this.FCarry=!1},function(){this.FZero=0===this.registerA,this.FHalfCarry=!0,this.FSubtract=this.FCarry=!1},function(){this.registerA^=this.registerB,this.FZero=0===this.registerA,this.FSubtract=this.FHalfCarry=this.FCarry=!1},function(){this.registerA^=this.registerC,this.FZero=0===this.registerA,this.FSubtract=this.FHalfCarry=this.FCarry=!1},function(){this.registerA^=this.registerD,this.FZero=0===this.registerA,this.FSubtract=this.FHalfCarry=this.FCarry=!1},function(){this.registerA^=this.registerE,this.FZero=0===this.registerA,this.FSubtract=this.FHalfCarry=this.FCarry=!1},function(){this.registerA^=this.registersHL>>8,this.FZero=0===this.registerA,this.FSubtract=this.FHalfCarry=this.FCarry=!1},function(){this.registerA^=255&this.registersHL,this.FZero=0===this.registerA,this.FSubtract=this.FHalfCarry=this.FCarry=!1},function(){this.registerA^=this.readMemory(this.registersHL),this.FZero=0===this.registerA,this.FSubtract=this.FHalfCarry=this.FCarry=!1},function(){this.registerA=0,this.FZero=!0,this.FSubtract=this.FHalfCarry=this.FCarry=!1},function(){this.registerA|=this.registerB,this.FZero=0===this.registerA,this.FSubtract=this.FCarry=this.FHalfCarry=!1},function(){this.registerA|=this.registerC,this.FZero=0===this.registerA,this.FSubtract=this.FCarry=this.FHalfCarry=!1},function(){this.registerA|=this.registerD,this.FZero=0===this.registerA,this.FSubtract=this.FCarry=this.FHalfCarry=!1},function(){this.registerA|=this.registerE,this.FZero=0===this.registerA,this.FSubtract=this.FCarry=this.FHalfCarry=!1},function(){this.registerA|=this.registersHL>>8,this.FZero=0===this.registerA,this.FSubtract=this.FCarry=this.FHalfCarry=!1},function(){this.registerA|=255&this.registersHL,this.FZero=0===this.registerA,this.FSubtract=this.FCarry=this.FHalfCarry=!1},function(){this.registerA|=this.readMemory(this.registersHL),this.FZero=0===this.registerA,this.FSubtract=this.FCarry=this.FHalfCarry=!1},function(){this.FZero=0===this.registerA,this.FSubtract=this.FCarry=this.FHalfCarry=!1},function(){var t=this.registerA-this.registerB;this.FHalfCarry=(15&t)>(15&this.registerA),this.FCarry=t<0,this.FZero=0===t,this.FSubtract=!0},function(){var t=this.registerA-this.registerC;this.FHalfCarry=(15&t)>(15&this.registerA),this.FCarry=t<0,this.FZero=0===t,this.FSubtract=!0},function(){var t=this.registerA-this.registerD;this.FHalfCarry=(15&t)>(15&this.registerA),this.FCarry=t<0,this.FZero=0===t,this.FSubtract=!0},function(){var t=this.registerA-this.registerE;this.FHalfCarry=(15&t)>(15&this.registerA),this.FCarry=t<0,this.FZero=0===t,this.FSubtract=!0},function(){var t=this.registerA-(this.registersHL>>8);this.FHalfCarry=(15&t)>(15&this.registerA),this.FCarry=t<0,this.FZero=0===t,this.FSubtract=!0},function(){var t=this.registerA-(255&this.registersHL);this.FHalfCarry=(15&t)>(15&this.registerA),this.FCarry=t<0,this.FZero=0===t,this.FSubtract=!0},function(){var t=this.registerA-this.readMemory(this.registersHL);this.FHalfCarry=(15&t)>(15&this.registerA),this.FCarry=t<0,this.FZero=0===t,this.FSubtract=!0},function(){this.FHalfCarry=this.FCarry=!1,this.FZero=this.FSubtract=!0},function(){this.FZero||(this.programCounter=this.readMemory(this.stackPointer+1&65535)<<8|this.readMemory(this.stackPointer),this.stackPointer=this.stackPointer+2&65535,this.currentInstructionCycleCount+=12)},function(){this.registerC=this.readMemory(this.stackPointer),this.registerB=this.readMemory(this.stackPointer+1&65535),this.stackPointer=this.stackPointer+2&65535},function(){this.FZero?this.programCounter=this.programCounter+2&65535:(this.programCounter=this.readMemory(this.programCounter+1&65535)<<8|this.readMemory(this.programCounter),this.currentInstructionCycleCount+=4)},function(){this.programCounter=this.readMemory(this.programCounter+1&65535)<<8|this.readMemory(this.programCounter)},function(){if(this.FZero)this.programCounter=this.programCounter+2&65535;else{var t=this.readMemory(this.programCounter+1&65535)<<8|this.readMemory(this.programCounter);this.programCounter=this.programCounter+2&65535,this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.programCounter>>8),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,255&this.programCounter),this.programCounter=t,this.currentInstructionCycleCount+=12}},function(){this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.registerB),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.registerC)},function(){var t=this.registerA+this.readMemory(this.programCounter);this.programCounter=this.programCounter+1&65535,this.FHalfCarry=(15&t)<(15&this.registerA),this.FCarry=t>255,this.registerA=255&t,this.FZero=0===this.registerA,this.FSubtract=!1},function(){this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.programCounter>>8),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,255&this.programCounter),this.programCounter=0},function(){this.FZero&&(this.programCounter=this.readMemory(this.stackPointer+1&65535)<<8|this.readMemory(this.stackPointer),this.stackPointer=this.stackPointer+2&65535,this.currentInstructionCycleCount+=12)},function(){this.programCounter=this.readMemory(this.stackPointer+1&65535)<<8|this.readMemory(this.stackPointer),this.stackPointer=this.stackPointer+2&65535},function(){this.FZero?(this.programCounter=this.readMemory(this.programCounter+1&65535)<<8|this.readMemory(this.programCounter),this.currentInstructionCycleCount+=4):this.programCounter=this.programCounter+2&65535},function(){const t=this.readMemory(this.programCounter);this.programCounter=this.programCounter+1&65535,this.currentInstructionCycleCount+=et[t],tt[t].apply(this)},function(){if(this.FZero){var t=this.readMemory(this.programCounter+1&65535)<<8|this.readMemory(this.programCounter);this.programCounter=this.programCounter+2&65535,this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.programCounter>>8),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,255&this.programCounter),this.programCounter=t,this.currentInstructionCycleCount+=12}else this.programCounter=this.programCounter+2&65535},function(){var t=this.readMemory(this.programCounter+1&65535)<<8|this.readMemory(this.programCounter);this.programCounter=this.programCounter+2&65535,this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.programCounter>>8),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,255&this.programCounter),this.programCounter=t},function(){var t=this.readMemory(this.programCounter);this.programCounter=this.programCounter+1&65535;var e=this.registerA+t+(this.FCarry?1:0);this.FHalfCarry=(15&this.registerA)+(15&t)+(this.FCarry?1:0)>15,this.FCarry=e>255,this.registerA=255&e,this.FZero=0===this.registerA,this.FSubtract=!1},function(){this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.programCounter>>8),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,255&this.programCounter),this.programCounter=8},function(){this.FCarry||(this.programCounter=this.readMemory(this.stackPointer+1&65535)<<8|this.readMemory(this.stackPointer),this.stackPointer=this.stackPointer+2&65535,this.currentInstructionCycleCount+=12)},function(){this.registerE=this.readMemory(this.stackPointer),this.registerD=this.readMemory(this.stackPointer+1&65535),this.stackPointer=this.stackPointer+2&65535},function(){this.FCarry?this.programCounter=this.programCounter+2&65535:(this.programCounter=this.readMemory(this.programCounter+1&65535)<<8|this.readMemory(this.programCounter),this.currentInstructionCycleCount+=4)},function(){console.error("Illegal op code 0xD3 called, pausing emulation.")},function(){if(this.FCarry)this.programCounter=this.programCounter+2&65535;else{var t=this.readMemory(this.programCounter+1&65535)<<8|this.readMemory(this.programCounter);this.programCounter=this.programCounter+2&65535,this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.programCounter>>8),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,255&this.programCounter),this.programCounter=t,this.currentInstructionCycleCount+=12}},function(){this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.registerD),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.registerE)},function(){var t=this.registerA-this.readMemory(this.programCounter);this.programCounter=this.programCounter+1&65535,this.FHalfCarry=(15&this.registerA)<(15&t),this.FCarry=t<0,this.registerA=255&t,this.FZero=0===t,this.FSubtract=!0},function(){this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.programCounter>>8),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,255&this.programCounter),this.programCounter=16},function(){this.FCarry&&(this.programCounter=this.readMemory(this.stackPointer+1&65535)<<8|this.readMemory(this.stackPointer),this.stackPointer=this.stackPointer+2&65535,this.currentInstructionCycleCount+=12)},function(){this.programCounter=this.readMemory(this.stackPointer+1&65535)<<8|this.readMemory(this.stackPointer),this.stackPointer=this.stackPointer+2&65535,this.IRQEnableDelay=2===this.IRQEnableDelay||118===this.readMemory(this.programCounter)?1:2},function(){this.FCarry?(this.programCounter=this.readMemory(this.programCounter+1&65535)<<8|this.readMemory(this.programCounter),this.currentInstructionCycleCount+=4):this.programCounter=this.programCounter+2&65535},function(){console.error("Illegal op code 0xDB called, pausing emulation.")},function(){if(this.FCarry){var t=this.readMemory(this.programCounter+1&65535)<<8|this.readMemory(this.programCounter);this.programCounter=this.programCounter+2&65535,this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.programCounter>>8),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,255&this.programCounter),this.programCounter=t,this.currentInstructionCycleCount+=12}else this.programCounter=this.programCounter+2&65535},function(){console.error("Illegal op code 0xDD called, pausing emulation.")},function(){var t=this.readMemory(this.programCounter);this.programCounter=this.programCounter+1&65535;var e=this.registerA-t-(this.FCarry?1:0);this.FHalfCarry=(15&this.registerA)-(15&t)-(this.FCarry?1:0)<0,this.FCarry=e<0,this.registerA=255&e,this.FZero=0===this.registerA,this.FSubtract=!0},function(){this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.programCounter>>8),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,255&this.programCounter),this.programCounter=24},function(){this.memoryHighWrite(this.readMemory(this.programCounter),this.registerA),this.programCounter=this.programCounter+1&65535},function(){this.registersHL=this.readMemory(this.stackPointer+1&65535)<<8|this.readMemory(this.stackPointer),this.stackPointer=this.stackPointer+2&65535},function(){this.memoryHighWrite(this.registerC,this.registerA)},function(){console.log("Illegal op code 0xE3 called, pausing emulation.")},function(){console.log("Illegal op code 0xE4 called, pausing emulation.")},function(){this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.registersHL>>8),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,255&this.registersHL)},function(){this.registerA&=this.readMemory(this.programCounter),this.programCounter=this.programCounter+1&65535,this.FZero=0===this.registerA,this.FHalfCarry=!0,this.FSubtract=this.FCarry=!1},function(){this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.programCounter>>8),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,255&this.programCounter),this.programCounter=32},function(){var t=this.readMemory(this.programCounter)<<24>>24;this.programCounter=this.programCounter+1&65535;var e=this.stackPointer+t&65535;t=this.stackPointer^t^e,this.stackPointer=e,this.FCarry=256==(256&t),this.FHalfCarry=16==(16&t),this.FZero=this.FSubtract=!1},function(){this.programCounter=this.registersHL},function(){this.writeMemory(this.readMemory(this.programCounter+1&65535)<<8|this.readMemory(this.programCounter),this.registerA),this.programCounter=this.programCounter+2&65535},function(){console.error("Illegal op code 0xEB called, pausing emulation.")},function(){console.error("Illegal op code 0xEC called, pausing emulation.")},function(){console.error("Illegal op code 0xED called, pausing emulation.")},function(){this.registerA^=this.readMemory(this.programCounter),this.programCounter=this.programCounter+1&65535,this.FZero=0===this.registerA,this.FSubtract=this.FHalfCarry=this.FCarry=!1},function(){this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.programCounter>>8),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,255&this.programCounter),this.programCounter=40},function(){this.registerA=this.memoryHighRead(this.readMemory(this.programCounter)),this.programCounter=this.programCounter+1&65535},function(){var t=this.readMemory(this.stackPointer);this.FZero=t>127,this.FSubtract=64==(64&t),this.FHalfCarry=32==(32&t),this.FCarry=16==(16&t),this.registerA=this.readMemory(this.stackPointer+1&65535),this.stackPointer=this.stackPointer+2&65535},function(){this.registerA=this.memoryHighRead(this.registerC)},function(){this.IME=!1,this.IRQEnableDelay=0},function(){console.error("Illegal op code 0xF4 called, pausing emulation.")},function(){this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.registerA),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,(this.FZero?128:0)|(this.FSubtract?64:0)|(this.FHalfCarry?32:0)|(this.FCarry?16:0))},function(){this.registerA|=this.readMemory(this.programCounter),this.FZero=0===this.registerA,this.programCounter=this.programCounter+1&65535,this.FSubtract=this.FCarry=this.FHalfCarry=!1},function(){this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.programCounter>>8),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,255&this.programCounter),this.programCounter=48},function(){var t=this.readMemory(this.programCounter)<<24>>24;this.programCounter=this.programCounter+1&65535,this.registersHL=this.stackPointer+t&65535,t=this.stackPointer^t^this.registersHL,this.FCarry=256==(256&t),this.FHalfCarry=16==(16&t),this.FZero=this.FSubtract=!1},function(){this.stackPointer=this.registersHL},function(){this.registerA=this.readMemory(this.readMemory(this.programCounter+1&65535)<<8|this.readMemory(this.programCounter)),this.programCounter=this.programCounter+2&65535},function(){this.IRQEnableDelay=2===this.IRQEnableDelay||118===this.readMemory(this.programCounter)?1:2},()=>console.error("Illegal op code 0xFC called, pausing emulation."),()=>console.error("Illegal op code 0xFD called, pausing emulation."),function(){var t=this.registerA-this.readMemory(this.programCounter);this.programCounter=this.programCounter+1&65535,this.FHalfCarry=(15&t)>(15&this.registerA),this.FCarry=t<0,this.FZero=0===t,this.FSubtract=!0},function(){this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.programCounter>>8),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,255&this.programCounter),this.programCounter=56}];class rt{getState(t){return this.get("state-"+t)}getRam(t){return this.get("ram-"+t)}getRtc(t){return this.get("rtc-"+t)}setState(t,e){return this.set("state-"+t,e)}setRam(t,e){return this.set("ram-"+t,e)}setRtc(t,e){return this.set("rtc-"+t,e)}}class st extends rt{get(t){return function(t){if(!t||t.length<=0)return null;t=atob(t);const e=new Uint8Array(t.length);for(let i=0;i<t.length;i++)e[i]=t.charCodeAt(i);return e.buffer}(window.localStorage.getItem(t))}set(t,e){const i=function(t){if(!t||t.length<=0)return null;t=new Uint8Array(t);let e="";for(let i=0;i<t.byteLength;i++)e+=String.fromCharCode(t[i]);return btoa(e)}(e);window.localStorage.setItem(t,i)}}class ht extends rt{constructor(){super(...arguments),this.memory={}}get(t){return this.memory[t]}set(t,e){this.memory[t]=e}}class at extends class{constructor(t){this.gameboy=t,this.enabled=!1,this.leftChannelEnabled=!1,this.rightChannelEnabled=!1,this.canPlay=!1}}{constructor(t,e={}){super(t),this.gameboy=t,this.sweepEnabled=!1,this.sweepEnabled=!!e.sweepEnabled}init(){this.leftChannelEnabled=!1,this.rightChannelEnabled=!1,this.frequency=0,this.consecutive=!1}setInitialState(){this.enabled=!1,this.canPlay=!1,this.frequencyCounter=8192,this.frequencyTracker=8192,this.dutyTracker=0,this.cachedDuty=G[2],this.totalLength=0,this.envelopeVolume=0,this.envelopeType=!1,this.consecutive=!0,this.frequency=0,this.shadowFrequency=0,this.envelopeSweeps=0,this.envelopeSweepsLast=0,this.sweepEnabled&&(this.sweepFault=!1,this.timeSweep=1,this.lastTimeSweep=0,this.swept=!1,this.frequencySweepDivider=0,this.decreaseSweep=!1)}setSkippedBootRomState(){this.leftChannelEnabled=!0,this.rightChannelEnabled=!0,this.frequencyCounter=512,this.frequencyTracker=8192,this.dutyTracker=0,this.cachedDuty=G[2],this.totalLength=0,this.envelopeVolume=0,this.envelopeType=!1,this.consecutive=!0,this.frequency=1985,this.shadowFrequency=1985,this.envelopeSweeps=0,this.envelopeSweepsLast=0,this.sweepEnabled&&(this.swept=!1,this.sweepFault=!0,this.decreaseSweep=!1,this.frequencySweepDivider=0,this.timeSweep=1,this.lastTimeSweep=0)}envelope(){this.envelopeSweepsLast>-1&&(this.envelopeSweeps>0?--this.envelopeSweeps:this.envelopeType?this.envelopeVolume<15?(++this.envelopeVolume,this.envelopeSweeps=this.envelopeSweepsLast,this.setFirstStageSamples(),this.setSecondStageSamples(),this.setThirdStageSamples(),this.gameboy.audioController.cacheMixerOutputLevel()):this.envelopeSweepsLast=-1:this.envelopeVolume>0?(--this.envelopeVolume,this.envelopeSweeps=this.envelopeSweepsLast,this.setFirstStageSamples(),this.setSecondStageSamples(),this.setThirdStageSamples(),this.gameboy.audioController.cacheMixerOutputLevel()):this.envelopeSweepsLast=-1)}setSweep(t){this.decreaseSweep&&0==(8&t)&&this.swept&&(this.sweepFault=!0),this.lastTimeSweep=(112&t)>>4,this.frequencySweepDivider=7&t,this.decreaseSweep=8==(8&t)}setDuty(t){this.cachedDuty=G[t>>6]}setLength(t){this.totalLength=64-(63&t)}setEnvelopeVolume(t,e){this.enabled&&0===this.envelopeSweeps&&(8==(8&(this.gameboy.memory[t]^e))?(0==(8&this.gameboy.memory[t])&&(7==(7&this.gameboy.memory[t])?this.envelopeVolume+=2:++this.envelopeVolume),this.envelopeVolume=16-this.envelopeVolume&15):8==(15&this.gameboy.memory[t])&&(this.envelopeVolume=1+this.envelopeVolume&15),this.setFirstStageSamples(),this.setSecondStageSamples(),this.setThirdStageSamples(),this.gameboy.audioController.cacheMixerOutputLevel())}setEnvelopeType(t){this.envelopeType=8==(8&t)}setFrequency(t){this.frequency=1792&this.frequency|t,this.frequencyTracker=2048-this.frequency<<2}setHighFrequency(t){this.frequency=(7&t)<<8|255&this.frequency,this.frequencyTracker=2048-this.frequency<<2}checkEnabled(){this.enabled=(this.consecutive||this.totalLength>0)&&!this.sweepFault&&this.canPlay,this.setSecondStageSamples(),this.setThirdStageSamples(),this.gameboy.audioController.cacheMixerOutputLevel()}checkVolumeEnabled(){this.canPlay=this.gameboy.memory[65298]>7,this.checkEnabled(),this.setSecondStageSamples(),this.setThirdStageSamples(),this.gameboy.audioController.cacheMixerOutputLevel()}length(t){this.totalLength>1?--this.totalLength:1===this.totalLength&&(this.totalLength=0,this.checkEnabled(),this.gameboy.memory[65318]&=t)}sweep(){!this.sweepFault&&this.timeSweep>0&&0==--this.timeSweep&&this.lastTimeSweep>0&&(this.frequencySweepDivider>0?(this.swept=!0,this.decreaseSweep?(this.shadowFrequency-=this.shadowFrequency>>this.frequencySweepDivider,this.frequency=2047&this.shadowFrequency,this.frequencyTracker=2048-this.frequency<<2):(this.shadowFrequency+=this.shadowFrequency>>this.frequencySweepDivider,this.frequency=this.shadowFrequency,this.shadowFrequency<=2047?(this.frequencyTracker=2048-this.frequency<<2,this.shadowFrequency+(this.shadowFrequency>>this.frequencySweepDivider)>2047&&(this.sweepFault=!0,this.checkEnabled(),this.gameboy.memory[65318]&=254)):(this.frequency&=2047,this.sweepFault=!0,this.checkEnabled(),this.gameboy.memory[65318]&=254)),this.timeSweep=this.lastTimeSweep):(this.sweepFault=!0,this.checkEnabled()))}setFirstStageSamples(){this.currentSampleLeft=this.leftChannelEnabled?this.envelopeVolume:0,this.currentSampleRight=this.rightChannelEnabled?this.envelopeVolume:0}setSecondStageSamples(){this.enabled?(this.currentSampleLeftSecondary=this.currentSampleLeft,this.currentSampleRightSecondary=this.currentSampleRight):(this.currentSampleLeftSecondary=0,this.currentSampleRightSecondary=0)}setThirdStageSamples(){this.cachedDuty[this.dutyTracker]&&f[0]?(this.currentSampleLeftTrimary=this.currentSampleLeftSecondary,this.currentSampleRightTrimary=this.currentSampleRightSecondary):(this.currentSampleLeftTrimary=0,this.currentSampleRightTrimary=0)}}class ot{constructor({cpu:t,gameboy:e}){this.bufferLength=0,this.audioTicks=0,this.audioIndex=0,this.bufferContainAmount=0,this.bufferPosition=0,this.downsampleInput=0,this.enabled=!0,this.channelVolumeControlWriter=(t,e)=>{this.enabled&&this.memory[65316]!==e&&(this.run(),this.memory[65316]=e,this.cartridgeLeftChannelInputVolume=1+(e>>4&7),this.cartridgeRightChannelInputVolume=1+(7&e),this.cacheMixerOutputLevel())},this.cpu=t,this.gameboy=e,this.channel1=new at(this.gameboy,{sweepEnabled:!0}),this.channel2=new at(this.gameboy),this.generateWhiteNoise(),this.setInitialState()}setMemory(t){this.memory=t}initMemory(){this.channel3PcmData=new Int8Array(32)}init(){this.channel1.init(),this.channel2.init(),this.leftChannel3=!1,this.rightChannel3=!1,this.leftChannel4=!1,this.rightChannel4=!1,this.channel4Consecutive=!1,this.cartridgeLeftChannelInputVolume=8,this.cartridgeRightChannelInputVolume=8}setInitialState(){this.channel1.setInitialState(),this.channel2.setInitialState(),this.channel3TotalLength=0,this.channel3PatternType=4,this.channel3frequency=0,this.channel3Consecutive=!0,this.channel3Counter=2048,this.channel3FrequencyPeriod=2048,this.channel3LastSampleLookup=0,this.cachedChannel3Sample=0,this.channel3Enabled=!1,this.channel3CanPlay=!1,this.channel4FrequencyPeriod=8,this.channel4TotalLength=0,this.channel4EnvelopeVolume=0,this.channel4CurrentVolume=0,this.channel4EnvelopeType=!1,this.channel4EnvelopeSweeps=0,this.channel4EnvelopeSweepsLast=0,this.channel4Consecutive=!0,this.channel4BitRange=32767,this.channel4VolumeShifter=15,this.channel4LastSampleLookup=0,this.channel4FrequencyPeriod=8,this.channel4Counter=8,this.cachedChannel4Sample=0,this.channel4Enabled=!1,this.channel4CanPlay=!1,this.cartridgeLeftChannelInputVolume=8,this.cartridgeRightChannelInputVolume=8,this.mixerOutputCache=0,this.sequencerClocks=8192,this.sequencePosition=0,this.audioClocksUntilNextEvent=1,this.audioClocksUntilNextEventCounter=1,this.channel1.setFirstStageSamples(),this.channel1.setSecondStageSamples(),this.channel1.setThirdStageSamples(),this.cacheMixerOutputLevel(),this.channel2.setFirstStageSamples(),this.channel2.setSecondStageSamples(),this.channel2.setThirdStageSamples(),this.cacheMixerOutputLevel(),this.cacheChannel3OutputLevel(),this.cacheChannel4OutputLevel(),this.noiseSampleTable=this.LSFR15Table}setSkippedBootRomState(){this.channel1.setSkippedBootRomState(),this.channel2.setSkippedBootRomState(),this.leftChannel3=!0,this.rightChannel3=!1,this.channel3CanPlay=!1,this.channel3TotalLength=0,this.channel3PatternType=4,this.channel3frequency=0,this.channel3Consecutive=!0,this.channel3Counter=2048,this.channel3FrequencyPeriod=2048,this.channel3LastSampleLookup=0,this.leftChannel4=!0,this.rightChannel4=!1,this.channel4FrequencyPeriod=8,this.channel4TotalLength=0,this.channel4EnvelopeVolume=0,this.channel4CurrentVolume=0,this.channel4EnvelopeType=!1,this.channel4EnvelopeSweeps=0,this.channel4EnvelopeSweepsLast=0,this.channel4Consecutive=!0,this.channel4BitRange=32767,this.channel4VolumeShifter=15,this.channel4LastSampleLookup=0,this.cartridgeLeftChannelInputVolume=8,this.cartridgeRightChannelInputVolume=8}generate(t){if(this.gameboy.audioController.enabled&&!this.gameboy.cpu.stopped)for(let e=0;t>0;){for(e=Math.min(this.audioClocksUntilNextEventCounter,this.sequencerClocks,t),this.audioClocksUntilNextEventCounter-=e,this.sequencerClocks-=e,t-=e;e>0;){const t=Math.min(e,this.resamplerFirstPassFactor-this.audioIndex);e-=t,this.audioIndex+=t,this.downsampleInput+=this.mixerOutputCache*t,this.audioIndex===this.resamplerFirstPassFactor&&(this.audioIndex=0,this.outputAudio())}0===this.sequencerClocks&&(this.audioComputeSequencer(),this.sequencerClocks=8192),0===this.audioClocksUntilNextEventCounter&&this.computeChannels()}else for(;t>0;){const e=Math.min(t,this.resamplerFirstPassFactor-this.audioIndex);t-=e,this.audioIndex+=e,this.audioIndex===this.resamplerFirstPassFactor&&(this.audioIndex=0,this.outputAudio())}}enable(){this.memory[65318]=128,this.enabled=!0,this.setInitialState()}disable(){this.memory[65318]=0,this.enabled=!1;for(let t=65296;t<65318;t++)this.gameboy.writeMemory(t,0)}run(){this.generate(this.audioTicks),this.audioTicks=0}clockAudioEnvelope(){this.channel1.envelope(),this.channel2.envelope(),this.channel4EnvelopeSweepsLast>-1&&(this.channel4EnvelopeSweeps>0?--this.channel4EnvelopeSweeps:this.channel4EnvelopeType?this.channel4EnvelopeVolume<15?(this.channel4CurrentVolume=++this.channel4EnvelopeVolume<<this.channel4VolumeShifter,this.channel4EnvelopeSweeps=this.channel4EnvelopeSweepsLast,this.cacheChannel4Update()):this.channel4EnvelopeSweepsLast=-1:this.channel4EnvelopeVolume>0?(this.channel4CurrentVolume=--this.channel4EnvelopeVolume<<this.channel4VolumeShifter,this.channel4EnvelopeSweeps=this.channel4EnvelopeSweepsLast,this.cacheChannel4Update()):this.channel4EnvelopeSweepsLast=-1)}performChannel1AudioSweepDummy(){if(this.channel1.frequencySweepDivider>0&&!this.channel1.decreaseSweep){const t=this.channel1.shadowFrequency+(this.channel1.shadowFrequency>>this.channel1.frequencySweepDivider);t<=2047?t+(t>>this.channel1.frequencySweepDivider)>2047&&(this.channel1.sweepFault=!0,this.channel1.checkEnabled(),this.memory[65318]&=254):(this.channel1.sweepFault=!0,this.channel1.checkEnabled(),this.memory[65318]&=254)}}audioComputeSequencer(){switch(this.sequencePosition++){case 0:case 4:this.clockAudioLength();break;case 2:case 6:this.clockAudioLength(),this.clockAudioSweep();break;case 7:this.clockAudioEnvelope(),this.sequencePosition=0}}clockAudioLength(){this.channel1.length(254),this.channel2.length(253),this.channel3TotalLength>1?--this.channel3TotalLength:1===this.channel3TotalLength&&(this.channel3TotalLength=0,this.checkChannel3Enable(),this.memory[65318]&=251),this.channel4TotalLength>1?--this.channel4TotalLength:1===this.channel4TotalLength&&(this.channel4TotalLength=0,this.checkChannel4Enable(),this.memory[65318]&=247)}clockAudioSweep(){this.channel1.sweep()}computeChannels(){this.channel1.frequencyCounter-=this.audioClocksUntilNextEvent,this.channel2.frequencyCounter-=this.audioClocksUntilNextEvent,this.channel3Counter-=this.audioClocksUntilNextEvent,this.channel4Counter-=this.audioClocksUntilNextEvent,0===this.channel1.frequencyCounter&&(this.channel1.frequencyCounter=this.channel1.frequencyTracker,this.channel1.dutyTracker=this.channel1.dutyTracker+1&7,this.channel1.setThirdStageSamples(),this.cacheMixerOutputLevel()),0===this.channel2.frequencyCounter&&(this.channel2.frequencyCounter=this.channel2.frequencyTracker,this.channel2.dutyTracker=this.channel2.dutyTracker+1&7,this.channel2.setThirdStageSamples(),this.cacheMixerOutputLevel()),0===this.channel3Counter&&(this.channel3CanPlay&&(this.channel3LastSampleLookup=this.channel3LastSampleLookup+1&31),this.channel3Counter=this.channel3FrequencyPeriod,this.cacheChannel3Update()),0===this.channel4Counter&&(this.channel4LastSampleLookup=this.channel4LastSampleLookup+1&this.channel4BitRange,this.channel4Counter=this.channel4FrequencyPeriod,this.cacheChannel4Update()),this.audioClocksUntilNextEventCounter=this.audioClocksUntilNextEvent=Math.min(this.channel1.frequencyCounter,this.channel2.frequencyCounter,this.channel3Counter,this.channel4Counter)}cacheChannel3Update(){this.cachedChannel3Sample=this.channel3PcmData[this.channel3LastSampleLookup]>>this.channel3PatternType,this.cacheChannel3OutputLevel()}checkChannel3Enable(){this.channel3Enabled=this.channel3Consecutive||this.channel3TotalLength>0,this.channel3OutputLevelSecondaryCache()}cacheChannel3OutputLevel(){this.channel3CurrentSampleLeft=this.leftChannel3?this.cachedChannel3Sample:0,this.channel3CurrentSampleRight=this.rightChannel3?this.cachedChannel3Sample:0,this.channel3OutputLevelSecondaryCache()}channel3OutputLevelSecondaryCache(){this.channel3Enabled&&f[2]?(this.channel3CurrentSampleLeftSecondary=this.channel3CurrentSampleLeft,this.channel3CurrentSampleRightSecondary=this.channel3CurrentSampleRight):(this.channel3CurrentSampleLeftSecondary=0,this.channel3CurrentSampleRightSecondary=0),this.cacheMixerOutputLevel()}checkChannel4Enable(){this.channel4Enabled=(this.channel4Consecutive||this.channel4TotalLength>0)&&this.channel4CanPlay,this.cacheChannel4OutputLevelSecondary()}cacheChannel4Update(){this.cachedChannel4Sample=this.noiseSampleTable[this.channel4CurrentVolume|this.channel4LastSampleLookup],this.cacheChannel4OutputLevel()}cacheChannel4OutputLevel(){this.channel4CurrentSampleLeft=this.leftChannel4?this.cachedChannel4Sample:0,this.channel4CurrentSampleRight=this.rightChannel4?this.cachedChannel4Sample:0,this.cacheChannel4OutputLevelSecondary()}checkChannel4VolumeEnable(){this.channel4CanPlay=this.memory[65313]>7,this.checkChannel4Enable(),this.cacheChannel4OutputLevelSecondary()}cacheChannel4OutputLevelSecondary(){this.channel4Enabled&&f[3]?(this.channel4CurrentSampleLeftSecondary=this.channel4CurrentSampleLeft,this.channel4CurrentSampleRightSecondary=this.channel4CurrentSampleRight):(this.channel4CurrentSampleLeftSecondary=0,this.channel4CurrentSampleRightSecondary=0),this.cacheMixerOutputLevel()}cacheMixerOutputLevel(){const t=this.channel1.currentSampleLeftTrimary+this.channel2.currentSampleLeftTrimary+this.channel3CurrentSampleLeftSecondary+this.channel4CurrentSampleLeftSecondary,e=this.channel1.currentSampleRightTrimary+this.channel2.currentSampleRightTrimary+this.channel3CurrentSampleRightSecondary+this.channel4CurrentSampleRightSecondary;this.mixerOutputCache=t*this.cartridgeLeftChannelInputVolume<<16|e*this.cartridgeRightChannelInputVolume}connectDevice(t){this.resamplerFirstPassFactor=Math.max(Math.min(Math.floor(this.cpu.clocksPerSecond/44100),Math.floor(136.53125)),1),this.downSampleInputDivider=1/(240*this.resamplerFirstPassFactor);const e=this.cpu.clocksPerSecond/this.resamplerFirstPassFactor,i=Math.max(20*this.cpu.baseCyclesPerIteration/this.resamplerFirstPassFactor,8192)<<1;t.setSampleRate(e),t.setMaxBufferSize(i),t.init(),this.device=t,this.audioIndex=0,this.bufferPosition=0,this.downsampleInput=0,this.bufferContainAmount=Math.max(10*this.cpu.baseCyclesPerIteration/this.resamplerFirstPassFactor,4096)<<1,this.bufferLength=this.cpu.baseCyclesPerIteration/this.resamplerFirstPassFactor<<1,this.buffer=new Float32Array(this.bufferLength)}setVolume(t){this.device?.setVolume(t)}adjustUnderrun(){let t=this.device.remainingBuffer();"number"==typeof t&&(t=this.bufferContainAmount-Math.max(t,0),t>0&&this.recalculateIterationClockLimitForAudio((t>>1)*this.resamplerFirstPassFactor))}recalculateIterationClockLimitForAudio(t){this.cpu.cyclesTotal+=Math.min(t>>2<<2,this.cpu.cyclesTotalBase<<1)}outputAudio(){this.fillBuffer(),this.bufferPosition===this.bufferLength&&(this.device.writeAudio(this.buffer),this.bufferPosition=0),this.downsampleInput=0}fillBuffer(){this.buffer[this.bufferPosition++]=(this.downsampleInput>>>16)*this.downSampleInputDivider-1,this.buffer[this.bufferPosition++]=(65535&this.downsampleInput)*this.downSampleInputDivider-1}generateWhiteNoise(){this.LSFR7Table=this.generateLSFR7Table(),this.LSFR15Table=this.generateLSFR15Table(),this.noiseSampleTable=this.LSFR15Table}generateLSFR7Table(){const t=new Int8Array(2048);let e=127;for(let i=0;i<128;++i){const r=1-(1&e);t[128|i]=r,t[256|i]=2*r,t[384|i]=3*r,t[512|i]=4*r,t[640|i]=5*r,t[768|i]=6*r,t[896|i]=7*r,t[1024|i]=8*r,t[1152|i]=9*r,t[1280|i]=10*r,t[1408|i]=11*r,t[1536|i]=12*r,t[1664|i]=13*r,t[1792|i]=14*r,t[1920|i]=15*r;const s=e>>1;e=s|(1&(s^e))<<6}return t}generateLSFR15Table(){const t=new Int8Array(524288);let e=32767;for(let i=0;i<32768;++i){const r=1-(1&e);t[32768|i]=r,t[65536|i]=2*r,t[98304|i]=3*r,t[131072|i]=4*r,t[163840|i]=5*r,t[196608|i]=6*r,t[229376|i]=7*r,t[262144|i]=8*r,t[294912|i]=9*r,t[327680|i]=10*r,t[360448|i]=11*r,t[393216|i]=12*r,t[425984|i]=13*r,t[458752|i]=14*r,t[491520|i]=15*r;const s=e>>1;e=s|(1&(s^e))<<14}return t}registerMemoryWriters(){this.gameboy.highMemoryWriter[16]=this.gameboy.memoryWriter[65296]=(t,e)=>{this.enabled&&(this.run(),this.channel1.setSweep(e),this.memory[65296]=e,this.channel1.checkEnabled())},this.gameboy.highMemoryWriter[17]=this.gameboy.memoryWriter[65297]=(t,e)=>{!this.enabled&&this.gameboy.cartridge.useGbcMode||(this.enabled?this.run():e&=63,this.channel1.setDuty(e),this.channel1.setLength(e),this.memory[65297]=e,this.channel1.checkEnabled())},this.gameboy.highMemoryWriter[18]=this.gameboy.memoryWriter[65298]=(t,e)=>{this.enabled&&(this.run(),this.channel1.setEnvelopeVolume(65298,e),this.channel1.setEnvelopeType(e),this.memory[65298]=e,this.channel1.checkVolumeEnabled())},this.gameboy.highMemoryWriter[19]=this.gameboy.memoryWriter[65299]=(t,e)=>{this.enabled&&(this.run(),this.channel1.setFrequency(e))},this.gameboy.highMemoryWriter[20]=this.gameboy.memoryWriter[65300]=(t,e)=>{if(this.enabled){if(this.run(),this.channel1.consecutive=0==(64&e),this.channel1.setHighFrequency(e),e>127){this.channel1.timeSweep=this.channel1.lastTimeSweep,this.channel1.swept=!1;var i=this.memory[65298];this.channel1.envelopeVolume=i>>4,this.channel1.setFirstStageSamples(),this.channel1.setSecondStageSamples(),this.channel1.setThirdStageSamples(),this.cacheMixerOutputLevel(),this.channel1.envelopeSweepsLast=(7&i)-1,0===this.channel1.totalLength&&(this.channel1.totalLength=64),this.channel1.lastTimeSweep>0||this.channel1.frequencySweepDivider>0?this.memory[65318]|=1:this.memory[65318]&=254,64==(64&e)&&(this.memory[65318]|=1),this.channel1.shadowFrequency=this.channel1.frequency,this.channel1.sweepFault=!1,this.performChannel1AudioSweepDummy()}this.channel1.checkEnabled(),this.memory[65300]=e}},this.gameboy.highMemoryWriter[21]=this.gameboy.memoryWriter[65301]=this.gameboy.memoryNew.writeIllegal,this.gameboy.highMemoryWriter[22]=this.gameboy.memoryWriter[65302]=(t,e)=>{!this.enabled&&this.gameboy.cartridge.useGbcMode||(this.enabled?this.run():e&=63,this.channel2.setDuty(e),this.channel2.setLength(e),this.memory[65302]=e,this.channel2.checkEnabled())},this.gameboy.highMemoryWriter[23]=this.gameboy.memoryWriter[65303]=(t,e)=>{this.enabled&&(this.run(),this.channel2.setEnvelopeVolume(65303,e),this.channel2.setEnvelopeType(e),this.memory[65303]=e,this.channel2.checkVolumeEnabled())},this.gameboy.highMemoryWriter[24]=this.gameboy.memoryWriter[65304]=(t,e)=>{this.enabled&&(this.run(),this.channel2.setFrequency(e))},this.gameboy.highMemoryWriter[25]=this.gameboy.memoryWriter[65305]=(t,e)=>{if(this.enabled){if(this.run(),e>127){const t=this.memory[65303];this.channel2.envelopeVolume=t>>4,this.channel2.setFirstStageSamples(),this.channel2.setSecondStageSamples(),this.channel2.setThirdStageSamples(),this.cacheMixerOutputLevel(),this.channel2.envelopeSweepsLast=(7&t)-1,0===this.channel2.totalLength&&(this.channel2.totalLength=64),64==(64&e)&&(this.memory[65318]|=2)}this.channel2.consecutive=0==(64&e),this.channel2.setHighFrequency(e),this.memory[65305]=e,this.channel2.checkEnabled()}},this.gameboy.highMemoryWriter[26]=this.gameboy.memoryWriter[65306]=(t,e)=>{this.enabled&&(this.run(),!this.channel3CanPlay&&e>=128&&(this.channel3LastSampleLookup=0,this.cacheChannel3Update()),this.channel3CanPlay=e>127,this.channel3CanPlay&&this.memory[65306]>127&&!this.channel3Consecutive&&(this.memory[65318]|=4),this.memory[65306]=e)},this.gameboy.highMemoryWriter[27]=this.gameboy.memoryWriter[65307]=(t,e)=>{!this.enabled&&this.gameboy.cartridge.useGbcMode||(this.enabled&&this.run(),this.channel3TotalLength=256-e,this.checkChannel3Enable())},this.gameboy.highMemoryWriter[28]=this.gameboy.memoryWriter[65308]=(t,e)=>{this.enabled&&(this.run(),e&=96,this.memory[65308]=e,this.channel3PatternType=0===e?4:(e>>5)-1)},this.gameboy.highMemoryWriter[29]=this.gameboy.memoryWriter[65309]=(t,e)=>{this.enabled&&(this.run(),this.channel3frequency=1792&this.channel3frequency|e,this.channel3FrequencyPeriod=2048-this.channel3frequency<<1)},this.gameboy.highMemoryWriter[30]=this.gameboy.memoryWriter[65310]=(t,e)=>{this.enabled&&(this.run(),e>127&&(0===this.channel3TotalLength&&(this.channel3TotalLength=256),this.channel3LastSampleLookup=0,64==(64&e)&&(this.memory[65318]|=4)),this.channel3Consecutive=0==(64&e),this.channel3frequency=(7&e)<<8|255&this.channel3frequency,this.channel3FrequencyPeriod=2048-this.channel3frequency<<1,this.memory[65310]=e,this.checkChannel3Enable())},this.gameboy.highMemoryWriter[31]=this.gameboy.memoryWriter[65311]=this.gameboy.memoryNew.writeIllegal,this.gameboy.highMemoryWriter[32]=this.gameboy.memoryWriter[65312]=(t,e)=>{!this.enabled&&this.gameboy.cartridge.useGbcMode||(this.enabled&&this.run(),this.channel4TotalLength=64-(63&e),this.checkChannel4Enable())},this.gameboy.highMemoryWriter[33]=this.gameboy.memoryWriter[65313]=(t,e)=>{this.enabled&&(this.run(),this.channel4Enabled&&0===this.channel4EnvelopeSweeps&&(8==(8&(this.memory[65313]^e))?(0==(8&this.memory[65313])&&(7==(7&this.memory[65313])?this.channel4EnvelopeVolume+=2:++this.channel4EnvelopeVolume),this.channel4EnvelopeVolume=16-this.channel4EnvelopeVolume&15):8==(15&this.memory[65313])&&(this.channel4EnvelopeVolume=1+this.channel4EnvelopeVolume&15),this.channel4CurrentVolume=this.channel4EnvelopeVolume<<this.channel4VolumeShifter),this.channel4EnvelopeType=8==(8&e),this.memory[65313]=e,this.cacheChannel4Update(),this.checkChannel4VolumeEnable())},this.gameboy.highMemoryWriter[34]=this.gameboy.memoryWriter[65314]=(t,e)=>{if(this.enabled){this.run(),this.channel4FrequencyPeriod=Math.max((7&e)<<4,8)<<(e>>4);var i=8&e;(8===i&&32767===this.channel4BitRange||0===i&&127===this.channel4BitRange)&&(this.channel4LastSampleLookup=0,this.channel4BitRange=8===i?127:32767,this.channel4VolumeShifter=8===i?7:15,this.channel4CurrentVolume=this.channel4EnvelopeVolume<<this.channel4VolumeShifter,this.noiseSampleTable=8===i?this.LSFR7Table:this.LSFR15Table),this.memory[65314]=e,this.cacheChannel4Update()}},this.gameboy.highMemoryWriter[35]=this.gameboy.memoryWriter[65315]=(t,e)=>{if(this.enabled){if(this.run(),this.memory[65315]=e,this.channel4Consecutive=0==(64&e),e>127){var i=this.memory[65313];this.channel4EnvelopeVolume=i>>4,this.channel4CurrentVolume=this.channel4EnvelopeVolume<<this.channel4VolumeShifter,this.channel4EnvelopeSweepsLast=(7&i)-1,0===this.channel4TotalLength&&(this.channel4TotalLength=64),64==(64&e)&&(this.memory[65318]|=8)}this.checkChannel4Enable()}},this.gameboy.memoryNew.setWriter(65316,this.channelVolumeControlWriter),this.gameboy.memoryNew.setHighWriter(65316,this.channelVolumeControlWriter),this.gameboy.highMemoryWriter[37]=this.gameboy.memoryWriter[65317]=(t,e)=>{this.enabled&&this.memory[65317]!==e&&(this.run(),this.memory[65317]=e,this.channel1.rightChannelEnabled=1==(1&e),this.channel2.rightChannelEnabled=2==(2&e),this.rightChannel3=4==(4&e),this.rightChannel4=8==(8&e),this.channel1.leftChannelEnabled=16==(16&e),this.channel2.leftChannelEnabled=32==(32&e),this.leftChannel3=64==(64&e),this.leftChannel4=e>127,this.channel1.setFirstStageSamples(),this.channel1.setSecondStageSamples(),this.channel1.setThirdStageSamples(),this.cacheMixerOutputLevel(),this.channel2.setFirstStageSamples(),this.channel2.setSecondStageSamples(),this.channel2.setThirdStageSamples(),this.cacheMixerOutputLevel(),this.cacheChannel3OutputLevel(),this.cacheChannel4OutputLevel())},this.gameboy.highMemoryWriter[38]=this.gameboy.memoryWriter[65318]=(t,e)=>{this.run();const i=e>127?"Enable":"Disable";this.enabled||"Enable"!==i?this.enabled&&"Disable"===i&&this.disable():this.enable()}}registerWaveformMemoryWriters(){this.gameboy.highMemoryWriter[48]=this.gameboy.memoryWriter[65328]=(t,e)=>{this.writeWaveformRam(0,e)},this.gameboy.highMemoryWriter[49]=this.gameboy.memoryWriter[65329]=(t,e)=>{this.writeWaveformRam(1,e)},this.gameboy.highMemoryWriter[50]=this.gameboy.memoryWriter[65330]=(t,e)=>{this.writeWaveformRam(2,e)},this.gameboy.highMemoryWriter[51]=this.gameboy.memoryWriter[65331]=(t,e)=>{this.writeWaveformRam(3,e)},this.gameboy.highMemoryWriter[52]=this.gameboy.memoryWriter[65332]=(t,e)=>{this.writeWaveformRam(4,e)},this.gameboy.highMemoryWriter[53]=this.gameboy.memoryWriter[65333]=(t,e)=>{this.writeWaveformRam(5,e)},this.gameboy.highMemoryWriter[54]=this.gameboy.memoryWriter[65334]=(t,e)=>{this.writeWaveformRam(6,e)},this.gameboy.highMemoryWriter[55]=this.gameboy.memoryWriter[65335]=(t,e)=>{this.writeWaveformRam(7,e)},this.gameboy.highMemoryWriter[56]=this.gameboy.memoryWriter[65336]=(t,e)=>{this.writeWaveformRam(8,e)},this.gameboy.highMemoryWriter[57]=this.gameboy.memoryWriter[65337]=(t,e)=>{this.writeWaveformRam(9,e)},this.gameboy.highMemoryWriter[58]=this.gameboy.memoryWriter[65338]=(t,e)=>{this.writeWaveformRam(10,e)},this.gameboy.highMemoryWriter[59]=this.gameboy.memoryWriter[65339]=(t,e)=>{this.writeWaveformRam(11,e)},this.gameboy.highMemoryWriter[60]=this.gameboy.memoryWriter[65340]=(t,e)=>{this.writeWaveformRam(12,e)},this.gameboy.highMemoryWriter[61]=this.gameboy.memoryWriter[65341]=(t,e)=>{this.writeWaveformRam(13,e)},this.gameboy.highMemoryWriter[62]=this.gameboy.memoryWriter[65342]=(t,e)=>{this.writeWaveformRam(14,e)},this.gameboy.highMemoryWriter[63]=this.gameboy.memoryWriter[65343]=(t,e)=>{this.writeWaveformRam(15,e)}}writeWaveformRam(t,e){this.channel3CanPlay&&this.run(),this.memory[65328|t]=e,t<<=1,this.channel3PcmData[t]=e>>4,this.channel3PcmData[1|t]=15&e}}const nt=["Right","Left","Up","Down","A","B","Select","Start"];class mt extends A.EventEmitter{constructor(t={}){super(),this.midScanlineOffset=-1,this.currentX=0,this.stopEmulator=3,this.matchedIrqLines=0,this.spriteCount=252,this.colors=[15728606,11392916,5411443,1586242],this.pixelStart=0,this.pixelEnd=0,this.isBootingRom=!0,this.memoryReader=[],this.memoryWriter=[],this.highMemoryReader=[],this.highMemoryWriter=[],this.frameHandler=t=>{this.isPaused()||((!this.lastRun||this.lastRun<t-8)&&(this.run(),this.lastRun=t),this.requestFrame(this.frameHandler))},this.onMbcRamWrite=()=>{this.emit("mbcRamWrite")},this.readMemory=t=>this.memoryNew.hasReader(t)?this.memoryNew.read(t):this.memoryReader[t].apply(this,[t]),this.memoryHighReadNormal=t=>this.memory[65280|t],this.memoryReadGBCMemory=t=>this.gbcMemory[t+this.gbcRamBankPosition],this.memoryReadOAM=t=>this.modeSTAT>1?255:this.memory[t],this.readGbcEchoRam=t=>this.gbcMemory[t+this.gbcEchoRamBankPosition],this.readEchoRam=t=>this.memory[t-8192],this.readGbcVideoRam=t=>this.modeSTAT>2?255:0===this.currentVideoRamBank?this.memory[t]:this.videoRam[8191&t],this.readVideoRam=t=>this.modeSTAT>2?255:this.memory[t],this.readGbcCharacterVideoRam=t=>this.modeSTAT>2?255:this.BGCHRCurrentBank[2047&t],this.readCharacterVideoRam=t=>this.modeSTAT>2?255:this.BGCHRBank1[2047&t],this.memoryWriteNormal=(t,e)=>{this.memory[t]=e},this.memoryHighWriteNormal=(t,e)=>{this.memory[65280|t]=e},this.memoryWriteGBCRAM=(t,e)=>{this.gbcMemory[t+this.gbcRamBankPosition]=e},this.memoryWriteECHONormal=(t,e)=>{this.memory[t-8192]=e},this.debouncedAutoSave=d(this.autoSave.bind(this),100),this.addListener("mbcRamWrite",(()=>{this.cartridge&&this.debouncedAutoSave()})),this.isOn=!1,this.actions=new P,this.registerActions(),"undefined"!=typeof document?this.storage=new st:this.storage=new ht,this.cpu=new C,this.gpu=new K(this),this.audioDevice=new Z({context:t.audio?.context,channels:2}),this.audioController=new ot({cpu:this.cpu,gameboy:this}),this.joypad=new T(this),this.lcdDevice=new B(this,t.lcd),this.stateManager=new D(this),this.stateManager.init(),this.updateGBBGPalette=this.updateGBRegularBGPalette,this.updateGBOBJPalette=this.updateGBRegularOBJPalette}isPaused(){return"undefined"!=typeof document&&document.hidden}setStorage(t){this.storage=t}registerActions(){for(const t of nt){const e=nt.indexOf(t);this.actions.register(t).addListener("Down"+t,(()=>{this.joypad.down(e)})).addListener("Up"+t,(()=>{this.joypad.up(e)}))}this.actions.register("Speed").addListener("DownSpeed",(t=>this.handleSpeed(t))).addListener("ChangeSpeed",(t=>this.handleSpeed(t))).addListener("UpSpeed",(()=>{this.setSpeed(1)}))}handleSpeed(t){let e=2;t&&"number"==typeof t.value&&(e=2*t.value+1),this.setSpeed(e)}turnOn(){this.isOn||(this.isOn=!0,this.start(this.cartridge),this.stopEmulator=1,this.requestFrame(this.frameHandler))}turnOff(){this.isOn&&(this.isOn=!1,this.interval&&(clearInterval(this.interval),this.interval=null))}restart(){this.turnOff(),this.turnOn()}setGbBootRom(t){t instanceof p||(t=new p(t)),this.gbBootRom=t}setGbcBootRom(t){t instanceof p||(t=new p(t)),this.gbcBootRom=t}replaceCartridge(t){this.turnOff(),this.removeCartridge(),this.insertCartridge(t),this.turnOn()}removeCartridge(){this.cartridge=null}insertCartridge(t){t instanceof Q||(t=new Q(t)),this.cartridge=t}actionDown(t,e){this.actions.down(t,e)}actionChange(t,e){this.actions.change(t,e)}actionUp(t,e){this.actions.up(t,e)}autoSave(){this.saveRam(),this.saveRtc()}async saveState(t){if(!this.storage||!this.cartridge)return;const e=this.cartridge.name;if(!t&&!(t=this.stateManager.get()))return!1;await this.storage.setState(e,t),this.emit("stateSaved",{name:e,state:t})}async saveRam(t){if(!this.storage||!this.cartridge?.mbc)return;const e=this.cartridge.name;if(!t&&!(t=this.cartridge.mbc.getRam()))return!1;await this.storage.setRam(e,t.buffer),this.emit("ramSaved",{name:e,ram:t})}async saveRtc(t){if(!this.storage||!this.cartridge?.mbc?.rtc)return;const e=this.cartridge.name;if(!t&&!(t=this.cartridge.mbc.rtc.get()))return!1;await this.storage.setRtc(e,t.buffer),this.emit("rtcSaved",{name:e,rtc:t})}loadState(t){if(!this.storage||!this.cartridge)return;const e=this.cartridge.name;if(!t&&!(t=this.storage.getState(e)))return!1;this.stateManager.load(t),this.initReferencesFromSaveState(),this.memoryNew.init(),this.lcdDevice.init(),this.audioController.noiseSampleTable=32767===this.audioController.channel4BitRange?this.audioController.LSFR15Table:this.audioController.LSFR7Table,this.audioController.channel4VolumeShifter=32767===this.audioController.channel4BitRange?15:7,this.emit("stateLoaded",{name:e,state:t})}loadRam(t){if(!this.storage||!this.cartridge)return;const e=this.cartridge.name;if(!t){if(!(t=this.storage.getRam(e)))return!1;t=new Uint8Array(t)}this.cartridge.mbc.loadRam(t),this.emit("ramLoaded",{name:e,ram:t})}loadRtc(t){if(!this.storage||!this.core?.cartridge?.hasRtc)return;const e=this.cartridge.name;if(!t){if(!(t=this.storage.getRtc(e)))return!1;t=new Uint32Array(t)}this.cartridge.mbc.rtc.load(t),this.emit("rtcLoaded",{name:e,rtc:t})}getBatteryFileArrayBuffer(){if(!this.cartridge?.mbc)return;const t=this.cartridge.mbc.getRam(),e=this.cartridge.mbc.rtc?.get();return e?g(t.buffer,e.buffer):t.buffer}async loadBatteryFileArrayBuffer(t){if(!this.cartridge?.mbc)return;const e=this.cartridge.mbc.cutSRAMFromBatteryFileArray(t),i=this.cartridge.mbc.rtc?.cutBatteryFileArray(t);this.cartridge.mbc.loadRam(e),i&&this.cartridge.mbc.rtc.load(i),await this.saveRam(e),i&&await this.saveRtc(i),this.restart()}requestFrame(t){if("undefined"!=typeof window&&window.requestAnimationFrame)window.requestAnimationFrame(t);else{const e=("undefined"!=typeof performance?performance:Date).now();setTimeout((()=>t(e)),0)}}connectCartridge(t){this.cartridge?.mbc?.removeListener("rumble",this.rumble)?.removeListener("ramWrite",this.onMbcRamWrite),this.cartridge?.disconnect(),t.connect(this),t.interpret(),t.mbc?.addListener("rumble",this.rumble)?.addListener("ramWrite",this.onMbcRamWrite),t.mbc?.setupRom(),this.cartridge=t,this.loadCartridgeRomIntoMemory(),this.gbcBootRom?this.loadGbcBootRomIntoMemory():this.gbBootRom&&this.loadGbBootRomIntoMemory()}rumble(){"undefined"!=typeof window&&"vibrate"in window.navigator&&window.navigator.vibrate(200)}loadGbcBootRomIntoMemory(){let t=0;for(;t<256;)this.memory[t]=this.gbcBootRom.getByte(t),++t;for(;t<512;)this.memory[t]=this.cartridge.rom.getByte(t),++t;for(;t<2304;)this.memory[t]=this.gbcBootRom.getByte(t),++t;this.usedBootRom=!0,this.usedGbcBootRom=!0}loadGbBootRomIntoMemory(){let t=0;for(;t<256;)this.memory[t]=this.gbBootRom.getByte(t),++t;this.usedBootRom=!0}loadCartridgeRomIntoMemory(){for(let t=0;t<16384;t++)this.memory[t]=this.cartridge.rom.getByte(t)}start(t){this.stateManager.init(),this.memory=new Uint8Array(65536),this.audioController.setMemory(this.memory),this.frameBuffer=n(23040,16316664,"int32"),this.BGCHRBank1=new Uint8Array(2048),this.audioController.initMemory(),this.memoryNew=new W(this,this.memory),this.lcdDevice.init(),this.audioController.connectDevice(this.audioDevice),this.connectCartridge(t),this.cartridge.setupRAM(),this.cartridge.useGbcMode&&(this.videoRam=new Uint8Array(8192),this.gbcMemory=new Uint8Array(28672)),this.memoryNew.init(),this.cartridge.useGbcMode?(this.gbcOBJRawPalette=new Uint8Array(64),this.gbcBGRawPalette=new Uint8Array(64),this.gbcOBJPalette=n(32,16777216,"int32"),this.gbcBGPalette=new Int32Array(64),this.BGCHRBank2=new Uint8Array(2048),this.BGCHRCurrentBank=this.currentVideoRamBank>0?this.BGCHRBank2:this.BGCHRBank1,this.tileCache=this.generateCacheArray(3968)):(this.gbOBJPalette=new Int32Array(8),this.gbBGPalette=new Int32Array(4),this.backgroundPalette=this.gbBGPalette,this.OBJPalette=this.gbOBJPalette,this.tileCache=this.generateCacheArray(1792),this.sortBuffer=new Uint8Array(256),this.OAMAddressCache=new Int32Array(10)),this.gpu.initRenderer(),this.usedBootRom?this.initBootRom():(this.isBootingRom=!1,this.skipBootRom()),this.checkIrqMatching()}generateCacheArray(t){const e=[];let i=0;for(;i<t;)e[i++]=new Uint8Array(64);return e}skipBootRom(){for(var t=255;t>=0;){if(t>=48&&t<64)this.writeMemory(65280|t,$[t]);else switch(t){case 0:case 1:case 2:case 5:case 7:case 15:case 255:this.writeMemory(65280|t,$[t]);break;default:this.memory[65280|t]=$[t]}--t}this.cartridge.useGbcMode?(this.memory[65388]=254,this.memory[65396]=254):(this.memory[65352]=255,this.memory[65353]=255,this.memory[65388]=255,this.memory[65396]=255),console.log("Starting without the GBC boot ROM."),this.registerA=this.cartridge.useGbcMode?17:1,this.registerB=0,this.registerC=19,this.registerD=0,this.registerE=216,this.FZero=!0,this.FSubtract=!1,this.FHalfCarry=!0,this.FCarry=!0,this.registersHL=333,this.gpu.enableLCD(),this.IME=!1,this.matchedIrqLines=0,this.interruptRequestedFlags=225,this.interruptEnabledFlags=0,this.hdmaRunning=!1,this.currentInstructionCycleCount=12,this.STATTracker=0,this.modeSTAT=1,this.spriteCount=252,this.LYCMatchTriggerSTAT=!1,this.mode2TriggerSTAT=!1,this.mode1TriggerSTAT=!1,this.mode0TriggerSTAT=!1,this.audioController.setSkippedBootRomState(),this.DIVTicks=27044,this.LCDTicks=160,this.timerTicks=0,this.TIMAEnabled=!1,this.TACClocker=1024,this.serialTimer=0,this.serialShiftTimer=0,this.serialShiftTimerAllocated=0,this.IRQEnableDelay=0,this.actualScanline=144,this.lastUnrenderedLine=0,this.gfxWindowDisplay=!1,this.gfxSpriteShow=!1,this.gfxSpriteNormalHeight=!0,this.backgroundEnabled=!0,this.hasBackgroundPriority=!0,this.gfxWindowCHRBankPosition=0,this.gfxBackgroundCHRBankPosition=0,this.gfxBackgroundBankOffset=0,this.windowY=0,this.windowX=0,this.drewBlank=0,this.midScanlineOffset=-1,this.currentX=0}initBootRom(){console.log("Starting boot rom"),this.programCounter=0,this.stackPointer=0,this.IME=!1,this.LCDTicks=0,this.DIVTicks=0,this.registerA=0,this.registerB=0,this.registerC=0,this.registerD=0,this.registerE=0,this.FZero=this.FSubtract=this.FHalfCarry=this.FCarry=!1,this.registersHL=0,this.audioController.init(),this.joypad.init()}disableBootRom(){this.loadCartridgeRomIntoMemory(),this.usedGbcBootRom?this.cartridge.useGbcMode?this.memoryNew.updateIoRegisters():this.adjustGbctoGbMode():this.memoryNew.updateIoRegisters()}setSpeed(t){this.cpu.setSpeed(t),this.audioController.connectDevice(this.audioDevice)}run(){0==(2&this.stopEmulator)&&(1==(1&this.stopEmulator)?this.cpu.stopped?(this.audioController.adjustUnderrun(),this.audioController.audioTicks+=this.cpu.cyclesTotal,this.audioController.run(),this.stopEmulator|=1):(this.stopEmulator=0,this.audioController.adjustUnderrun(),this.cartridge.mbc?.rtc?.updateClock(),this.halt?(this.currentInstructionCycleCount=0,this.calculateHALTPeriod(),this.halt?(this.updateCore(),this.iterationEndRoutine()):this.executeIteration()):this.executeIteration(),this.lcdDevice.draw()):console.error("Iterator restarted a faulted core."))}executeIteration(){for(;0===this.stopEmulator;){switch(this.IRQEnableDelay){case 1:this.IME=!0,this.checkIrqMatching(),--this.IRQEnableDelay;break;case 2:--this.IRQEnableDelay}this.matchedIrqLines>0&&this.launchIRQ();const t=this.readMemory(this.programCounter);this.programCounter=this.programCounter+1&65535,this.skipPCIncrement&&(this.programCounter=this.programCounter-1&65535,this.skipPCIncrement=!1),this.currentInstructionCycleCount=v[t],it[t].apply(this);const e=this.currentInstructionCycleCount>>this.doubleSpeedShifter;if(this.LCDTicks+=e,this.gpu.runScanline(this.actualScanline),this.audioController.audioTicks+=e,this.cpu.ticks+=e,this.DIVTicks+=this.currentInstructionCycleCount,this.TIMAEnabled)for(this.timerTicks+=this.currentInstructionCycleCount;this.timerTicks>=this.TACClocker;)this.timerTicks-=this.TACClocker,256==++this.memory[65285]&&(this.memory[65285]=this.memory[65286],this.interruptRequestedFlags|=4,this.checkIrqMatching());this.serialTimer>0&&(this.serialTimer-=this.currentInstructionCycleCount,this.serialTimer<=0&&(this.interruptRequestedFlags|=8,this.checkIrqMatching()),this.serialShiftTimer-=this.currentInstructionCycleCount,this.serialShiftTimer<=0&&(this.serialShiftTimer=this.serialShiftTimerAllocated,this.memory[65281]=this.memory[65281]<<1&254|1)),this.cpu.ticks>=this.cpu.cyclesTotal&&this.iterationEndRoutine()}}iterationEndRoutine(){0==(1&this.stopEmulator)&&(this.audioController.run(),this.memory[65284]=this.memory[65284]+(this.DIVTicks>>8)&255,this.DIVTicks&=255,this.stopEmulator|=1,this.cpu.ticks-=this.cpu.cyclesTotal,this.cpu.cyclesTotalCurrent+=this.cpu.cyclesTotalRoundoff,this.recalculateIterationClockLimit())}stop(){this.cpu.stopped=!0,this.iterationEndRoutine(),this.cpu.ticks<0&&(this.audioController.audioTicks-=this.cpu.ticks,this.audioController.run())}recalculateIterationClockLimit(){const t=this.cpu.cyclesTotalCurrent%4;this.cpu.cyclesTotal=this.cpu.cyclesTotalBase+this.cpu.cyclesTotalCurrent-t,this.cpu.cyclesTotalCurrent=t}scanLineMode2(){1!==this.STATTracker&&(this.mode2TriggerSTAT&&(this.interruptRequestedFlags|=2,this.checkIrqMatching()),this.STATTracker=1,this.modeSTAT=2)}scanLineMode3(){3!==this.modeSTAT&&(0===this.STATTracker&&this.mode2TriggerSTAT&&(this.interruptRequestedFlags|=2,this.checkIrqMatching()),this.STATTracker=1,this.modeSTAT=3)}scanLineMode0(){0!==this.modeSTAT&&(2!==this.STATTracker&&(0===this.STATTracker&&(this.mode2TriggerSTAT&&(this.interruptRequestedFlags|=2,this.checkIrqMatching()),this.modeSTAT=3),this.incrementScanlineQueue(),this.updateSpriteCount(this.actualScanline),this.STATTracker=2),this.LCDTicks>=this.spriteCount&&(this.hdmaRunning&&this.executeHDMA(),this.mode0TriggerSTAT&&(this.interruptRequestedFlags|=2,this.checkIrqMatching()),this.STATTracker=3,this.modeSTAT=0))}clocksUntilLYCMatch(){return 0!==this.memory[65349]?this.memory[65349]>this.actualScanline?456*(this.memory[65349]-this.actualScanline):456*(_-this.actualScanline+this.memory[65349]):456*(153===this.actualScanline&&0===this.memory[65348]?_:153-this.actualScanline)+8}clocksUntilMode0(){switch(this.modeSTAT){case 0:return 143===this.actualScanline?(this.updateSpriteCount(0),this.spriteCount+5016):(this.updateSpriteCount(this.actualScanline+1),this.spriteCount+456);case 2:case 3:return this.updateSpriteCount(this.actualScanline),this.spriteCount;case 1:return this.updateSpriteCount(0),this.spriteCount+456*(_-this.actualScanline)}}updateSpriteCount(t){if(this.spriteCount=252,this.cartridge.useGbcMode&&this.gfxSpriteShow)for(var e=t+16,i=0,r=this.gfxSpriteNormalHeight?8:16,s=65024;s<65184&&this.spriteCount<312;s+=4)(i=e-this.memory[s])>-1&&i<r&&(this.spriteCount+=6)}matchLYC(){this.memory[65348]===this.memory[65349]?(this.memory[65345]|=4,this.LYCMatchTriggerSTAT&&(this.interruptRequestedFlags|=2,this.checkIrqMatching())):this.memory[65345]&=123}updateCore(){this.LCDTicks+=this.currentInstructionCycleCount>>this.doubleSpeedShifter,this.gpu.runScanline(this.actualScanline);var t=this.currentInstructionCycleCount>>this.doubleSpeedShifter;if(this.audioController.audioTicks+=t,this.cpu.ticks+=t,this.DIVTicks+=this.currentInstructionCycleCount,this.TIMAEnabled)for(this.timerTicks+=this.currentInstructionCycleCount;this.timerTicks>=this.TACClocker;)this.timerTicks-=this.TACClocker,256==++this.memory[65285]&&(this.memory[65285]=this.memory[65286],this.interruptRequestedFlags|=4,this.checkIrqMatching());this.serialTimer>0&&(this.serialTimer-=this.currentInstructionCycleCount,this.serialTimer<=0&&(this.interruptRequestedFlags|=8,this.checkIrqMatching()),this.serialShiftTimer-=this.currentInstructionCycleCount,this.serialShiftTimer<=0&&(this.serialShiftTimer=this.serialShiftTimerAllocated,this.memory[65281]=this.memory[65281]<<1&254|1))}updateCoreFull(){this.updateCore(),this.cpu.ticks>=this.cpu.cyclesTotal&&this.iterationEndRoutine()}executeHDMA(){this.writeDirectlyToMemory(1),this.halt?this.LCDTicks-this.spriteCount<(4>>this.doubleSpeedShifter|32)&&(this.currentInstructionCycleCount=4+(32+this.spriteCount<<this.doubleSpeedShifter),this.LCDTicks=this.spriteCount+(4>>this.doubleSpeedShifter|32)):this.LCDTicks+=4>>this.doubleSpeedShifter|32,0===this.memory[65365]?(this.hdmaRunning=!1,this.memory[65365]=255):--this.memory[65365]}renderScanline(t){if(this.pixelStart=160*t,this.backgroundEnabled)this.pixelEnd=160,this.gpu.renderBackgroundLayer(t),this.gpu.renderWindowLayer(t);else{const e=160*(t+1),i=this.cartridge.useGbcMode||this.colorizedGBPalettes?16316664:15728606;for(let r=160*t+this.currentX;r<e;r++)this.frameBuffer[r]=i}this.gpu.renderSpriteLayer(t),this.currentX=0,this.midScanlineOffset=-1}renderMidScanline(){if(this.actualScanline<144&&3===this.modeSTAT&&(-1===this.midScanlineOffset&&(this.midScanlineOffset=7&this.backgroundX),this.LCDTicks>=82)){if(this.pixelEnd=this.LCDTicks-74,this.pixelEnd=Math.min(this.pixelEnd-this.midScanlineOffset-this.pixelEnd%8,160),this.backgroundEnabled)this.pixelStart=160*this.lastUnrenderedLine,this.gpu.renderBackgroundLayer(this.lastUnrenderedLine),this.gpu.renderWindowLayer(this.lastUnrenderedLine);else for(var t=160*this.lastUnrenderedLine+this.pixelEnd,e=this.cartridge.useGbcMode||this.colorizedGBPalettes?16316664:15728606,i=160*this.lastUnrenderedLine+this.currentX;i<t;i++)this.frameBuffer[i]=e;this.currentX=this.pixelEnd}}adjustGbctoGbMode(){console.log("Stepping down from GBC mode."),this.videoRam=this.gbcMemory=this.BGCHRCurrentBank=this.BGCHRBank2=void 0,this.tileCache.length=1792,this.gbBGColorizedPalette=new Int32Array(4),this.gbOBJColorizedPalette=new Int32Array(8),this.cachedBGPaletteConversion=new Int32Array(4),this.cachedOBJPaletteConversion=new Int32Array(8),this.backgroundPalette=this.gbBGColorizedPalette,this.OBJPalette=this.gbOBJColorizedPalette,this.gbOBJPalette=this.gbBGPalette=void 0,this.getGBCColor(),this.sortBuffer=new Uint8Array(256),this.OAMAddressCache=new Int32Array(10),this.gpu.initRenderer(),this.memoryNew.init()}initReferencesFromSaveState(){if(this.cartridge.useGbcMode){this.BGCHRCurrentBank=this.currentVideoRamBank>0?this.BGCHRBank2:this.BGCHRBank1,this.tileCache=this.generateCacheArray(3968);for(let t=0;t<6144;t+=16)this.generateGBCTileBank1(t),this.generateGBCTileBank2(t)}else{this.colorizedGBPalettes?(this.backgroundPalette=this.gbBGColorizedPalette,this.OBJPalette=this.gbOBJColorizedPalette,this.updateGBBGPalette=this.updateGBColorizedBGPalette,this.updateGBOBJPalette=this.updateGBColorizedOBJPalette):(this.backgroundPalette=this.gbBGPalette,this.OBJPalette=this.gbOBJPalette),this.tileCache=this.generateCacheArray(1792);for(let t=32768;t<36864;t+=2)this.generateGBOAMTileLine(t);for(let t=36864;t<38912;t+=2)this.generateGBTileLine(t);this.sortBuffer=new Uint8Array(256),this.OAMAddressCache=new Int32Array(10)}this.gpu.initRenderer()}adjustRGBTint(t){const e=31&t,i=t>>5&31,r=t>>10&31;return 13*e+2*i+r>>1<<16|3*i+r<<9|3*e+2*i+11*r>>1}getGBCColor(){for(let t=0;t<4;t++){const e=t<<1;this.cachedBGPaletteConversion[t]=this.adjustRGBTint(this.gbcBGRawPalette[1|e]<<8|this.gbcBGRawPalette[e]),this.cachedOBJPaletteConversion[t]=this.adjustRGBTint(this.gbcOBJRawPalette[1|e]<<8|this.gbcOBJRawPalette[e])}for(let t=4;t<8;t++){const e=t<<1;this.cachedOBJPaletteConversion[t]=this.adjustRGBTint(this.gbcOBJRawPalette[1|e]<<8|this.gbcOBJRawPalette[e])}this.updateGBBGPalette=this.updateGBColorizedBGPalette,this.updateGBOBJPalette=this.updateGBColorizedOBJPalette,this.updateGBBGPalette(this.memory[65351]),this.updateGBOBJPalette(0,this.memory[65352]),this.updateGBOBJPalette(1,this.memory[65353]),this.colorizedGBPalettes=!0}updateGBRegularBGPalette(t){this.gbBGPalette[0]=33554432|this.colors[3&t],this.gbBGPalette[1]=this.colors[t>>2&3],this.gbBGPalette[2]=this.colors[t>>4&3],this.gbBGPalette[3]=this.colors[t>>6]}updateGBColorizedBGPalette(t){this.gbBGColorizedPalette[0]=33554432|this.cachedBGPaletteConversion[3&t],this.gbBGColorizedPalette[1]=this.cachedBGPaletteConversion[t>>2&3],this.gbBGColorizedPalette[2]=this.cachedBGPaletteConversion[t>>4&3],this.gbBGColorizedPalette[3]=this.cachedBGPaletteConversion[t>>6]}updateGBRegularOBJPalette(t,e){this.gbOBJPalette[1|t]=this.colors[e>>2&3],this.gbOBJPalette[2|t]=this.colors[e>>4&3],this.gbOBJPalette[3|t]=this.colors[e>>6]}updateGBColorizedOBJPalette(t,e){this.gbOBJColorizedPalette[1|t]=this.cachedOBJPaletteConversion[t|e>>2&3],this.gbOBJColorizedPalette[2|t]=this.cachedOBJPaletteConversion[t|e>>4&3],this.gbOBJColorizedPalette[3|t]=this.cachedOBJPaletteConversion[t|e>>6]}updateGBCBGPalette(t,e){this.gbcBGRawPalette[t]!==e&&(this.midScanlineJIT(),this.gbcBGRawPalette[t]=e,0==(6&t)?(e=33554432|this.adjustRGBTint(this.gbcBGRawPalette[1|t]<<8|this.gbcBGRawPalette[62&t]),t>>=1,this.gbcBGPalette[t]=e,this.gbcBGPalette[32|t]=16777216|e):(e=this.adjustRGBTint(this.gbcBGRawPalette[1|t]<<8|this.gbcBGRawPalette[62&t]),t>>=1,this.gbcBGPalette[t]=e,this.gbcBGPalette[32|t]=16777216|e))}updateGBCOBJPalette(t,e){this.gbcOBJRawPalette[t]!==e&&(this.gbcOBJRawPalette[t]=e,(6&t)>0&&(this.midScanlineJIT(),this.gbcOBJPalette[t>>1]=16777216|this.adjustRGBTint(this.gbcOBJRawPalette[1|t]<<8|this.gbcOBJRawPalette[62&t])))}findLowestSpriteDrawable(t,e){let i=65024,r=0,s=0;for(;i<65184&&r<10;)s=t-this.memory[i],(s&e)===s&&(this.OAMAddressCache[r++]=i),i+=4;return r}generateGBTileLine(t){var e=this.memory[1|t]<<8|this.memory[40958&t],i=this.tileCache[(8176&t)>>4];i[7|(t=(14&t)<<2)]=(256&e)>>7|1&e,i[6|t]=(512&e)>>8|(2&e)>>1,i[5|t]=(1024&e)>>9|(4&e)>>2,i[4|t]=(2048&e)>>10|(8&e)>>3,i[3|t]=(4096&e)>>11|(16&e)>>4,i[2|t]=(8192&e)>>12|(32&e)>>5,i[1|t]=(16384&e)>>13|(64&e)>>6,i[t]=(32768&e)>>14|(128&e)>>7}generateGBCTileLineBank1(t){var e=this.memory[1|t]<<8|this.memory[40958&t];t&=8190;var i=this.tileCache[t>>4],r=this.tileCache[512|t>>4],s=this.tileCache[1024|t>>4],h=this.tileCache[1536|t>>4],a=56-(t=(14&t)<<2);h[a]=r[t]=s[7|a]=i[7|t]=(256&e)>>7|1&e,h[1|a]=r[1|t]=s[6|a]=i[6|t]=(512&e)>>8|(2&e)>>1,h[2|a]=r[2|t]=s[5|a]=i[5|t]=(1024&e)>>9|(4&e)>>2,h[3|a]=r[3|t]=s[4|a]=i[4|t]=(2048&e)>>10|(8&e)>>3,h[4|a]=r[4|t]=s[3|a]=i[3|t]=(4096&e)>>11|(16&e)>>4,h[5|a]=r[5|t]=s[2|a]=i[2|t]=(8192&e)>>12|(32&e)>>5,h[6|a]=r[6|t]=s[1|a]=i[1|t]=(16384&e)>>13|(64&e)>>6,h[7|a]=r[7|t]=s[a]=i[t]=(32768&e)>>14|(128&e)>>7}generateGBCTileBank1(t){var e=t>>4,i=this.tileCache[e],r=this.tileCache[512|e],s=this.tileCache[1024|e],h=this.tileCache[1536|e],a=0;t|=32768,e=0;var o=56;do{a=this.memory[1|t]<<8|this.memory[t],h[o]=r[e]=s[7|o]=i[7|e]=(256&a)>>7|1&a,h[1|o]=r[1|e]=s[6|o]=i[6|e]=(512&a)>>8|(2&a)>>1,h[2|o]=r[2|e]=s[5|o]=i[5|e]=(1024&a)>>9|(4&a)>>2,h[3|o]=r[3|e]=s[4|o]=i[4|e]=(2048&a)>>10|(8&a)>>3,h[4|o]=r[4|e]=s[3|o]=i[3|e]=(4096&a)>>11|(16&a)>>4,h[5|o]=r[5|e]=s[2|o]=i[2|e]=(8192&a)>>12|(32&a)>>5,h[6|o]=r[6|e]=s[1|o]=i[1|e]=(16384&a)>>13|(64&a)>>6,h[7|o]=r[7|e]=s[o]=i[e]=(32768&a)>>14|(128&a)>>7,e+=8,o-=8,t+=2}while(o>-1)}generateGBCTileLineBank2(t){var e=this.videoRam[1|t]<<8|this.videoRam[8190&t],i=this.tileCache[2048|t>>4],r=this.tileCache[2560|t>>4],s=this.tileCache[3072|t>>4],h=this.tileCache[3584|t>>4],a=56-(t=(14&t)<<2);h[a]=r[t]=s[7|a]=i[7|t]=(256&e)>>7|1&e,h[1|a]=r[1|t]=s[6|a]=i[6|t]=(512&e)>>8|(2&e)>>1,h[2|a]=r[2|t]=s[5|a]=i[5|t]=(1024&e)>>9|(4&e)>>2,h[3|a]=r[3|t]=s[4|a]=i[4|t]=(2048&e)>>10|(8&e)>>3,h[4|a]=r[4|t]=s[3|a]=i[3|t]=(4096&e)>>11|(16&e)>>4,h[5|a]=r[5|t]=s[2|a]=i[2|t]=(8192&e)>>12|(32&e)>>5,h[6|a]=r[6|t]=s[1|a]=i[1|t]=(16384&e)>>13|(64&e)>>6,h[7|a]=r[7|t]=s[a]=i[t]=(32768&e)>>14|(128&e)>>7}generateGBCTileBank2(t){var e=t>>4,i=this.tileCache[2048|e],r=this.tileCache[2560|e],s=this.tileCache[3072|e],h=this.tileCache[3584|e],a=0;e=0;var o=56;do{a=this.videoRam[1|t]<<8|this.videoRam[t],h[o]=r[e]=s[7|o]=i[7|e]=(256&a)>>7|1&a,h[1|o]=r[1|e]=s[6|o]=i[6|e]=(512&a)>>8|(2&a)>>1,h[2|o]=r[2|e]=s[5|o]=i[5|e]=(1024&a)>>9|(4&a)>>2,h[3|o]=r[3|e]=s[4|o]=i[4|e]=(2048&a)>>10|(8&a)>>3,h[4|o]=r[4|e]=s[3|o]=i[3|e]=(4096&a)>>11|(16&a)>>4,h[5|o]=r[5|e]=s[2|o]=i[2|e]=(8192&a)>>12|(32&a)>>5,h[6|o]=r[6|e]=s[1|o]=i[1|e]=(16384&a)>>13|(64&a)>>6,h[7|o]=r[7|e]=s[o]=i[e]=(32768&a)>>14|(128&a)>>7,e+=8,o-=8,t+=2}while(o>-1)}generateGBOAMTileLine(t){var e=this.memory[1|t]<<8|this.memory[40958&t];t&=8190;var i=this.tileCache[t>>4],r=this.tileCache[512|t>>4],s=this.tileCache[1024|t>>4],h=this.tileCache[1536|t>>4],a=56-(t=(14&t)<<2);h[a]=r[t]=s[7|a]=i[7|t]=(256&e)>>7|1&e,h[1|a]=r[1|t]=s[6|a]=i[6|t]=(512&e)>>8|(2&e)>>1,h[2|a]=r[2|t]=s[5|a]=i[5|t]=(1024&e)>>9|(4&e)>>2,h[3|a]=r[3|t]=s[4|a]=i[4|t]=(2048&e)>>10|(8&e)>>3,h[4|a]=r[4|t]=s[3|a]=i[3|t]=(4096&e)>>11|(16&e)>>4,h[5|a]=r[5|t]=s[2|a]=i[2|t]=(8192&e)>>12|(32&e)>>5,h[6|a]=r[6|t]=s[1|a]=i[1|t]=(16384&e)>>13|(64&e)>>6,h[7|a]=r[7|t]=s[a]=i[t]=(32768&e)>>14|(128&e)>>7}graphicsJIT(){this.gpu.lcdEnabled&&(this.cpu.totalLinesPassed=0,this.renderQueuedScanlines())}graphicsJITVBlank(){this.cpu.totalLinesPassed+=this.queuedScanlines,this.renderQueuedScanlines()}renderQueuedScanlines(){for(;this.queuedScanlines>0;)this.renderScanline(this.lastUnrenderedLine),this.lastUnrenderedLine<143?++this.lastUnrenderedLine:this.lastUnrenderedLine=0,--this.queuedScanlines}incrementScanlineQueue(){this.queuedScanlines<144?++this.queuedScanlines:(this.currentX=0,this.midScanlineOffset=-1,this.lastUnrenderedLine<143?++this.lastUnrenderedLine:this.lastUnrenderedLine=0)}midScanlineJIT(){this.graphicsJIT(),this.renderMidScanline()}launchIRQ(){var t=0,e=1;do{if((e&this.matchedIrqLines)===e)return this.IME=!1,this.interruptRequestedFlags-=e,this.matchedIrqLines=0,this.currentInstructionCycleCount=20,this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,this.programCounter>>8),this.stackPointer=this.stackPointer-1&65535,this.writeMemory(this.stackPointer,255&this.programCounter),this.programCounter=64|t<<3,void this.updateCore();e=1<<++t}while(t<5)}checkIrqMatching(){this.IME&&(this.matchedIrqLines=this.interruptEnabledFlags&this.interruptRequestedFlags&31)}calculateHALTPeriod(){if(this.halt)t=this.remainingClocks;else{this.halt=!0;var t=-1;if(this.gpu.lcdEnabled&&(1==(this.interruptEnabledFlags>>0&1)&&(t=456*((1===this.modeSTAT?298:144)-this.actualScanline)-this.LCDTicks<<this.doubleSpeedShifter),1==(this.interruptEnabledFlags>>1&1))){if(this.mode0TriggerSTAT){const e=this.clocksUntilMode0()-this.LCDTicks<<this.doubleSpeedShifter;(e<=t||-1===t)&&(t=e)}if(this.mode1TriggerSTAT&&0==(1&this.interruptEnabledFlags)){const e=456*((1===this.modeSTAT?298:144)-this.actualScanline)-this.LCDTicks<<this.doubleSpeedShifter;(e<=t||-1===t)&&(t=e)}if(this.mode2TriggerSTAT){const e=(this.actualScanline>=143?456*(_-this.actualScanline):456)-this.LCDTicks<<this.doubleSpeedShifter;(e<=t||-1===t)&&(t=e)}if(this.LYCMatchTriggerSTAT&&this.memory[65349]<=153){const e=this.clocksUntilLYCMatch()-this.LCDTicks<<this.doubleSpeedShifter;(e<=t||-1===t)&&(t=e)}}if(this.TIMAEnabled&&1==(this.interruptEnabledFlags>>2&1)){const e=(256-this.memory[65285])*this.TACClocker-this.timerTicks;(e<=t||-1===t)&&(t=e)}this.serialTimer>0&&1==(this.interruptEnabledFlags>>3&1)&&(this.serialTimer<=t||-1===t)&&(t=this.serialTimer)}const e=this.cpu.cyclesTotal-this.cpu.ticks<<this.doubleSpeedShifter;t>=0?t<=e?(this.currentInstructionCycleCount=Math.max(t,this.currentInstructionCycleCount),this.updateCoreFull(),this.halt=!1,this.currentInstructionCycleCount=0):(this.currentInstructionCycleCount=Math.max(e,this.currentInstructionCycleCount),this.remainingClocks=t-this.currentInstructionCycleCount):this.currentInstructionCycleCount+=e}memoryHighRead(t){return this.memoryNew.hasHighReader(t)?this.memoryNew.readHigh(t):this.highMemoryReader[t].apply(this,[t])}writeMemory(t,e){return this.memoryNew.hasWriter(t)?this.memoryNew.write(t,e):this.memoryWriter[t].apply(this,[t,e])}memoryHighWrite(t,e){return this.memoryNew.hasHighWriter(t)?this.memoryNew.writeHigh(t,e):this.highMemoryWriter[t].apply(this,[t,e])}memoryWriteOAMRAM(t,e){this.modeSTAT<2&&this.memory[t]!==e&&(this.graphicsJIT(),this.memory[t]=e)}memoryWriteECHOGBCRAM(t,e){this.gbcMemory[t+this.gbcEchoRamBankPosition]=e}VRAMGBDATAWrite(t,e){this.modeSTAT<3&&this.memory[t]!==e&&(this.graphicsJIT(),this.memory[t]=e,this.generateGBOAMTileLine(t))}VRAMGBDATAUpperWrite(t,e){this.modeSTAT<3&&this.memory[t]!==e&&(this.graphicsJIT(),this.memory[t]=e,this.generateGBTileLine(t))}VRAMGBCDATAWrite(t,e){this.modeSTAT<3&&(0===this.currentVideoRamBank?this.memory[t]!==e&&(this.graphicsJIT(),this.memory[t]=e,this.generateGBCTileLineBank1(t)):(t&=8191,this.videoRam[t]!==e&&(this.graphicsJIT(),this.videoRam[t]=e,this.generateGBCTileLineBank2(t))))}VRAMGBCHRMAPWrite(t,e){this.modeSTAT<3&&(t&=2047,this.BGCHRBank1[t]!==e&&(this.graphicsJIT(),this.BGCHRBank1[t]=e))}VRAMGBCCHRMAPWrite(t,e){this.modeSTAT<3&&(t&=2047,this.BGCHRCurrentBank[t]!==e&&(this.graphicsJIT(),this.BGCHRCurrentBank[t]=e))}writeDirectlyToMemory(t){this.halt||(this.currentInstructionCycleCount+=4|t<<5<<this.doubleSpeedShifter);let e=this.memory[65361]<<8|this.memory[65362],i=this.memory[65363]<<8|this.memory[65364];this.graphicsJIT();const r=this.memory;if(0===this.currentVideoRamBank)do{i<6144?(r[32768|i]=this.readMemory(e++),r[32769|i]=this.readMemory(e++),r[32770|i]=this.readMemory(e++),r[32771|i]=this.readMemory(e++),r[32772|i]=this.readMemory(e++),r[32773|i]=this.readMemory(e++),r[32774|i]=this.readMemory(e++),r[32775|i]=this.readMemory(e++),r[32776|i]=this.readMemory(e++),r[32777|i]=this.readMemory(e++),r[32778|i]=this.readMemory(e++),r[32779|i]=this.readMemory(e++),r[32780|i]=this.readMemory(e++),r[32781|i]=this.readMemory(e++),r[32782|i]=this.readMemory(e++),r[32783|i]=this.readMemory(e++),this.generateGBCTileBank1(i),i+=16):(i&=2032,this.BGCHRBank1[i++]=this.readMemory(e++),this.BGCHRBank1[i++]=this.readMemory(e++),this.BGCHRBank1[i++]=this.readMemory(e++),this.BGCHRBank1[i++]=this.readMemory(e++),this.BGCHRBank1[i++]=this.readMemory(e++),this.BGCHRBank1[i++]=this.readMemory(e++),this.BGCHRBank1[i++]=this.readMemory(e++),this.BGCHRBank1[i++]=this.readMemory(e++),this.BGCHRBank1[i++]=this.readMemory(e++),this.BGCHRBank1[i++]=this.readMemory(e++),this.BGCHRBank1[i++]=this.readMemory(e++),this.BGCHRBank1[i++]=this.readMemory(e++),this.BGCHRBank1[i++]=this.readMemory(e++),this.BGCHRBank1[i++]=this.readMemory(e++),this.BGCHRBank1[i++]=this.readMemory(e++),this.BGCHRBank1[i++]=this.readMemory(e++),i=i+6144&8176),e&=65520,--t}while(t>0);else{var s=this.videoRam;do{i<6144?(s[i]=this.readMemory(e++),s[1|i]=this.readMemory(e++),s[2|i]=this.readMemory(e++),s[3|i]=this.readMemory(e++),s[4|i]=this.readMemory(e++),s[5|i]=this.readMemory(e++),s[6|i]=this.readMemory(e++),s[7|i]=this.readMemory(e++),s[8|i]=this.readMemory(e++),s[9|i]=this.readMemory(e++),s[10|i]=this.readMemory(e++),s[11|i]=this.readMemory(e++),s[12|i]=this.readMemory(e++),s[13|i]=this.readMemory(e++),s[14|i]=this.readMemory(e++),s[15|i]=this.readMemory(e++),this.generateGBCTileBank2(i),i+=16):(i&=2032,this.BGCHRBank2[i++]=this.readMemory(e++),this.BGCHRBank2[i++]=this.readMemory(e++),this.BGCHRBank2[i++]=this.readMemory(e++),this.BGCHRBank2[i++]=this.readMemory(e++),this.BGCHRBank2[i++]=this.readMemory(e++),this.BGCHRBank2[i++]=this.readMemory(e++),this.BGCHRBank2[i++]=this.readMemory(e++),this.BGCHRBank2[i++]=this.readMemory(e++),this.BGCHRBank2[i++]=this.readMemory(e++),this.BGCHRBank2[i++]=this.readMemory(e++),this.BGCHRBank2[i++]=this.readMemory(e++),this.BGCHRBank2[i++]=this.readMemory(e++),this.BGCHRBank2[i++]=this.readMemory(e++),this.BGCHRBank2[i++]=this.readMemory(e++),this.BGCHRBank2[i++]=this.readMemory(e++),this.BGCHRBank2[i++]=this.readMemory(e++),i=i+6144&8176),e&=65520,--t}while(t>0)}r[65361]=e>>8,r[65362]=240&e,r[65363]=i>>8,r[65364]=240&i}}const ct=mt;return e})()}));